<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portal - Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: white;
        }

        /* Контейнер для частиц */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(0, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: float 8s infinite linear;
        }

        .particle.small {
            width: 2px;
            height: 2px;
            box-shadow: 0 0 6px rgba(0, 255, 255, 0.8);
        }

        .particle.medium {
            width: 4px;
            height: 4px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        .particle.large {
            width: 6px;
            height: 6px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Геометрические фигуры */
        .geometric-shape {
            position: absolute;
            animation: geometricFloat 15s infinite ease-in-out;
            opacity: 0.1;
        }

        .geometric-shape.triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 26px solid rgba(0, 255, 255, 0.3);
        }

        .geometric-shape.square {
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
        }

        .geometric-shape.circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }

        @keyframes geometricFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
            }
            50% { 
                transform: translateY(-20px) rotate(180deg);
            }
        }

        /* Анимированный фон */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            animation: backgroundMove 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundMove {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-20px) translateY(-10px); }
            50% { transform: translateX(20px) translateY(10px); }
            75% { transform: translateX(-10px) translateY(20px); }
        }

        /* Заголовок с аватаром */
        .header {
            display: flex;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            margin-left: 15px;
            color: white;
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-id {
            font-size: 14px;
            opacity: 0.8;
        }

        .main-settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-panel-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: #8b4513;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .admin-panel-btn:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffc947 100%);
            border-color: rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }

        .language-selector {
            margin-left: 15px;
            position: relative;
        }

        .language-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .language-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .language-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 10px;
            padding: 10px 0;
            min-width: 150px;
            display: none;
            z-index: 9999;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .language-dropdown.show {
            display: block;
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-option {
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .language-option.active {
            background: rgba(102, 126, 234, 0.3);
        }

        /* Секция выбора языка в профиле */
        .language-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .language-section h3 {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .language-grid .language-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .language-grid .language-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .language-grid .language-option.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.6);
        }

        .language-grid .language-option span:first-child {
            font-size: 24px;
        }

        .language-grid .language-option span:last-child {
            font-size: 14px;
            font-weight: 500;
        }

        /* Модальное окно с данными пользователя */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            display: block;
        }

        /* Основной контент */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            position: relative;
            z-index: 10;
        }

        .title {
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            text-align: center;
            margin-bottom: 50px;
        }

        /* Новый дизайн главного меню */
        .main-ai-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 400px;
            width: 100%;
            margin-bottom: 30px;
        }

        .main-ai-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-ai-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .main-ai-card:active {
            transform: translateY(-2px);
        }

        .ai-card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .ai-card-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        /* Дополнительные функции */
        .additional-functions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 400px;
            width: 100%;
        }

        .function-button {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .function-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }

        .function-icon {
            font-size: 18px;
        }

        .function-text {
            white-space: nowrap;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.fade-out {
            opacity: 0;
            transform: translateX(400px);
        }

        /* Чат интерфейс */
        .chat-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .chat-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 2% auto;
            border-radius: 20px;
            width: 95%;
            height: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: chatSlideIn 0.3s ease-out;
        }

        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .chat-title::before {
            content: '🤖';
            margin-right: 10px;
            font-size: 28px;
        }

        .chat-close {
            color: white;
            font-size: 28px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-content {
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .typing-dots::after {
            content: '...';
            animation: typingDots 1.5s infinite;
        }

        @keyframes typingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .chat-input-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .send-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Скроллбар для чата */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Технологичный дизайн чата */
        .chat-container {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.2),
                inset 0 0 30px rgba(0, 255, 255, 0.1);
        }

        .chat-header {
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.05) 100%);
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-control-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .chat-control-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .connection-status {
            font-size: 12px;
            margin: 0 5px;
        }

        /* Стили для настроек */
        .settings-content {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
        }

        .settings-section h3 {
            color: #00ffff;
            margin: 0 0 15px 0;
            font-size: 16px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            color: #e0e0e0;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00ffff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .slider-container span {
            color: #00ffff;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .setting-item small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        /* Toggle switch */
        .toggle-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
            gap: 10px;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #00ffff;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(26px);
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Кнопки настроек */
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn.primary {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            border: 2px solid rgba(0, 255, 255, 0.4);
        }

        .settings-btn.primary:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
        }

        .settings-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .settings-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }


        .chat-title {
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            font-weight: 700;
        }

        .message {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
        }

        .message.user {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.4);
        }

        .message.ai {
            background: rgba(0, 255, 255, 0.05);
            border-color: rgba(0, 255, 255, 0.3);
        }

        .message-content {
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .chat-input {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #e0e0e0;
        }

        .chat-input:focus {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .chat-input::placeholder {
            color: rgba(224, 224, 224, 0.6);
        }

        .send-button {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.4);
            color: #00ffff;
        }

        .send-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .send-button.sending {
            animation: sendPulse 0.3s ease;
            transform: scale(0.95);
        }

        @keyframes sendPulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); box-shadow: 0 0 25px rgba(0, 255, 255, 0.8); }
            100% { transform: scale(0.95); }
        }

        .chat-input.typing {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.8);
        }

        /* Кнопка голосовых сообщений */
        .voice-button {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-right: 10px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .voice-button.recording {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.5);
            color: #ff0000;
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
        }

        .typing-indicator {
            color: rgba(0, 255, 255, 0.7);
            transition: all 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }

        /* Анимации загрузки - скелетоны */
        .skeleton {
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 25%, rgba(0, 255, 255, 0.2) 50%, rgba(0, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-message {
            height: 20px;
            margin: 5px 0;
            width: 80%;
        }

        .skeleton-message.short {
            width: 60%;
        }

        .skeleton-message.long {
            width: 90%;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: rgba(0, 255, 255, 0.7);
            border-radius: 50%;
            animation: loading-bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading-bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Улучшенный индикатор печати */
        .enhanced-typing {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            margin: 10px 0;
        }

        .typing-avatar {
            width: 30px;
            height: 30px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .ai-panel {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 24px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
        }

        .location-display {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .retry-location-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 6px;
            padding: 6px 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .retry-location-btn:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        /* Стили для разрешений */
        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .permission-item:last-child {
            border-bottom: none;
        }

        .permission-info {
            flex: 1;
        }

        .permission-title {
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .permission-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            line-height: 1.3;
        }

        /* Стили для модального окна погоды */
        .weather-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .weather-main {
            text-align: center;
        }

        .weather-location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .location-icon {
            font-size: 18px;
        }

        .location-text {
            color: white;
            font-weight: 500;
            font-size: 16px;
        }

        .weather-current {
            margin-bottom: 30px;
        }

        .weather-temp {
            font-size: 72px;
            font-weight: 300;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
        }

        .weather-desc {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .weather-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .weather-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .weather-value {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .weather-update {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
        }

        .weather-error, .weather-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .weather-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .weather-message {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .weather-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .weather-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .weather-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }




        /* Стили для админ панели */
        .admin-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-menu-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
        }

        .admin-menu-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .admin-menu-text {
            flex: 1;
        }

        .admin-menu-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .admin-menu-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .admin-menu-item.forbidden-settings {
            border-color: rgba(255, 69, 0, 0.3);
            background: rgba(255, 69, 0, 0.05);
        }

        .admin-menu-item.forbidden-settings:hover {
            border-color: rgba(255, 69, 0, 0.6);
            background: rgba(255, 69, 0, 0.1);
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.3);
        }

        .admin-menu-item.forbidden-settings .admin-menu-icon {
            background: rgba(255, 69, 0, 0.1);
            border-color: rgba(255, 69, 0, 0.3);
            color: #ff4500;
        }

        .admin-menu-item.powerful-settings {
            border-color: rgba(255, 0, 255, 0.3);
            background: rgba(255, 0, 255, 0.05);
        }

        .admin-menu-item.powerful-settings:hover {
            border-color: rgba(255, 0, 255, 0.6);
            background: rgba(255, 0, 255, 0.1);
            box-shadow: 0 8px 25px rgba(255, 0, 255, 0.3);
        }

        .admin-menu-item.powerful-settings .admin-menu-icon {
            background: rgba(255, 0, 255, 0.1);
            border-color: rgba(255, 0, 255, 0.3);
            color: #ff00ff;
        }

        /* Стили для настроек админ панели */
        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: white;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .settings-input:focus {
            outline: none;
            border-color: rgba(74, 144, 226, 0.6);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .settings-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .settings-textarea:focus {
            outline: none;
            border-color: rgba(74, 144, 226, 0.6);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .settings-slider {
            width: 100%;
            margin: 10px 0 15px 0;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .settings-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .settings-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .settings-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: white;
            cursor: pointer;
        }

        .settings-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #4a90e2;
        }

        .settings-btn {
            background: rgba(74, 144, 226, 0.8);
            border: 1px solid rgba(74, 144, 226, 0.6);
            border-radius: 8px;
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(74, 144, 226, 1);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .settings-btn.primary {
            background: rgba(46, 204, 113, 0.8);
            border-color: rgba(46, 204, 113, 0.6);
        }

        .settings-btn.primary:hover {
            background: rgba(46, 204, 113, 1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .settings-btn.secondary {
            background: rgba(149, 165, 166, 0.8);
            border-color: rgba(149, 165, 166, 0.6);
        }

        .settings-btn.secondary:hover {
            background: rgba(149, 165, 166, 1);
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
        }

        .settings-btn.danger {
            background: rgba(231, 76, 60, 0.8);
            border-color: rgba(231, 76, 60, 0.6);
        }

        .settings-btn.danger:hover {
            background: rgba(231, 76, 60, 1);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .settings-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        /* Стили для модального окна политики конфиденциальности */
        .privacy-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .privacy-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .privacy-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .privacy-header h2 {
            color: white;
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .privacy-header p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            font-size: 16px;
        }

        .privacy-content {
            color: white;
        }

        .privacy-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .privacy-summary h3 {
            color: white;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .privacy-summary ul {
            margin: 0;
            padding-left: 20px;
        }

        .privacy-summary li {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .privacy-actions {
            text-align: center;
        }

        .privacy-checkbox {
            margin-bottom: 20px;
        }

        .privacy-checkbox label {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
            gap: 10px;
        }

        .privacy-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
        }

        .privacy-link {
            color: #81C784;
            text-decoration: underline;
            font-weight: 600;
        }

        .privacy-link:hover {
            color: #A5D6A7;
        }

        .privacy-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .privacy-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .privacy-btn.decline {
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: 2px solid rgba(244, 67, 54, 0.6);
        }

        .privacy-btn.decline:hover {
            background: rgba(244, 67, 54, 1);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .privacy-btn.accept {
            background: rgba(76, 175, 80, 0.8);
            color: white;
            border: 2px solid rgba(76, 175, 80, 0.6);
        }

        .privacy-btn.accept:hover:not(:disabled) {
            background: rgba(76, 175, 80, 1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .privacy-btn.accept:disabled {
            background: rgba(158, 158, 158, 0.5);
            border-color: rgba(158, 158, 158, 0.3);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .privacy-container {
                padding: 20px;
                margin: 10px;
            }
            
            .privacy-buttons {
                flex-direction: column;
            }
            
            .privacy-btn {
                width: 100%;
            }
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.4);
        }

        /* Стили для управления пользователями */
        .users-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }




        /* Все CSS стили управления пользователями удалены */


        /* Все CSS стили управления пользователями удалены */

        /* Стили для модального окна статьи */
        .article-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .article-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .article-source {
            background: rgba(0, 255, 255, 0.2);
            color: rgba(0, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .article-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .article-category {
            background: rgba(255, 215, 0, 0.2);
            color: rgba(255, 215, 0, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .article-main-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 15px;
        }

        .article-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .article-description {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .article-body {
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 25px;
        }

        .article-actions {
            display: flex;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .article-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .article-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .article-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .article-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .article-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .article-error {
            text-align: center;
            padding: 40px 20px;
        }

        .article-error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .article-error-message {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .article-error-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Селектор режимов ИИ */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .mode-option {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .mode-option.active {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .mode-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .mode-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mode-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            line-height: 1.3;
        }

        /* Стили для кнопки прикрепления */
        .attach-button {
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid rgba(0, 255, 255, 0.4);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .attach-button:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .attach-button:active {
            transform: scale(0.95);
        }

        /* Панель прикрепления */
        .attach-menu {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: rgba(15, 15, 35, 0.95);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attach-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .attach-option:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .attach-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .attach-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* Стили для файловых сообщений */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            max-width: 300px;
        }

        .file-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            color: white;
            font-weight: 500;
            font-size: 14px;
            word-break: break-word;
            margin-bottom: 4px;
        }

        .file-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        /* Стили экрана входа */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
        }

        .login-container {
            text-align: center;
            z-index: 2;
            max-width: 500px;
            padding: 40px;
        }

        .login-logo {
            margin-bottom: 40px;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        .logo-text {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00d4ff, #0099cc, #0066ff, #00d4ff);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            letter-spacing: 8px;
        }

        .logo-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .login-description {
            margin: 40px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .login-description p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 10px 0;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .enter-button {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #0066ff 100%);
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            animation: buttonPulse 2s ease-in-out infinite;
        }

        .enter-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.5);
        }

        .enter-button:active {
            transform: translateY(-1px);
        }

        .enter-text {
            position: relative;
            z-index: 2;
        }

        .enter-glow {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: buttonGlow 3s infinite;
        }

        .login-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .login-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00d4ff;
            border-radius: 50%;
            opacity: 0.7;
            animation: particleFloat 6s infinite linear;
            box-shadow: 0 0 10px #00d4ff;
        }

        .status-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .status-icon {
            font-size: 1.2rem;
            margin-right: 15px;
            min-width: 25px;
        }

        .status-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .status-item.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-item.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-item.loading .status-icon {
            animation: spin 1s linear infinite;
        }

        /* Анимации */
        @keyframes logoGlow {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            }
            50% {
                box-shadow: 0 15px 40px rgba(0, 212, 255, 0.6);
            }
        }

        @keyframes buttonGlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            .login-container {
                padding: 20px;
            }
            
            .logo-text {
                font-size: 3rem;
                letter-spacing: 4px;
            }
            
            .logo-subtitle {
                font-size: 1rem;
                letter-spacing: 2px;
            }
            
            .login-description p {
                font-size: 1rem;
            }
            
            .enter-button {
                padding: 15px 30px;
                font-size: 1.1rem;
            }
        }

        /* Стили для управления пользователями */
        .users-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .users-search {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .clear-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .clear-search-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .users-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 255, 255, 0.1);
            font-size: 24px;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-name {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 16px;
        }

        .user-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #888;
        }

        .user-id {
            color: #00ffff;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-active {
            color: #4CAF50;
        }

        .status-banned {
            color: #f44336;
        }

        .status-offline {
            color: #888;
        }

        /* Детали пользователя */
        .user-details-content {
            padding: 20px;
        }

        .user-info-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(0, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 255, 255, 0.1);
            font-size: 36px;
            flex-shrink: 0;
        }

        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-fallback {
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .user-info-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .user-detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: bold;
            color: #888;
            font-size: 14px;
        }

        .detail-value {
            color: #e0e0e0;
            font-size: 14px;
        }

        .user-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            border: 2px solid rgba(0, 255, 255, 0.4);
        }

        .action-btn.primary:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Заголовок с кнопками */
        .chat-header-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
        }

        /* Анимация загрузки для кнопки обновления */
        .header-btn.loading {
            animation: spin 1s linear infinite;
        }

        /* Пустой список */
        .empty-list {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-list-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-list-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .empty-list-desc {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .user-info-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .user-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .users-stats {
                flex-direction: column;
                gap: 10px;
            }

            .stat-item {
                flex-direction: row;
                justify-content: space-between;
            }
        }

    </style>
    
    <!-- Подключение к базе данных -->
    <script src="database.js"></script>
    <script src="cache.js"></script>
</head>
<body>
    <!-- Экран входа -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-text">AI-TAP</div>
                <div class="logo-subtitle">Искусственный интеллект</div>
            </div>
            
            <div class="login-description">
                <p>Добро пожаловать в мир искусственного интеллекта!</p>
                <p>Общайтесь с ИИ, получайте новости и прогноз погоды</p>
            </div>
            
            <button id="enterButton" class="enter-button" onclick="handleEnterApp()">
                <span class="enter-text">🚀 Войти в приложение</span>
                <div class="enter-glow"></div>
            </button>
            
            <!-- Статус проверки -->
            <div id="statusContainer" class="status-container" style="display: none;">
                <div class="status-item" id="databaseStatus">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Проверка базы данных...</span>
                </div>
                <div class="status-item" id="appStatus">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Проверка веб-приложения...</span>
                </div>
            </div>
        </div>
        
        <div class="login-particles" id="loginParticles"></div>
    </div>

    <!-- Основное приложение (скрыто при загрузке) -->
    <div id="mainApp" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">
        <!-- Анимированный фон с частицами -->
        <div class="particles-container" id="particlesContainer"></div>
        
        <!-- Геометрические фигуры -->
        <div class="geometric-shape triangle" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
        <div class="geometric-shape square" style="top: 20%; right: 15%; animation-delay: 2s;"></div>
        <div class="geometric-shape circle" style="bottom: 30%; left: 20%; animation-delay: 4s;"></div>
        <div class="geometric-shape triangle" style="bottom: 10%; right: 10%; animation-delay: 6s;"></div>
        <div class="geometric-shape square" style="top: 60%; left: 80%; animation-delay: 8s;"></div>
        <div class="geometric-shape circle" style="top: 80%; right: 70%; animation-delay: 10s;"></div>

    <!-- Заголовок с аватаром -->
    <div class="header">
        <img id="userAvatar" class="user-avatar" src="" alt="Avatar" onclick="showUserInfo()">
        <div class="user-info">
            <div id="userName" class="user-name">Загрузка...</div>
            <div id="userId" class="user-id">ID: ...</div>
        </div>
        <div class="header-buttons">
            <button id="adminPanelBtn" class="admin-panel-btn" onclick="openAdminPanel()" title="Админ панель" style="display: none;">👑</button>
            <button class="main-settings-btn" onclick="openMainSettings()" title="Настройки приложения">⚙️</button>
        </div>
    </div>

    <!-- Модальное окно с данными пользователя -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserInfo()">&times;</span>
            <img id="modalAvatar" class="modal-avatar" src="" alt="Avatar">
            <h2 id="modalName">Имя пользователя</h2>
            <p id="modalId">ID: ...</p>
            <p id="modalUsername">@username</p>
            
            <div class="language-section">
                <h3>Выбор языка / Language Selection</h3>
                <div class="language-grid">
                    <div class="language-option active" onclick="changeLanguage('ru')">
                        <span>🇷🇺</span>
                        <span>Русский</span>
                    </div>
                    <div class="language-option" onclick="changeLanguage('en')">
                        <span>🇺🇸</span>
                        <span>English</span>
                    </div>
                    <div class="language-option" onclick="changeLanguage('de')">
                        <span>🇩🇪</span>
                        <span>Deutsch</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
        <h1 class="title">AI-TAP</h1>
        <p class="subtitle">Выберите ИИ для ваших задач</p>
        
        <!-- Основные функции ИИ -->
        <div class="main-ai-grid">
            <div class="main-ai-card" onclick="openMainAI()">
                <div class="ai-card-icon">🤖</div>
                <div class="ai-card-title">Основной ИИ</div>
            </div>
            <div class="main-ai-card" onclick="showNotification(t('imageGenNotification'))">
                <div class="ai-card-icon">🎨</div>
                <div class="ai-card-title">Генератор изображений</div>
            </div>
        </div>

        <!-- Дополнительные функции -->
        <div class="additional-functions">
            <div class="function-button" onclick="showWeather()">
                <span class="function-icon">🌤️</span>
                <span class="function-text">Погода</span>
            </div>
        </div>
    </div>

    <!-- Чат с Основным ИИ -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">Основной ИИ</div>
                <div class="chat-controls">
                    <button class="chat-control-btn" onclick="clearChatHistory()" title="Очистить историю">🗑️</button>
                    <button class="chat-control-btn" onclick="toggleAISettings()" title="Настройки ИИ">⚙️</button>
                    <span class="connection-status" id="connectionStatus" title="Статус подключения">🟢</span>
                    <span class="chat-close" onclick="closeChat()">&times;</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Привет! Я Основной ИИ. К сожалению, я пока в разработке, но скоро буду готов помочь!
                    </div>
                    <div class="message-time" id="welcomeTime"></div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="enhanced-typing">
                    <div class="typing-avatar">🤖</div>
                    <div>
                        <span id="typingText">ИИ печатает</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Напишите сообщение..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button" onclick="sendMessage()">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Модальное окно настроек -->
    <div id="settingsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">⚙️ Настройки ИИ</div>
                <span class="chat-close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="settings-section">
                    <h3>🤖 Параметры ИИ</h3>
                    <div class="setting-item">
                        <label>Режим ответов:</label>
                        <div class="mode-selector">
                            <div class="mode-option" data-mode="precise" onclick="selectMode('precise')">
                                <div class="mode-icon">🎯</div>
                                <div class="mode-name">Точный</div>
                                <div class="mode-desc">Краткие и точные ответы</div>
                            </div>
                            <div class="mode-option active" data-mode="smart" onclick="selectMode('smart')">
                                <div class="mode-icon">🧠</div>
                                <div class="mode-name">Умный</div>
                                <div class="mode-desc">Сбалансированные ответы</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔊 Звуковые эффекты</h3>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="toggle-slider"></span>
                            Включить звуки
                        </label>
                        <small>Звуки отправки и получения сообщений</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>📊 Статистика</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="statMessages">0</div>
                            <div class="stat-label">Сообщений</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="statDays">0</div>
                            <div class="stat-label">Дней общения</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="statFacts">0</div>
                            <div class="stat-label">Фактов запомнено</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveSettings()">💾 Сохранить</button>
                    <button class="settings-btn secondary" onclick="resetSettings()">🔄 Сбросить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Главные настройки приложения -->
    <div id="mainSettingsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">⚙️ Настройки приложения</div>
                <span class="chat-close" onclick="closeMainSettings()">&times;</span>
            </div>
            <div class="settings-content" id="mainSettingsContent">
                <div class="settings-section">
                    <h3>📍 Геолокация</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Местоположение</div>
                            <div class="permission-desc">Для показа погоды и локальной информации</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="mainLocationToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" id="mainLocationInfo" style="display: none;">
                        <div class="location-display">
                            <span id="mainCurrentLocation">Местоположение не определено</span>
                            <button class="retry-location-btn" onclick="retryLocation()" title="Обновить местоположение">🔄</button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>📱 Мультимедиа</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Камера</div>
                            <div class="permission-desc">Для отправки фото и видео</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="cameraToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Микрофон</div>
                            <div class="permission-desc">Для голосовых сообщений</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="microphoneToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Файлы</div>
                            <div class="permission-desc">Для отправки документов и медиа</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="filesToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔊 Звуковые эффекты</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Звуки уведомлений</div>
                            <div class="permission-desc">Звуки отправки и получения сообщений</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="mainSoundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveMainSettings()">💾 Сохранить</button>
                    <button class="settings-btn secondary" onclick="resetMainSettings()">🔄 Сбросить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно погоды -->
    <div id="weatherModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">🌤️ Погода</div>
                <span class="chat-close" onclick="closeWeatherModal()">&times;</span>
            </div>
            <div id="weatherContent" class="weather-content">
                <!-- Контент загружается динамически -->
            </div>
        </div>
    </div>

    <!-- Админ панель -->
    <div id="adminModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">👑 Админ панель</div>
                <span class="chat-close" onclick="closeAdminPanel()">&times;</span>
            </div>
            <div id="adminContent" class="admin-content">
                <div class="admin-menu">
                    <div class="admin-menu-item" onclick="openUsersManagement()">
                        <div class="admin-menu-icon">👥</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Пользователи</div>
                            <div class="admin-menu-desc">Управление пользователями и их правами</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openAISettings()">
                        <div class="admin-menu-icon">🤖</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки ИИ</div>
                            <div class="admin-menu-desc">Конфигурация ИИ моделей и параметров</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openWebAppSettings()">
                        <div class="admin-menu-icon">⚙️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки веб-приложения</div>
                            <div class="admin-menu-desc">Основные настройки приложения</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openCreatorSettings()">
                        <div class="admin-menu-icon">👨‍💻</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки создателя</div>
                            <div class="admin-menu-desc">Расширенные настройки разработчика</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item forbidden-settings" onclick="openForbiddenSettings()">
                        <div class="admin-menu-icon">🚫</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Запрещенные настройки</div>
                            <div class="admin-menu-desc">Экспериментальные и рискованные функции</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item powerful-settings" onclick="openPowerfulSettings()">
                        <div class="admin-menu-icon">⚡</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Мощные настройки</div>
                            <div class="admin-menu-desc">Критически важные системные настройки</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openDatabaseSettings()">
                        <div class="admin-menu-icon">🗄️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки базы данных</div>
                            <div class="admin-menu-desc">Управление базой данных и кэшем</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openWeatherSettings()">
                        <div class="admin-menu-icon">🌤️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки погоды</div>
                            <div class="admin-menu-desc">Конфигурация погодных API и данных</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openGeneralInfo()">
                        <div class="admin-menu-icon">📊</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Общая информация</div>
                            <div class="admin-menu-desc">Статистика и информация о системе</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления пользователями -->
    <div id="usersModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">👥 Управление пользователями</div>
                <div class="chat-header-buttons">
                    <button class="header-btn" onclick="refreshUsersList()" title="Обновить список">
                        <span id="refreshUsersIcon">🔄</span>
                    </button>
                    <span class="chat-close" onclick="closeUsersModal()">&times;</span>
                </div>
            </div>
            <div id="usersContent" class="users-content">
                <div class="users-search">
                    <input type="text" id="usersSearchInput" placeholder="🔍 Поиск пользователей..." 
                           onkeyup="searchUsers()" class="search-input">
                    <button class="clear-search-btn" onclick="clearUsersSearch()" style="display: none;">✕</button>
                </div>
                <div id="usersStats" class="users-stats">
                    <div class="stat-item">
                        <span class="stat-label">Всего пользователей:</span>
                        <span id="totalUsersCount" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Активных сегодня:</span>
                        <span id="activeUsersCount" class="stat-value">0</span>
                    </div>
                </div>
                <div id="usersList" class="users-list">
                    <!-- Список пользователей загружается динамически -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно деталей пользователя -->
    <div id="userDetailsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title" id="userDetailsTitle">👤 Пользователь</div>
                <div class="chat-header-buttons">
                    <button class="header-btn" onclick="backToUsersList()" title="Назад к списку">
                        ←
                    </button>
                    <span class="chat-close" onclick="closeUserDetailsModal()">&times;</span>
                </div>
            </div>
            <div id="userDetailsContent" class="user-details-content">
                <div class="user-info-section">
                    <div class="user-avatar-large">
                        <img id="userDetailsAvatar" src="" alt="Avatar" onerror="this.style.display='none'">
                        <div id="userDetailsAvatarFallback" class="avatar-fallback">👤</div>
                    </div>
                    <div class="user-info-details">
                        <div class="user-detail-item">
                            <span class="detail-label">ID:</span>
                            <span id="userDetailsId" class="detail-value">-</span>
                        </div>
                        <div class="user-detail-item">
                            <span class="detail-label">Имя:</span>
                            <span id="userDetailsName" class="detail-value">-</span>
                        </div>
                        <div class="user-detail-item">
                            <span class="detail-label">Username:</span>
                            <span id="userDetailsUsername" class="detail-value">-</span>
                        </div>
                        <div class="user-detail-item">
                            <span class="detail-label">Последний визит:</span>
                            <span id="userDetailsLastSeen" class="detail-value">-</span>
                        </div>
                        <div class="user-detail-item">
                            <span class="detail-label">Статус:</span>
                            <span id="userDetailsStatus" class="detail-value status-active">Активен</span>
                        </div>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="action-btn primary" onclick="viewUserChat()">
                        💬 Просмотреть чат
                    </button>
                    <button class="action-btn secondary" onclick="openBanModal()">
                        🚫 Заблокировать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра чата пользователя -->
    <div id="userChatModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title" id="userChatTitle">💬 Чат пользователя</div>
                <div class="chat-header-buttons">
                    <button class="header-btn" onclick="backToUserDetails()" title="Назад к пользователю">
                        ←
                    </button>
                    <span class="chat-close" onclick="closeUserChatModal()">&times;</span>
                </div>
            </div>
            <div id="userChatContent" class="chat-messages" style="max-height: 500px; overflow-y: auto;">
                <!-- Сообщения чата загружаются динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно политики конфиденциальности -->
    <div id="privacyModal" class="privacy-modal" style="display: none;">
        <div class="privacy-container">
            <div class="privacy-header">
                <h2>🔒 Privacy Policy Agreement</h2>
                <p>Please review and accept our Privacy Policy to continue using AI-TAP</p>
            </div>
            <div class="privacy-content">
                <div class="privacy-summary">
                    <h3>📋 What we collect:</h3>
                    <ul>
                        <li>Telegram user data (ID, username, name, photo)</li>
                        <li>Your messages and AI interactions</li>
                        <li>Location data (with your permission)</li>
                        <li>Usage statistics and preferences</li>
                    </ul>
                    
                    <h3>🎯 How we use it:</h3>
                    <ul>
                        <li>Provide AI services and personalization</li>
                        <li>Improve application performance</li>
                        <li>Ensure security and compliance</li>
                    </ul>
                    
                    <h3>🛡️ Your rights:</h3>
                    <ul>
                        <li>Access, correct, or delete your data</li>
                        <li>Withdraw consent at any time</li>
                        <li>Data portability and restriction</li>
                    </ul>
                </div>
                
                <div class="privacy-actions">
                    <div class="privacy-checkbox">
                        <label>
                            <input type="checkbox" id="privacyAccept">
                            I have read and accept the 
                            <a href="privacy-policy.html" target="_blank" class="privacy-link">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <div class="privacy-buttons">
                        <button id="privacyDecline" class="privacy-btn decline">Decline</button>
                        <button id="privacyAcceptBtn" class="privacy-btn accept" disabled>Accept & Continue</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification"></div>

    <script>
        // Система переводов
        const translations = {
            ru: {
                loading: 'Загрузка...',
                userId: 'ID: ...',
                welcome: 'Добро пожаловать!',
                aiPortal: 'AI-TAP',
                selectAi: 'Выберите ИИ для ваших задач',
                mainAi: 'Основной ИИ',
                mainDescription: 'Универсальный помощник для любых задач',
                imageGen: 'Генератор изображений',
                imageDescription: 'Создание уникальных изображений по описанию',
                inDevelopment: 'в разработке',
                mainAiNotification: 'Основной ИИ - в разработке',
                imageGenNotification: 'Генератор изображений - в разработке',
                chatWelcome: 'Привет! Я Основной ИИ. К сожалению, я пока в разработке, но скоро буду готов помочь!',
                chatPlaceholder: 'Напишите сообщение...',
                chatTyping: 'ИИ печатает',
                chatResponse: 'Извините, я пока в разработке. Скоро буду готов помочь вам!',
                chatTitle: 'ИИ Ассистент',
                chatWelcome: 'Привет! Я ваш ИИ ассистент. Чем могу помочь?',
                typing: 'ИИ печатает',
                placeholder: 'Напишите сообщение...',
                error: 'Извините, произошла ошибка при обработке вашего сообщения. Попробуйте еще раз.',
                close: 'Закрыть'
            },
            en: {
                loading: 'Loading...',
                userId: 'ID: ...',
                welcome: 'Welcome!',
                aiPortal: 'AI-TAP',
                selectAi: 'Choose AI for your tasks',
                mainAi: 'Main AI',
                mainDescription: 'Universal assistant for any tasks',
                imageGen: 'Image Generator',
                imageDescription: 'Creating unique images from descriptions',
                inDevelopment: 'in development',
                mainAiNotification: 'Main AI - in development',
                imageGenNotification: 'Image Generator - in development',
                chatWelcome: 'Hello! I am Main AI. Unfortunately, I am still in development, but I will be ready to help soon!',
                chatPlaceholder: 'Write a message...',
                chatTyping: 'AI is typing',
                chatResponse: 'Sorry, I am still in development. I will be ready to help you soon!',
                chatTitle: 'AI Assistant',
                chatWelcome: 'Hello! I am your AI assistant. How can I help?',
                typing: 'AI is typing',
                placeholder: 'Write a message...',
                error: 'Sorry, an error occurred while processing your message. Please try again.',
                close: 'Close'
            },
            de: {
                loading: 'Laden...',
                userId: 'ID: ...',
                welcome: 'Willkommen!',
                aiPortal: 'KI Portal',
                selectAi: 'Wählen Sie KI für Ihre Aufgaben',
                mainAi: 'Haupt-KI',
                mainDescription: 'Universeller Assistent für alle Aufgaben',
                imageGen: 'Bildgenerator',
                imageDescription: 'Erstellung einzigartiger Bilder aus Beschreibungen',
                inDevelopment: 'in Entwicklung',
                mainAiNotification: 'Haupt-KI - in Entwicklung',
                imageGenNotification: 'Bildgenerator - in Entwicklung',
                chatWelcome: 'Hallo! Ich bin Haupt-KI. Leider bin ich noch in Entwicklung, aber ich werde bald bereit sein zu helfen!',
                chatPlaceholder: 'Nachricht schreiben...',
                chatTyping: 'KI tippt',
                chatResponse: 'Entschuldigung, ich bin noch in Entwicklung. Ich werde bald bereit sein, Ihnen zu helfen!',
                chatTitle: 'KI Assistent',
                chatWelcome: 'Hallo! Ich bin Ihr KI-Assistent. Wie kann ich helfen?',
                typing: 'KI tippt',
                placeholder: 'Nachricht schreiben...',
                error: 'Entschuldigung, ein Fehler ist beim Verarbeiten Ihrer Nachricht aufgetreten. Versuchen Sie es erneut.',
                close: 'Schließen'
            }
        };

        // Текущий язык
        let currentLanguage = localStorage.getItem('ai-tap-language') || 'ru';
        
        // Конфигурация Groq AI API
        const GROQ_API_KEY = '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';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        
        // Память для чата
        let chatHistory = JSON.parse(localStorage.getItem('ai-tap-chat-history') || '[]');
        
        // Звуковые уведомления
        const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
        
        // Оптимизированный звук получения сообщения
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Убеждаемся что контекст активен
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Более приятный звук уведомления
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator.frequency.setValueAtTime(1108, audioContext.currentTime + 0.1); // C#6
                oscillator.frequency.setValueAtTime(1319, audioContext.currentTime + 0.2); // E6
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
                
            } catch (error) {
                console.log('Звук недоступен:', error);
            }
        }


        // Оптимизированный звук отправки сообщения
        function playSendSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Убеждаемся что контекст активен
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Визуальный эффект для кнопки отправки
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.classList.add('sending');
                    setTimeout(() => {
                        sendButton.classList.remove('sending');
                    }, 300);
                }
                
                // Простой и надежный звук отправки
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
                oscillator.frequency.linearRampToValueAtTime(784, audioContext.currentTime + 0.1); // G5
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
            } catch (error) {
                console.log('Звук отправки недоступен:', error);
            }
        }

        // Виброотклик для мобильных устройств
        function triggerVibration() {
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]); // Короткий-пауза-короткий
            }
        }

        // Полноэкранный режим
        function enableFullscreen() {
            // Скрываем адресную строку на мобильных
            if (window.innerHeight < window.innerWidth) return; // Не для ландшафта
            
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
            
            // Добавляем мета-тег для полноэкранного режима
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
            }
        }

        // Оптимизация клавиатуры
        function optimizeKeyboard() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            
            // Автофокус при открытии чата на мобильных
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    chatInput.focus();
                    // Прокручиваем к полю ввода
                    chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
            
            // Обработка появления/скрытия клавиатуры
            let initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            
            function handleViewportChange() {
                if (!window.visualViewport) return;
                
                const currentHeight = window.visualViewport.height;
                const heightDifference = initialViewportHeight - currentHeight;
                
                // Если клавиатура открыта (высота уменьшилась значительно)
                if (heightDifference > 150) {
                    document.body.style.paddingBottom = heightDifference + 'px';
                    // Прокручиваем к полю ввода
                    setTimeout(() => {
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 100);
                } else {
                    document.body.style.paddingBottom = '0px';
                }
            }
            
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', handleViewportChange);
            }
        }

        // Функция получения перевода
        function t(key) {
            return translations[currentLanguage][key] || translations['ru'][key] || key;
        }

        // Функция обновления интерфейса
        function updateInterface() {
            // НЕ обновляем данные пользователя, только интерфейс
            document.querySelector('.title').textContent = t('aiPortal');
            document.querySelector('.subtitle').textContent = t('selectAi');
            
            // Обновляем кнопки AI
            const buttons = document.querySelectorAll('.ai-button');
            const titles = [t('mainAi'), t('imageGen')];
            const descriptions = [t('mainDescription'), t('imageDescription')];
            
            buttons.forEach((button, index) => {
                button.querySelector('.ai-title').textContent = titles[index];
                button.querySelector('.ai-description').textContent = descriptions[index];
            });
        }

        // Функции для работы с языками
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('ai-tap-language', lang);
            updateInterface();
            
            // Обновляем активную опцию в профиле
            document.querySelectorAll('.language-grid .language-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.language-option').classList.add('active');
            
            // Показываем уведомление об изменении языка
            showNotification(`Язык изменен на ${getLanguageName(lang)}`);
        }

        function getLanguageName(lang) {
            const names = {'ru': 'Русский', 'en': 'English', 'es': 'Español', 'fr': 'Français', 'de': 'Deutsch', 'zh': '中文'};
            return names[lang] || 'Русский';
        }

        // Инициализация Telegram Web App (перенесено в админ систему)
        // const tg = window.Telegram.WebApp;
        // tg.ready();
        
        // Инициализация интерфейса при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Обновляем интерфейс на сохраненном языке
            updateInterface();
            
            // Восстанавливаем активный язык в профиле
            document.querySelectorAll('.language-grid .language-option').forEach(option => {
                option.classList.remove('active');
                if (option.onclick.toString().includes(`'${currentLanguage}'`)) {
                    option.classList.add('active');
                }
            });
        });

        // Инициализация пользователя перенесена в админ систему

        // Функции для работы с модальным окном
        function showUserInfo() {
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserInfo() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            const chatModal = document.getElementById('chatModal');
            const settingsModal = document.getElementById('settingsModal');
            const mainSettingsModal = document.getElementById('mainSettingsModal');
            const weatherModal = document.getElementById('weatherModal');
            const adminModal = document.getElementById('adminModal');
            const usersModal = document.getElementById('usersModal');
            const userDetailsModal = document.getElementById('userDetailsModal');
            const userChatModal = document.getElementById('userChatModal');
            
            if (event.target === userModal) {
                userModal.style.display = 'none';
            }
            if (event.target === chatModal) {
                chatModal.style.display = 'none';
            }
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target === mainSettingsModal) {
                mainSettingsModal.style.display = 'none';
            }
            if (event.target === weatherModal) {
                weatherModal.style.display = 'none';
            }
            if (event.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (event.target === usersModal) {
                usersModal.style.display = 'none';
            }
            if (event.target === userDetailsModal) {
                userDetailsModal.style.display = 'none';
            }
            if (event.target === userChatModal) {
                userChatModal.style.display = 'none';
            }
        }

        // Функция показа уведомлений
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('fade-out');
            notification.classList.add('show');
            
            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('fade-out');
                
                // Полное удаление после анимации
                setTimeout(() => {
                    notification.classList.remove('fade-out');
                    notification.textContent = '';
                }, 300);
            }, 3000);
        }

        // Функции для чата с Основным ИИ
        function openMainAI() {
            document.getElementById('chatModal').style.display = 'block';
            
            // Восстанавливаем чат из истории
            restoreChatHistory();
            
            // Обновляем интерфейс чата на текущем языке
            updateChatInterface();
            
            // Обновляем кнопку геолокации
            updateLocationButton();
            
            // Мобильные оптимизации
            enableFullscreen();
            optimizeKeyboard();
            
            // Виброотклик при открытии
            triggerVibration();
            
            // Проверяем актуальность погоды и местоположения
            checkLocationUpdate();
            checkWeatherUpdate();
        }
        
        // Функция восстановления истории чата
        function restoreChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatHistory.length === 0) {
                // Если истории нет, показываем приветствие
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            ${t('chatWelcome')}
                        </div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
            } else {
                // Восстанавливаем всю историю чата
                chatMessages.innerHTML = '';
                
                chatHistory.forEach((msg, index) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
                    
                    // Используем сохраненное время или текущее
                    const messageTime = msg.timestamp || getCurrentTime();
                    
                    messageDiv.innerHTML = `
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${messageTime}</div>
                    `;
                    
                    chatMessages.appendChild(messageDiv);
                });
                
                // Прокручиваем к последнему сообщению
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function closeChat() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function updateChatInterface() {
            try {
                // Обновляем заголовок
                const chatTitle = document.querySelector('.chat-title');
                if (chatTitle) chatTitle.textContent = t('mainAi');
                
                // Обновляем приветственное сообщение
                const welcomeMessage = document.querySelector('.chat-messages .message.ai .message-content');
                if (welcomeMessage) {
                    welcomeMessage.textContent = t('chatWelcome');
                }
                
                // Обновляем плейсхолдер
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.placeholder = t('chatPlaceholder');
                
                // Обновляем индикатор печати
                const typingText = document.getElementById('typingText');
                if (typingText) typingText.textContent = t('chatTyping');
                
                // Устанавливаем время приветственного сообщения
                const welcomeTime = document.getElementById('welcomeTime');
                if (welcomeTime) welcomeTime.textContent = getCurrentTime();
                
            } catch (error) {
                console.error('Ошибка обновления интерфейса чата:', error);
            }
        }

        // Функция очистки истории чата
        function clearChatHistory() {
            if (confirm('Вы уверены, что хотите очистить всю историю чата?')) {
                chatHistory = [];
                localStorage.removeItem('ai-tap-chat-history');
                
                // Очищаем интерфейс чата
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            ${t('chatWelcome')}
                        </div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
                
                showNotification('История чата очищена');
                playNotificationSound();
            }
        }

        // Настройки ИИ
        let aiSettings = JSON.parse(localStorage.getItem('ai-tap-settings') || '{"mode": "smart", "maxTokens": 300}');
        
        // Память персонажа ИИ
        let aiMemory = JSON.parse(localStorage.getItem('ai-tap-memory') || '{}');
        
        // Геолокация
        let userLocation = JSON.parse(localStorage.getItem('ai-tap-location') || 'null');
        let locationEnabled = localStorage.getItem('ai-tap-location-enabled') === 'true';
        
        // Погода и контекстные данные
        let currentWeather = null;
        let lastWeatherUpdate = null;
        
        // Новости и их кэширование
        let cachedNews = JSON.parse(localStorage.getItem('ai-tap-cached-news') || 'null');
        let lastNewsUpdate = localStorage.getItem('ai-tap-last-news-update') ? new Date(localStorage.getItem('ai-tap-last-news-update')) : null;
        
        // Неиспользуемые переменные удалены
        
        
        // Инициализация памяти ИИ
        if (!aiMemory.userPreferences) {
            aiMemory = {
                userPreferences: {},
                conversationStyle: 'friendly',
                rememberedFacts: [],
                interactionCount: 0,
                lastInteraction: null,
                favoriteTopics: [],
                userMood: 'neutral'
            };
        }
        
        function updateAIMemory(key, value) {
            aiMemory[key] = value;
            localStorage.setItem('ai-tap-memory', JSON.stringify(aiMemory));
        }
        
        function addRememberedFact(fact) {
            if (!aiMemory.rememberedFacts.includes(fact)) {
                aiMemory.rememberedFacts.push(fact);
                if (aiMemory.rememberedFacts.length > 20) {
                    aiMemory.rememberedFacts.shift(); // Ограничиваем до 20 фактов
                }
                updateAIMemory('rememberedFacts', aiMemory.rememberedFacts);
            }
        }
        
        function getPersonalizedSystemPrompt() {
            const language = currentLanguage === 'ru' ? 'русском' : currentLanguage === 'en' ? 'английском' : currentLanguage === 'es' ? 'испанском' : currentLanguage === 'fr' ? 'французском' : currentLanguage === 'de' ? 'немецком' : currentLanguage === 'zh' ? 'китайском' : 'русском';
            
            let prompt = `Ты полезный AI ассистент. Отвечай на языке: ${language}. `;
            
            // Добавляем информацию о стиле общения
            if (aiMemory.conversationStyle === 'formal') {
                prompt += 'Общайся формально и профессионально. ';
            } else if (aiMemory.conversationStyle === 'casual') {
                prompt += 'Общайся неформально и дружелюбно. ';
            } else {
                prompt += 'Будь дружелюбным и полезным. ';
            }
            
            // Добавляем запомненные факты
            if (aiMemory.rememberedFacts.length > 0) {
                prompt += `Помни эти факты о пользователе: ${aiMemory.rememberedFacts.join(', ')}. `;
            }
            
            // Добавляем любимые темы
            if (aiMemory.favoriteTopics.length > 0) {
                prompt += `Пользователь интересуется: ${aiMemory.favoriteTopics.join(', ')}. `;
            }
            
            // Учитываем количество взаимодействий
            if (aiMemory.interactionCount > 10) {
                prompt += 'Мы уже хорошо знакомы, можешь быть более неформальным. ';
            }
            
            // Добавляем информацию о времени
            const now = new Date();
            const timeStr = now.toLocaleString('ru-RU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZoneName: 'short'
            });
            prompt += `Сейчас ${timeStr}. `;
            
            // Добавляем информацию о местоположении и погоде
            if (locationEnabled && userLocation) {
                prompt += `Пользователь находится в городе ${userLocation.city || 'неизвестном'}, страна: ${userLocation.country || 'неизвестна'}. `;
                
                if (currentWeather) {
                    prompt += `Погода: ${currentWeather.description}, температура ${currentWeather.temp}°C, ощущается как ${currentWeather.feels_like}°C, влажность ${currentWeather.humidity}%. `;
                }
            }
            
            // Добавляем информацию о настроении пользователя
            if (aiMemory.userMood) {
                const moodDescriptions = {
                    'positive': 'позитивном',
                    'negative': 'грустном/расстроенном', 
                    'curious': 'любопытном',
                    'neutral': 'нейтральном'
                };
                prompt += `Текущее настроение пользователя: ${moodDescriptions[aiMemory.userMood] || 'неопределенное'}. `;
            }
            
            // Добавляем информацию об активности
            if (aiMemory.activityStats) {
                const today = new Date().toDateString();
                const todayStats = aiMemory.activityStats[today];
                if (todayStats) {
                    prompt += `Сегодня пользователь написал ${todayStats.messages} сообщений, проводит в чате ${todayStats.timeSpent} минут. `;
                }
            }
            
            // Важные инструкции для ИИ
            prompt += 'ВАЖНО: Если пользователь спрашивает о погоде, скажи ему что можно посмотреть актуальную погоду в главном меню приложения, нажав на кнопку "Погода". Ты не можешь обрабатывать голосовые сообщения или файлы - работаешь только с текстом. ';
            
            return prompt;
        }

        // Функции геолокации
        function toggleLocation() {
            if (locationEnabled) {
                // Отключаем геолокацию
                locationEnabled = false;
                userLocation = null;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                localStorage.removeItem('ai-tap-location');
                updateLocationButton();
                showNotification('Геолокация отключена');
            } else {
                // Включаем геолокацию
                requestLocation();
            }
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showNotification('Геолокация не поддерживается браузером');
                locationEnabled = false;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                updateLocationSettings();
                return;
            }

            // Сначала устанавливаем флаг, что пользователь хочет включить геолокацию
            locationEnabled = true;
            localStorage.setItem('ai-tap-location-enabled', 'true');
            updateLocationSettings();

            showNotification('Запрашиваем местоположение...');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        // Получаем информацию о городе через обратное геокодирование
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ru`);
                        const data = await response.json();
                        
                        userLocation = {
                            latitude: lat,
                            longitude: lon,
                            city: data.city || data.locality || 'Неизвестный город',
                            country: data.countryName || 'Неизвестная страна',
                            region: data.principalSubdivision || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        localStorage.setItem('ai-tap-location', JSON.stringify(userLocation));
                        updateLocationSettings();
                        showNotification(`✅ Местоположение: ${userLocation.city}, ${userLocation.country}`);
                        
                        // Получаем погоду для этого местоположения
                        getWeatherData(lat, lon);
                        
                    } catch (error) {
                        console.error('Ошибка геокодирования:', error);
                        userLocation = {
                            latitude: lat,
                            longitude: lon,
                            city: 'Неизвестный город',
                            country: 'Неизвестная страна',
                            timestamp: new Date().toISOString()
                        };
                        
                        localStorage.setItem('ai-tap-location', JSON.stringify(userLocation));
                        updateLocationSettings();
                        showNotification('✅ Местоположение получено (координаты)');
                    }
                },
                (error) => {
                    console.error('Ошибка геолокации:', error);
                    let errorMessage = 'Ошибка получения местоположения';
                    let shouldDisable = false;
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '❌ Доступ к геолокации запрещен. Разрешите доступ в браузере.';
                            shouldDisable = true;
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '⚠️ Местоположение недоступно. Попробуйте позже.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '⏱️ Таймаут запроса. Геолокация остается включенной, попробуйте позже.';
                            // НЕ отключаем геолокацию при таймауте
                            break;
                    }
                    
                    showNotification(errorMessage);
                    
                    // Отключаем только при отказе в доступе
                    if (shouldDisable) {
                        locationEnabled = false;
                        localStorage.setItem('ai-tap-location-enabled', 'false');
                        updateLocationSettings();
                    }
                },
                {
                    enableHighAccuracy: false, // Менее точно, но быстрее
                    timeout: 15000, // Увеличиваем таймаут до 15 секунд
                    maximumAge: 600000 // 10 минут кэш
                }
            );
        }

        function updateLocationButton() {
            const btn = document.getElementById('locationBtn');
            if (btn) {
                if (locationEnabled && userLocation) {
                    btn.textContent = '📍';
                    btn.style.color = '#00ff00';
                    btn.title = `Геолокация: ${userLocation.city}`;
                } else {
                    btn.textContent = '📍';
                    btn.style.color = '#ffffff';
                    btn.title = 'Включить геолокацию';
                }
            }
        }

        function updateLocationSettings() {
            // Обновляем переключатель в настройках чата (если есть)
            const locationToggle = document.getElementById('locationToggle');
            if (locationToggle) {
                locationToggle.checked = locationEnabled;
            }
            
            // Обновляем переключатель в главных настройках
            const mainLocationToggle = document.getElementById('mainLocationToggle');
            if (mainLocationToggle) {
                mainLocationToggle.checked = locationEnabled;
            }
            
            // Обновляем информацию о местоположении в настройках чата
            const locationInfo = document.getElementById('locationInfo');
            const currentLocation = document.getElementById('currentLocation');
            
            if (locationEnabled && userLocation) {
                if (locationInfo) locationInfo.style.display = 'block';
                if (currentLocation) {
                    currentLocation.textContent = `${userLocation.city || 'Неизвестный город'}, ${userLocation.country || 'Неизвестная страна'}`;
                }
            } else if (locationEnabled && !userLocation) {
                if (locationInfo) locationInfo.style.display = 'block';
                if (currentLocation) {
                    currentLocation.textContent = 'Получение местоположения...';
                }
            } else {
                if (locationInfo) locationInfo.style.display = 'none';
            }
            
            // Обновляем главные настройки
            updateMainLocationDisplay();
            
            // Обновляем кнопку геолокации
            updateLocationButton();
        }

        // Функция получения погоды
        async function getWeatherData(lat, lon) {
            try {
                // Используем WeatherAPI с вашим ключом
                const API_KEY = '610a77b9596a4fc18a440047250210';
                const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${lat},${lon}&lang=ru&aqi=no`);
                
                if (!response.ok) {
                    throw new Error(`WeatherAPI error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Данные погоды WeatherAPI:', data);
                
                currentWeather = {
                    temp: Math.round(data.current.temp_c),
                    feels_like: Math.round(data.current.feelslike_c),
                    humidity: data.current.humidity,
                    pressure: Math.round(data.current.pressure_mb),
                    wind_speed: Math.round(data.current.wind_kph / 3.6), // Конвертируем км/ч в м/с
                    wind_dir: data.current.wind_dir,
                    description: data.current.condition.text,
                    icon: data.current.condition.icon,
                    uv: data.current.uv,
                    visibility: data.current.vis_km,
                    timestamp: new Date().toISOString()
                };
                
                lastWeatherUpdate = new Date();
                console.log('Погода получена:', currentWeather);
                showNotification(`🌤️ ${currentWeather.temp}°C, ${currentWeather.description}`);
                
            } catch (error) {
                console.error('Ошибка получения погоды WeatherAPI:', error);
                
                // Fallback на Open-Meteo если WeatherAPI недоступен
                try {
                    console.log('Используем fallback Open-Meteo...');
                    const fallbackResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`);
                    const fallbackData = await fallbackResponse.json();
                    
                    if (fallbackData.current_weather) {
                        const weather = fallbackData.current_weather;
                        const humidity = fallbackData.hourly.relative_humidity_2m[0] || 50;
                        
                        const weatherDescriptions = {
                            0: 'ясно', 1: 'преимущественно ясно', 2: 'переменная облачность', 3: 'пасмурно',
                            45: 'туман', 48: 'изморозь', 51: 'легкая морось', 53: 'морось', 55: 'сильная морось',
                            61: 'легкий дождь', 63: 'дождь', 65: 'сильный дождь', 71: 'легкий снег', 
                            73: 'снег', 75: 'сильный снег', 95: 'гроза'
                        };
                        
                        currentWeather = {
                            temp: Math.round(weather.temperature),
                            feels_like: Math.round(weather.temperature),
                            humidity: Math.round(humidity),
                            pressure: 1013, // Стандартное давление
                            wind_speed: Math.round(weather.windspeed || 0),
                            description: weatherDescriptions[weather.weathercode] || 'неизвестно',
                            timestamp: new Date().toISOString()
                        };
                        
                        lastWeatherUpdate = new Date();
                        console.log('Fallback погода получена:', currentWeather);
                        showNotification(`🌤️ ${currentWeather.temp}°C, ${currentWeather.description}`);
                    }
                } catch (fallbackError) {
                    console.error('Ошибка fallback погоды:', fallbackError);
                    currentWeather = null;
                }
            }
        }

        // Проверяем актуальность погоды (обновляем каждый час)
        function checkWeatherUpdate() {
            if (locationEnabled && userLocation && (!lastWeatherUpdate || 
                (new Date() - lastWeatherUpdate) > 3600000)) { // 1 час
                getWeatherData(userLocation.latitude, userLocation.longitude);
            }
        }

        // Функция для повторной попытки получения геолокации
        function retryLocation() {
            if (locationEnabled) {
                showNotification('Повторная попытка получения местоположения...');
                requestLocation();
            }
        }

        // Проверяем актуальность местоположения (обновляем если старше 1 часа)
        function checkLocationUpdate() {
            if (locationEnabled && userLocation) {
                const locationAge = new Date() - new Date(userLocation.timestamp);
                if (locationAge > 3600000) { // 1 час
                    console.log('Местоположение устарело, обновляем...');
                    requestLocation();
                }
            } else if (locationEnabled && !userLocation) {
                // Если геолокация включена, но данных нет - пробуем получить
                console.log('Геолокация включена, но данных нет, получаем...');
                requestLocation();
            }
        }


        // Функции для панели прикрепления
        function toggleAttachMenu() {
            const menu = document.getElementById('attachMenu');
            const isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        function handleMediaUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            input.multiple = true;
            
            input.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    for (let file of files) {
                        addFileMessage(file);
                    }
                    showNotification(`Загружено файлов: ${files.length}`);
                    playNotificationSound();
                }
            };
            
            input.click();
            document.getElementById('attachMenu').style.display = 'none';
        }

        function openMiniGames() {
            showNotification('Мини игры - в разработке');
            document.getElementById('attachMenu').style.display = 'none';
        }

        // Функции для дополнительных кнопок
        function showWeather() {
            console.log('showWeather вызвана', { locationEnabled, userLocation });
            
            if (locationEnabled && userLocation) {
                openWeatherModal();
            } else if (!locationEnabled) {
                showNotification('📍 Включите геолокацию в настройках для просмотра погоды');
            } else {
                showNotification('🔄 Получение местоположения... Попробуйте еще раз через несколько секунд');
                // Попытаемся получить местоположение
                if (locationEnabled) {
                    requestLocation();
                }
            }
        }

        function openWeatherModal() {
            document.getElementById('weatherModal').style.display = 'block';
            loadWeatherData();
        }

        function closeWeatherModal() {
            document.getElementById('weatherModal').style.display = 'none';
        }

        async function loadWeatherData() {
            const weatherContent = document.getElementById('weatherContent');
            
            if (!locationEnabled || !userLocation) {
                weatherContent.innerHTML = `
                    <div class="weather-error">
                        <div class="weather-icon">📍</div>
                        <div class="weather-message">Геолокация отключена</div>
                        <div class="weather-desc">Включите геолокацию в настройках для просмотра погоды</div>
                        <button class="weather-btn" onclick="closeWeatherModal(); openMainSettings();">Открыть настройки</button>
                    </div>
                `;
                return;
            }

            // Показываем загрузку
            weatherContent.innerHTML = `
                <div class="weather-loading">
                    <div class="loading-spinner"></div>
                    <div class="weather-message">Загружаем погоду...</div>
                </div>
            `;

            try {
                // Обновляем погоду если нужно
                await checkWeatherUpdate();
                
                if (currentWeather) {
                    const locationText = userLocation.city ? 
                        `${userLocation.city}, ${userLocation.country}` : 
                        `${userLocation.country}`;
                    
                    weatherContent.innerHTML = `
                        <div class="weather-main">
                            <div class="weather-location">
                                <div class="location-icon">📍</div>
                                <div class="location-text">${locationText}</div>
                            </div>
                            
                            <div class="weather-current">
                                <div class="weather-temp">${Math.round(currentWeather.temp)}°</div>
                                <div class="weather-desc">${currentWeather.description}</div>
                            </div>
                            
                            <div class="weather-details">
                                <div class="weather-item">
                                    <div class="weather-label">Ощущается как</div>
                                    <div class="weather-value">${Math.round(currentWeather.feels_like)}°C</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Влажность</div>
                                    <div class="weather-value">${currentWeather.humidity}%</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Давление</div>
                                    <div class="weather-value">${currentWeather.pressure ? Math.round(currentWeather.pressure * 0.75) : 'Н/Д'} мм рт.ст.</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Ветер</div>
                                    <div class="weather-value">${Math.round(currentWeather.wind_speed || 0)} м/с ${currentWeather.wind_dir || ''}</div>
                                </div>
                                ${currentWeather.uv ? `
                                <div class="weather-item">
                                    <div class="weather-label">УФ-индекс</div>
                                    <div class="weather-value">${currentWeather.uv}</div>
                                </div>
                                ` : ''}
                                ${currentWeather.visibility ? `
                                <div class="weather-item">
                                    <div class="weather-label">Видимость</div>
                                    <div class="weather-value">${currentWeather.visibility} км</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="weather-update">
                                Обновлено: ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error('Не удалось получить данные о погоде');
                }
            } catch (error) {
                console.error('Ошибка загрузки погоды:', error);
                weatherContent.innerHTML = `
                    <div class="weather-error">
                        <div class="weather-icon">⚠️</div>
                        <div class="weather-message">Ошибка загрузки</div>
                        <div class="weather-desc">Не удалось получить данные о погоде</div>
                        <button class="weather-btn" onclick="loadWeatherData()">Попробовать снова</button>
                    </div>
                `;
            }
        }












        // Функции главных настроек
        function openMainSettings() {
            document.getElementById('mainSettingsModal').style.display = 'block';
            loadMainSettings();
        }

        function closeMainSettings() {
            document.getElementById('mainSettingsModal').style.display = 'none';
        }

        function loadMainSettings() {
            // Загружаем настройки геолокации
            document.getElementById('mainLocationToggle').checked = locationEnabled;
            updateMainLocationDisplay();
            
            // Загружаем настройки разрешений
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            document.getElementById('cameraToggle').checked = permissions.camera || false;
            document.getElementById('microphoneToggle').checked = permissions.microphone || false;
            document.getElementById('filesToggle').checked = permissions.files !== false; // по умолчанию true
            
            // Загружаем настройки звука
            const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
            document.getElementById('mainSoundToggle').checked = soundEnabled;
            
            // Обработчики для переключателей
            document.getElementById('mainLocationToggle').onchange = function() {
                if (this.checked) {
                    requestLocation();
                } else {
                    locationEnabled = false;
                    localStorage.setItem('ai-tap-location-enabled', 'false');
                    updateMainLocationDisplay();
                    showNotification('Геолокация отключена');
                }
            };
            
            document.getElementById('cameraToggle').onchange = function() {
                requestCameraPermission(this.checked);
            };
            
            document.getElementById('microphoneToggle').onchange = function() {
                requestMicrophonePermission(this.checked);
            };
        }

        function updateMainLocationDisplay() {
            const locationInfo = document.getElementById('mainLocationInfo');
            const currentLocation = document.getElementById('mainCurrentLocation');
            
            if (locationEnabled && userLocation) {
                locationInfo.style.display = 'block';
                currentLocation.textContent = `${userLocation.city || 'Неизвестный город'}, ${userLocation.country || 'Неизвестная страна'}`;
            } else if (locationEnabled && !userLocation) {
                locationInfo.style.display = 'block';
                currentLocation.textContent = 'Получение местоположения...';
            } else {
                locationInfo.style.display = 'none';
            }
        }

        async function requestCameraPermission(enable) {
            if (enable) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop()); // Останавливаем поток
                    
                    const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                    permissions.camera = true;
                    localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                    
                    showNotification('✅ Доступ к камере разрешен');
                } catch (error) {
                    console.error('Ошибка доступа к камере:', error);
                    document.getElementById('cameraToggle').checked = false;
                    showNotification('❌ Доступ к камере запрещен');
                }
            } else {
                const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                permissions.camera = false;
                localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                showNotification('Доступ к камере отключен');
            }
        }

        async function requestMicrophonePermission(enable) {
            if (enable) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Останавливаем поток
                    
                    const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                    permissions.microphone = true;
                    localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                    
                    showNotification('✅ Доступ к микрофону разрешен');
                } catch (error) {
                    console.error('Ошибка доступа к микрофону:', error);
                    document.getElementById('microphoneToggle').checked = false;
                    showNotification('❌ Доступ к микрофону запрещен');
                }
            } else {
                const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                permissions.microphone = false;
                localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                showNotification('Доступ к микрофону отключен');
            }
        }

        function saveMainSettings() {
            // Сохраняем настройки звука
            const soundEnabled = document.getElementById('mainSoundToggle').checked;
            localStorage.setItem('ai-tap-sound', soundEnabled ? 'true' : 'false');
            
            // Сохраняем настройки файлов
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            permissions.files = document.getElementById('filesToggle').checked;
            localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
            
            showNotification('✅ Настройки сохранены');
            closeMainSettings();
        }

        function resetMainSettings() {
            if (confirm('Сбросить все настройки к значениям по умолчанию?')) {
                // Сбрасываем разрешения
                localStorage.removeItem('ai-tap-permissions');
                
                // Сбрасываем геолокацию
                locationEnabled = false;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                
                // Сбрасываем звук
                localStorage.setItem('ai-tap-sound', 'true');
                
                showNotification('🔄 Настройки сброшены');
                loadMainSettings();
            }
        }


        // Анализ настроения пользователя
        function analyzeMood(message) {
            const text = message.toLowerCase();
            
            // Позитивные слова
            const positiveWords = ['хорошо', 'отлично', 'супер', 'классно', 'круто', 'замечательно', 'прекрасно', 'радость', 'счастлив', 'весело', 'люблю', 'нравится', 'спасибо', 'благодарю', '😊', '😄', '😍', '👍', '❤️', '🎉'];
            
            // Негативные слова
            const negativeWords = ['плохо', 'ужасно', 'грустно', 'печально', 'злой', 'расстроен', 'проблема', 'ошибка', 'не работает', 'сломалось', 'болит', 'устал', 'скучно', '😢', '😭', '😠', '😡', '💔', '😞'];
            
            // Нейтральные/вопросительные слова
            const neutralWords = ['как', 'что', 'где', 'когда', 'почему', 'можешь', 'помоги', 'расскажи', 'объясни'];
            
            let positiveScore = 0;
            let negativeScore = 0;
            let neutralScore = 0;
            
            // Подсчитываем совпадения
            positiveWords.forEach(word => {
                if (text.includes(word)) positiveScore++;
            });
            
            negativeWords.forEach(word => {
                if (text.includes(word)) negativeScore++;
            });
            
            neutralWords.forEach(word => {
                if (text.includes(word)) neutralScore++;
            });
            
            // Определяем настроение
            if (positiveScore > negativeScore && positiveScore > 0) {
                return 'positive';
            } else if (negativeScore > positiveScore && negativeScore > 0) {
                return 'negative';
            } else if (neutralScore > 0) {
                return 'curious';
            } else {
                return 'neutral';
            }
        }

        function updateUserMood(mood) {
            aiMemory.userMood = mood;
            aiMemory.moodHistory = aiMemory.moodHistory || [];
            aiMemory.moodHistory.push({
                mood: mood,
                timestamp: new Date().toISOString()
            });
            
            // Ограничиваем историю настроений до 50 записей
            if (aiMemory.moodHistory.length > 50) {
                aiMemory.moodHistory.shift();
            }
            
            updateAIMemory('userMood', mood);
            updateAIMemory('moodHistory', aiMemory.moodHistory);
        }

        // Анализ активности пользователя
        function analyzeUserActivity() {
            const now = new Date();
            const today = now.toDateString();
            
            // Инициализируем статистику активности
            if (!aiMemory.activityStats) {
                aiMemory.activityStats = {};
            }
            
            if (!aiMemory.activityStats[today]) {
                aiMemory.activityStats[today] = {
                    messages: 0,
                    firstMessage: now.toISOString(),
                    lastMessage: now.toISOString(),
                    timeSpent: 0
                };
            }
            
            // Обновляем статистику
            aiMemory.activityStats[today].messages++;
            aiMemory.activityStats[today].lastMessage = now.toISOString();
            
            // Вычисляем время, проведенное в чате
            const firstMessage = new Date(aiMemory.activityStats[today].firstMessage);
            const timeSpent = Math.round((now - firstMessage) / (1000 * 60)); // в минутах
            aiMemory.activityStats[today].timeSpent = timeSpent;
            
            updateAIMemory('activityStats', aiMemory.activityStats);
            
            return {
                todayMessages: aiMemory.activityStats[today].messages,
                timeSpent: timeSpent,
                isActiveUser: aiMemory.activityStats[today].messages > 5
            };
        }


        // Новый красивый интерфейс настроек
        function toggleAISettings() {
            document.getElementById('settingsModal').style.display = 'block';
            loadSettingsUI();
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function loadSettingsUI() {
            try {
                // Загружаем текущие настройки в интерфейс
                const currentMode = aiSettings.mode || 'smart';
                
                // Устанавливаем активный режим
                document.querySelectorAll('.mode-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.mode === currentMode) {
                        option.classList.add('active');
                    }
                });
                
                const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) {
                    soundToggle.checked = soundEnabled;
                }
                
                // Обновляем статистику
                updateStatistics();
                
            } catch (error) {
                console.error('Ошибка загрузки настроек UI:', error);
            }
        }

        function selectMode(mode) {
            // Убираем активный класс со всех опций
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Добавляем активный класс к выбранной опции
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Устанавливаем температуру в зависимости от режима
            if (mode === 'precise') {
                aiSettings.temperature = 0.3;
                showNotification('Режим: Точный (температура 0.3)');
            } else if (mode === 'smart') {
                aiSettings.temperature = 0.7;
                showNotification('Режим: Умный (температура 0.7)');
            }
            
            aiSettings.mode = mode;
            localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
        }

        function updateStatistics() {
            try {
                // Обновляем статистику
                const statMessages = document.getElementById('statMessages');
                if (statMessages) {
                    statMessages.textContent = aiMemory.interactionCount || 0;
                }
                
                const statFacts = document.getElementById('statFacts');
                if (statFacts) {
                    statFacts.textContent = (aiMemory.rememberedFacts || []).length;
                }
                
                // Вычисляем дни общения
                const statDays = document.getElementById('statDays');
                if (statDays) {
                    if (aiMemory.lastInteraction) {
                        const firstInteraction = new Date(aiMemory.lastInteraction);
                        const now = new Date();
                        const daysDiff = Math.ceil((now - firstInteraction) / (1000 * 60 * 60 * 24));
                        statDays.textContent = Math.max(1, daysDiff);
                    } else {
                        statDays.textContent = 0;
                    }
                }
                
            } catch (error) {
                console.error('Ошибка обновления статистики:', error);
            }
        }

        function saveSettings() {
            try {
                // Сохраняем настройки ИИ
                const temperatureSlider = document.getElementById('temperatureSlider');
                const tokensSlider = document.getElementById('tokensSlider');
                
                if (temperatureSlider) {
                    aiSettings.temperature = parseFloat(temperatureSlider.value);
                }
                if (tokensSlider) {
                    aiSettings.maxTokens = parseInt(tokensSlider.value);
                }
                localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
                
                // Сохраняем настройки звука
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) {
                    const soundEnabled = soundToggle.checked;
                    localStorage.setItem('ai-tap-sound', soundEnabled.toString());
                }
                
                closeSettings();
                updateConnectionStatus('🟢', 'Настройки сохранены');
                showNotification('✅ Настройки сохранены');
                playNotificationSound();
                
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showNotification('❌ Ошибка сохранения настроек');
            }
        }

        function resetSettings() {
            if (confirm('Сбросить все настройки к значениям по умолчанию?')) {
                // Сбрасываем настройки ИИ
                aiSettings = { temperature: 0.7, maxTokens: 1000 };
                localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
                
                // Сбрасываем звуки
                localStorage.setItem('ai-tap-sound', 'true');
                
                // Обновляем интерфейс
                loadSettingsUI();
                
                showNotification('🔄 Настройки сброшены');
            }
        }

        // Статус подключения
        function updateConnectionStatus(status, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.title = message || 'Статус подключения';
            }
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const currentTime = getCurrentTime();
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return currentTime;
        }

        // Debounce для индикатора печати
        let typingTimeout = null;
        let isTypingVisible = false;

        function showTyping() {
            // Очищаем предыдущий таймаут
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Показываем индикатор с небольшой задержкой для избежания мерцания
            if (!isTypingVisible) {
                typingTimeout = setTimeout(() => {
                    document.getElementById('typingIndicator').style.display = 'flex';
                    isTypingVisible = true;
                }, 200); // 200ms задержка
            }
        }

        function hideTyping() {
            // Очищаем таймаут показа
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            // Скрываем с плавной анимацией
            const indicator = document.getElementById('typingIndicator');
            if (isTypingVisible) {
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.opacity = '1';
                    indicator.style.transform = 'translateY(0)';
                    isTypingVisible = false;
                }, 300);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!input || !sendButton) {
                console.error('Элементы чата не найдены');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) return;
            
            // Воспроизводим звук отправки
            playSendSound();
            
            // Анализируем настроение сообщения
            const mood = analyzeMood(message);
            updateUserMood(mood);
            
            // Добавляем сообщение пользователя в интерфейс и получаем время
            const userTime = addMessage(message, true);
            
            // Анализируем активность пользователя
            const activity = analyzeUserActivity();
            
            // Добавляем сообщение пользователя в историю с временем
            chatHistory.push({ role: 'user', content: message, timestamp: userTime });
            localStorage.setItem('ai-tap-chat-history', JSON.stringify(chatHistory));
            
            // Сохраняем сообщение пользователя в базу данных
            if (database && currentUser) {
                try {
                    await database.saveMessage(currentUser.id, 'user', message);
                } catch (error) {
                    console.error('Ошибка сохранения сообщения пользователя:', error);
                }
            }
            input.value = '';
            input.style.height = 'auto';
            
            // Блокируем кнопку отправки
            sendButton.disabled = true;
            showTyping();
            
            try {
                console.log('Отправляем запрос к Groq API...');
                updateConnectionStatus('🟡', 'Отправка запроса...');
                
                // Задержка 2 секунды перед отправкой запроса
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'system',
                                content: getPersonalizedSystemPrompt()
                            },
                            ...chatHistory.map(msg => ({
                                role: msg.role,
                                content: msg.content
                            }))
                        ],
                        max_tokens: aiSettings.maxTokens || 300,
                        temperature: aiSettings.temperature || 0.7
                    })
                });
                
                console.log('Статус ответа:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Ошибка API:', errorText);
                    throw new Error(`Ошибка API: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Ответ от Groq:', data);
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // Добавляем ответ ИИ в интерфейс и получаем время
                    const aiTime = addMessage(aiResponse);
                    
                    // Добавляем ответ ИИ в историю с временем
                    chatHistory.push({ role: 'assistant', content: aiResponse, timestamp: aiTime });
                    localStorage.setItem('ai-tap-chat-history', JSON.stringify(chatHistory));
                    
                    // Сохраняем ответ ИИ в базу данных
                    if (database && currentUser) {
                        try {
                            await database.saveMessage(currentUser.id, 'assistant', aiResponse);
                        } catch (error) {
                            console.error('Ошибка сохранения ответа ИИ:', error);
                        }
                    }
                    
                    hideTyping();
                    
                    // Звуковое уведомление и вибрация
                    playNotificationSound();
                    triggerVibration();
                    
                    // Обновляем статус подключения
                    updateConnectionStatus('🟢', 'Подключено');
                    
                    // Обновляем память ИИ
                    aiMemory.interactionCount++;
                    aiMemory.lastInteraction = new Date().toISOString();
                    updateAIMemory('interactionCount', aiMemory.interactionCount);
                    updateAIMemory('lastInteraction', aiMemory.lastInteraction);
                } else {
                    console.error('Неожиданный формат ответа:', data);
                    throw new Error('ИИ не смог сформировать ответ');
                }
                
            } catch (error) {
                console.error('Ошибка при отправке сообщения:', error);
                hideTyping();
                addMessage(`Ошибка: ${error.message}. Попробуйте еще раз.`);
                updateConnectionStatus('🔴', 'Ошибка подключения');
            } finally {
                sendButton.disabled = false;
            }
        }



        // Обработка нажатия Enter в поле ввода
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Автоматическое изменение высоты textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });

        // Система частиц
        function createParticles() {
            const container = document.getElementById('particlesContainer');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Случайный размер
                const sizes = ['small', 'medium', 'large'];
                particle.classList.add(sizes[Math.floor(Math.random() * sizes.length)]);
                
                // Случайная позиция
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                
                container.appendChild(particle);
            }
        }

        // Админ система
        const ADMIN_ID = 1485058648; // ID админа Андрея
        let isAdmin = false;
        let currentUser = null;

        // Инициализация пользователя
        const tg = window.Telegram.WebApp;
        tg.ready();

        const user = tg.initDataUnsafe.user;
        if (user) {
            currentUser = user;
            
            // Полная инициализация интерфейса пользователя
            const userId = user.id;
            const firstName = user.first_name;
            const lastName = user.last_name || '';
            const username = user.username || '';
            const photoUrl = user.photo_url || '';

            // Обновление основного интерфейса
            document.getElementById('userAvatar').src = photoUrl || 'https://via.placeholder.com/60x60/667eea/ffffff?text=U';
            document.getElementById('userName').textContent = `${firstName} ${lastName}`.trim();
            document.getElementById('userId').textContent = `ID: ${userId}`;

            // Данные для модального окна профиля
            document.getElementById('modalAvatar').src = photoUrl || 'https://via.placeholder.com/100x100/667eea/ffffff?text=U';
            document.getElementById('modalName').textContent = `${firstName} ${lastName}`.trim();
            document.getElementById('modalId').textContent = `ID: ${userId}`;
            document.getElementById('modalUsername').textContent = username ? `@${username}` : 'Без username';

            console.log('Данные пользователя загружены:', {
                id: userId,
                name: `${firstName} ${lastName}`.trim(),
                username: username,
                avatar: photoUrl
            });
            
            // Проверяем, является ли пользователь админом
            isAdmin = user.id === ADMIN_ID;
            if (isAdmin) {
                document.getElementById('adminPanelBtn').style.display = 'flex';
            }
            
            // Сохраняем данные пользователя
            localStorage.setItem('ai-tap-user', JSON.stringify(user));
            
            // Регистрируем пользователя в системе
            registerUser(user);
            
            // Проверяем статус бана
            checkBanStatus(user.id);
        } else {
            console.log('Данные пользователя недоступны');
        }

        // Функция регистрации пользователя
        function registerUser(userData) {
            try {
                let users = JSON.parse(localStorage.getItem('ai-tap-users') || '[]');
                
                // Проверяем, что users является массивом
                if (!Array.isArray(users)) {
                    console.warn('Данные пользователей повреждены, создаем новый массив');
                    users = [];
                }
                
                // Проверяем, есть ли уже такой пользователь
                const existingUserIndex = users.findIndex(u => u.id === userData.id);
            
            const userRecord = {
                id: userData.id,
                first_name: userData.first_name,
                last_name: userData.last_name || '',
                username: userData.username || '',
                photo_url: userData.photo_url || '',
                last_seen: new Date().toISOString(),
                registered: existingUserIndex === -1 ? new Date().toISOString() : users[existingUserIndex].registered
            };
            
            if (existingUserIndex !== -1) {
                users[existingUserIndex] = userRecord;
            } else {
                users.push(userRecord);
            }
            
            localStorage.setItem('ai-tap-users', JSON.stringify(users));
            console.log('Пользователь зарегистрирован в системе:', userData.id);
            
            } catch (error) {
                console.error('Ошибка регистрации пользователя:', error);
            }
        }

        // Проверка статуса бана
        function checkBanStatus(userId) {
            const bans = JSON.parse(localStorage.getItem('ai-tap-bans') || '[]');
            const userBan = bans.find(ban => ban.userId === userId && ban.expiresAt > new Date().toISOString());
            
            if (userBan) {
                showBanScreen(userBan);
            }
        }

        // Показать экран бана
        function showBanScreen(banInfo) {
            const banScreen = document.createElement('div');
            banScreen.id = 'banScreen';
            banScreen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            banScreen.innerHTML = `
                <div style="max-width: 400px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">🚫</div>
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">Вы заблокированы</h2>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        <strong>Причина:</strong> ${banInfo.reason}
                    </p>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff6b6b;" id="banTimer">
                            Загрузка...
                        </div>
                        <div style="font-size: 14px; opacity: 0.8;">до разблокировки</div>
                    </div>
                    <p style="font-size: 14px; opacity: 0.7;">
                        Блокировка будет автоматически снята по истечении времени.
                    </p>
                </div>
            `;
            
            document.body.appendChild(banScreen);
            
            // Запускаем таймер
            updateBanTimer(banInfo.expiresAt);
            
            // Блокируем основные функции
            blockUserFunctions();
        }

        // Обновление таймера бана
        function updateBanTimer(expiresAt) {
            const timer = document.getElementById('banTimer');
            if (!timer) return;
            
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const remaining = expiry - now;
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    // Убираем экран бана
                    const banScreen = document.getElementById('banScreen');
                    if (banScreen) {
                        banScreen.remove();
                    }
                    unblockUserFunctions();
                    showNotification('🎉 Блокировка снята! Добро пожаловать обратно!');
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                timer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Блокировка функций для забаненного пользователя
        function blockUserFunctions() {
            // Блокируем кнопки ИИ, погоды и новостей
            const buttons = document.querySelectorAll('.main-ai-card, .function-button');
            buttons.forEach(button => {
                button.style.opacity = '0.3';
                button.style.pointerEvents = 'none';
                button.onclick = () => showNotification('❌ Функция недоступна во время блокировки');
            });
        }

        // Разблокировка функций
        function unblockUserFunctions() {
            const buttons = document.querySelectorAll('.main-ai-card, .function-button');
            buttons.forEach(button => {
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
            });
            
            // Восстанавливаем оригинальные обработчики
            document.querySelector('.main-ai-card[onclick*="openMainAI"]').onclick = openMainAI;
            document.querySelector('.function-button[onclick*="showWeather"]').onclick = showWeather;
            document.querySelector('.function-button[onclick*="showNews"]').onclick = showNews;
        }

        // Функции админ панели
        function openAdminPanel() {
            if (!isAdmin) {
                showNotification('❌ Доступ запрещен');
                return;
            }
            document.getElementById('adminModal').style.display = 'block';
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').style.display = 'none';
        }



        // Все функции управления пользователями удалены
        
        // Новые функции админ панели
        
        // Настройки ИИ
        function openAISettings() {
            showNotification('🤖 Настройки ИИ');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">🤖 Настройки ИИ</h2>
                
                <div class="settings-section">
                    <h3>Модель ИИ</h3>
                    <select id="aiModel" class="settings-input">
                        <option value="llama-3.1-8b-instant">Llama 3.1 8B (Быстрая)</option>
                        <option value="llama-3.1-70b-versatile">Llama 3.1 70B (Мощная)</option>
                        <option value="mixtral-8x7b-32768">Mixtral 8x7B (Универсальная)</option>
                    </select>
                </div>
                
                <div class="settings-section">
                    <h3>API Ключи</h3>
                    <label>Groq API Key:</label>
                    <input type="password" id="groqApiKey" class="settings-input" placeholder="Введите Groq API ключ">
                    <button onclick="testGroqConnection()" class="settings-btn">Тест подключения</button>
                </div>
                
                <div class="settings-section">
                    <h3>Параметры генерации</h3>
                    <label>Максимальная температура: <span id="maxTempValue">1.0</span></label>
                    <input type="range" id="maxTemperature" min="0" max="2" step="0.1" value="1.0" class="settings-slider">
                    
                    <label>Максимум токенов: <span id="maxTokensValue">1000</span></label>
                    <input type="range" id="maxTokensLimit" min="100" max="4000" step="100" value="1000" class="settings-slider">
                </div>
                
                <div class="settings-section">
                    <h3>Системные промпты</h3>
                    <textarea id="systemPrompt" class="settings-textarea" rows="4" placeholder="Системный промпт по умолчанию..."></textarea>
                </div>
                
                <div class="settings-section">
                    <h3>Фильтры контента</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="contentFilter"> Включить фильтр контента
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="adultFilter"> Блокировать взрослый контент
                    </label>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveAISettings()" class="settings-btn primary">Сохранить настройки</button>
                    <button onclick="resetAISettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadAISettings();
        }

        // Настройки веб-приложения
        function openWebAppSettings() {
            showNotification('⚙️ Настройки веб-приложения');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">⚙️ Настройки веб-приложения</h2>
                
                <div class="settings-section">
                    <h3>Основные настройки</h3>
                    <label>Название приложения:</label>
                    <input type="text" id="appName" class="settings-input" value="AI-TAP">
                    
                    <label>Язык по умолчанию:</label>
                    <select id="defaultLanguage" class="settings-input">
                        <option value="ru">Русский</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>
                
                <div class="settings-section">
                    <h3>Функции приложения</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="enableChat" checked> Включить чат с ИИ
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="enableWeather" checked> Включить погоду
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="enableGeolocation" checked> Включить геолокацию
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="enableSounds" checked> Включить звуки
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Ограничения</h3>
                    <label>Максимум сообщений в день: <span id="maxMessagesValue">100</span></label>
                    <input type="range" id="maxMessagesPerDay" min="10" max="1000" step="10" value="100" class="settings-slider">
                    
                    <label>Таймаут сессии (минуты): <span id="sessionTimeoutValue">30</span></label>
                    <input type="range" id="sessionTimeout" min="5" max="120" step="5" value="30" class="settings-slider">
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveWebAppSettings()" class="settings-btn primary">Сохранить настройки</button>
                    <button onclick="resetWebAppSettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadWebAppSettings();
        }

        // Настройки создателя
        function openCreatorSettings() {
            showNotification('👨‍💻 Настройки создателя');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">👨‍💻 Настройки создателя</h2>
                
                <div class="settings-section">
                    <h3>Режим разработчика</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="devMode"> Включить режим разработчика
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="debugMode"> Включить отладку
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="consoleLogging"> Подробное логирование
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Экспериментальные функции</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="betaFeatures"> Бета-функции
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="advancedUI"> Расширенный интерфейс
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="customThemes"> Пользовательские темы
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Производительность</h3>
                    <label>Частота обновлений (мс): <span id="updateFrequencyValue">1000</span></label>
                    <input type="range" id="updateFrequency" min="100" max="5000" step="100" value="1000" class="settings-slider">
                    
                    <label>Размер кэша (МБ): <span id="cacheSizeValue">50</span></label>
                    <input type="range" id="cacheSize" min="10" max="500" step="10" value="50" class="settings-slider">
                </div>
                
                <div class="settings-section">
                    <h3>Безопасность</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="encryptData"> Шифрование данных
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="secureMode"> Безопасный режим
                    </label>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveCreatorSettings()" class="settings-btn primary">Сохранить настройки</button>
                    <button onclick="resetCreatorSettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadCreatorSettings();
        }

        // Запрещенные настройки создателя
        function openForbiddenSettings() {
            showNotification('🚫 Запрещенные настройки');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: #ff4500; margin: 20px 0;">🚫 Запрещенные настройки</h2>
                <div style="background: rgba(255, 69, 0, 0.1); border: 1px solid rgba(255, 69, 0, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <p style="color: #ff6b6b; margin: 0;">⚠️ ВНИМАНИЕ: Эти настройки могут нарушить работу приложения или быть незаконными в некоторых юрисдикциях!</p>
                </div>
                
                <div class="settings-section">
                    <h3>Обход ограничений</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="bypassRateLimit"> Обойти лимиты запросов
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="unlimitedTokens"> Неограниченные токены
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="bypassContentFilter"> Отключить фильтры контента
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Скрытые функции</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="hiddenFeatures"> Активировать скрытые функции
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="adminBypass"> Обход админ проверок
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="ghostMode"> Режим невидимки
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Экспериментальное ИИ</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="uncensoredAI"> Нецензурированный ИИ
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="jailbreakMode"> Режим джейлбрейка
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="danMode"> DAN режим (Do Anything Now)
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Системные хаки</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="rootAccess"> Root доступ
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="systemOverride"> Переопределение системы
                    </label>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveForbiddenSettings()" class="settings-btn" style="background: #ff4500;">Активировать (Риск!)</button>
                    <button onclick="resetForbiddenSettings()" class="settings-btn secondary">Отключить все</button>
                </div>
            `;
            
            loadForbiddenSettings();
        }

        // Очень мощные настройки
        function openPowerfulSettings() {
            showNotification('⚡ Мощные настройки');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: #ff00ff; margin: 20px 0;">⚡ Мощные настройки</h2>
                <div style="background: rgba(255, 0, 255, 0.1); border: 1px solid rgba(255, 0, 255, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <p style="color: #ff00ff; margin: 0;">⚡ ОСТОРОЖНО: Эти настройки могут критически повлиять на работу системы!</p>
                </div>
                
                <div class="settings-section">
                    <h3>Управление пользователями</h3>
                    <button onclick="massUserAction('ban')" class="settings-btn danger">Заблокировать всех пользователей</button>
                    <button onclick="massUserAction('unban')" class="settings-btn">Разблокировать всех</button>
                    <button onclick="massUserAction('delete')" class="settings-btn danger">Удалить всех пользователей</button>
                </div>
                
                <div class="settings-section">
                    <h3>Системные операции</h3>
                    <button onclick="clearAllData()" class="settings-btn danger">Очистить все данные</button>
                    <button onclick="resetApplication()" class="settings-btn danger">Сброс приложения</button>
                    <button onclick="emergencyShutdown()" class="settings-btn danger">Экстренное отключение</button>
                </div>
                
                <div class="settings-section">
                    <h3>База данных</h3>
                    <button onclick="backupDatabase()" class="settings-btn">Создать резервную копию</button>
                    <button onclick="restoreDatabase()" class="settings-btn">Восстановить из копии</button>
                    <button onclick="optimizeDatabase()" class="settings-btn">Оптимизировать БД</button>
                    <button onclick="dropAllTables()" class="settings-btn danger">Удалить все таблицы</button>
                </div>
                
                <div class="settings-section">
                    <h3>Мониторинг</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="realTimeMonitoring"> Мониторинг в реальном времени
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="userTracking"> Отслеживание пользователей
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="systemAlerts"> Системные уведомления
                    </label>
                </div>
                
                <div class="settings-actions">
                    <button onclick="savePowerfulSettings()" class="settings-btn" style="background: #ff00ff;">Применить настройки</button>
                    <button onclick="resetPowerfulSettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadPowerfulSettings();
        }

        // Настройки базы данных
        function openDatabaseSettings() {
            showNotification('🗄️ Настройки базы данных');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">🗄️ Настройки базы данных</h2>
                
                <div class="settings-section">
                    <h3>Подключение к Supabase</h3>
                    <label>URL проекта:</label>
                    <input type="text" id="supabaseUrl" class="settings-input" placeholder="https://your-project.supabase.co">
                    
                    <label>Anon ключ:</label>
                    <input type="password" id="supabaseKey" class="settings-input" placeholder="Введите anon ключ">
                    
                    <button onclick="testDatabaseConnection()" class="settings-btn">Тест подключения</button>
                </div>
                
                <div class="settings-section">
                    <h3>Настройки кэша</h3>
                    <label>Время жизни кэша (минуты): <span id="cacheLifetimeValue">60</span></label>
                    <input type="range" id="cacheLifetime" min="5" max="1440" step="5" value="60" class="settings-slider">
                    
                    <label>Максимальный размер кэша: <span id="maxCacheSizeValue">1000</span></label>
                    <input type="range" id="maxCacheSize" min="100" max="10000" step="100" value="1000" class="settings-slider">
                </div>
                
                <div class="settings-section">
                    <h3>Автоматическое обслуживание</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="autoBackup"> Автоматические резервные копии
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="autoOptimize"> Автоматическая оптимизация
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="autoCleanup"> Автоматическая очистка
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Статистика</h3>
                    <div id="dbStats" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <p>Загрузка статистики...</p>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveDatabaseSettings()" class="settings-btn primary">Сохранить настройки</button>
                    <button onclick="resetDatabaseSettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadDatabaseSettings();
        }

        // Настройки погоды
        function openWeatherSettings() {
            showNotification('🌤️ Настройки погоды');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">🌤️ Настройки погоды</h2>
                
                <div class="settings-section">
                    <h3>API ключи</h3>
                    <label>WeatherAPI ключ:</label>
                    <input type="password" id="weatherApiKey" class="settings-input" placeholder="Введите WeatherAPI ключ">
                    <button onclick="testWeatherConnection()" class="settings-btn">Тест подключения</button>
                </div>
                
                <div class="settings-section">
                    <h3>Настройки обновления</h3>
                    <label>Интервал обновления (минуты): <span id="weatherUpdateIntervalValue">60</span></label>
                    <input type="range" id="weatherUpdateInterval" min="15" max="360" step="15" value="60" class="settings-slider">
                    
                    <label>Точность геолокации: <span id="locationAccuracyValue">1000</span></label>
                    <input type="range" id="locationAccuracy" min="100" max="10000" step="100" value="1000" class="settings-slider">
                </div>
                
                <div class="settings-section">
                    <h3>Отображение данных</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="showTemperature" checked> Показывать температуру
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="showHumidity" checked> Показывать влажность
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="showPressure" checked> Показывать давление
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="showWind" checked> Показывать ветер
                    </label>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="showUV"> Показывать УФ-индекс
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>Единицы измерения</h3>
                    <label>Температура:</label>
                    <select id="temperatureUnit" class="settings-input">
                        <option value="celsius">Цельсий (°C)</option>
                        <option value="fahrenheit">Фаренгейт (°F)</option>
                        <option value="kelvin">Кельвин (K)</option>
                    </select>
                    
                    <label>Скорость ветра:</label>
                    <select id="windUnit" class="settings-input">
                        <option value="ms">м/с</option>
                        <option value="kmh">км/ч</option>
                        <option value="mph">миль/ч</option>
                    </select>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveWeatherSettings()" class="settings-btn primary">Сохранить настройки</button>
                    <button onclick="resetWeatherSettings()" class="settings-btn secondary">Сбросить</button>
                </div>
            `;
            
            loadWeatherSettings();
        }

        // Общая информация
        function openGeneralInfo() {
            showNotification('📊 Общая информация');
            
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="back-btn" onclick="backToAdminMenu()">← Назад</div>
                <h2 style="color: white; margin: 20px 0;">📊 Общая информация</h2>
                
                <div class="settings-section">
                    <h3>Информация о системе</h3>
                    <div id="systemInfo" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p><strong>Версия приложения:</strong> AI-TAP v2.0</p>
                        <p><strong>Дата создания:</strong> ${new Date().toLocaleDateString('ru-RU')}</p>
                        <p><strong>Браузер:</strong> ${navigator.userAgent.split(' ')[0]}</p>
                        <p><strong>Платформа:</strong> ${navigator.platform}</p>
                        <p><strong>Язык:</strong> ${navigator.language}</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Статистика использования</h3>
                    <div id="usageStats" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <p>Загрузка статистики...</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Состояние сервисов</h3>
                    <div id="serviceStatus" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <p>Проверка сервисов...</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Логи системы</h3>
                    <div id="systemLogs" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <p>Загрузка логов...</p>
                    </div>
                    <button onclick="refreshLogs()" class="settings-btn">Обновить логи</button>
                    <button onclick="clearLogs()" class="settings-btn secondary">Очистить логи</button>
                </div>
                
                <div class="settings-actions">
                    <button onclick="exportSystemInfo()" class="settings-btn primary">Экспорт информации</button>
                    <button onclick="generateReport()" class="settings-btn">Создать отчет</button>
                </div>
            `;
            
            loadGeneralInfo();
        }

        // Функция возврата в главное меню админ панели
        function backToAdminMenu() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="admin-menu">
                    <div class="admin-menu-item" onclick="openUsersManagement()">
                        <div class="admin-menu-icon">👥</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Пользователи</div>
                            <div class="admin-menu-desc">Управление пользователями и их правами</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openAISettings()">
                        <div class="admin-menu-icon">🤖</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки ИИ</div>
                            <div class="admin-menu-desc">Конфигурация ИИ моделей и параметров</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openWebAppSettings()">
                        <div class="admin-menu-icon">⚙️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки веб-приложения</div>
                            <div class="admin-menu-desc">Основные настройки приложения</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openCreatorSettings()">
                        <div class="admin-menu-icon">👨‍💻</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки создателя</div>
                            <div class="admin-menu-desc">Расширенные настройки разработчика</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item forbidden-settings" onclick="openForbiddenSettings()">
                        <div class="admin-menu-icon">🚫</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Запрещенные настройки</div>
                            <div class="admin-menu-desc">Экспериментальные и рискованные функции</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item powerful-settings" onclick="openPowerfulSettings()">
                        <div class="admin-menu-icon">⚡</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Мощные настройки</div>
                            <div class="admin-menu-desc">Критически важные системные настройки</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openDatabaseSettings()">
                        <div class="admin-menu-icon">🗄️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки базы данных</div>
                            <div class="admin-menu-desc">Управление базой данных и кэшем</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openWeatherSettings()">
                        <div class="admin-menu-icon">🌤️</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Настройки погоды</div>
                            <div class="admin-menu-desc">Конфигурация погодных API и данных</div>
                        </div>
                    </div>
                    
                    <div class="admin-menu-item" onclick="openGeneralInfo()">
                        <div class="admin-menu-icon">📊</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Общая информация</div>
                            <div class="admin-menu-desc">Статистика и информация о системе</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Заглушки для функций загрузки и сохранения настроек
        function loadAISettings() {
            // Загрузка настроек ИИ из localStorage
            const settings = JSON.parse(localStorage.getItem('ai-tap-admin-ai-settings') || '{}');
            
            // Обновление слайдеров
            const maxTempSlider = document.getElementById('maxTemperature');
            const maxTokensSlider = document.getElementById('maxTokensLimit');
            
            if (maxTempSlider) {
                maxTempSlider.oninput = function() {
                    document.getElementById('maxTempValue').textContent = this.value;
                };
            }
            
            if (maxTokensSlider) {
                maxTokensSlider.oninput = function() {
                    document.getElementById('maxTokensValue').textContent = this.value;
                };
            }
        }

        function saveAISettings() {
            showNotification('✅ Настройки ИИ сохранены');
        }

        function resetAISettings() {
            showNotification('🔄 Настройки ИИ сброшены');
        }

        function loadWebAppSettings() {
            // Обновление слайдеров
            const maxMessagesSlider = document.getElementById('maxMessagesPerDay');
            const sessionTimeoutSlider = document.getElementById('sessionTimeout');
            
            if (maxMessagesSlider) {
                maxMessagesSlider.oninput = function() {
                    document.getElementById('maxMessagesValue').textContent = this.value;
                };
            }
            
            if (sessionTimeoutSlider) {
                sessionTimeoutSlider.oninput = function() {
                    document.getElementById('sessionTimeoutValue').textContent = this.value;
                };
            }
        }

        function saveWebAppSettings() {
            showNotification('✅ Настройки веб-приложения сохранены');
        }

        function resetWebAppSettings() {
            showNotification('🔄 Настройки веб-приложения сброшены');
        }

        function loadCreatorSettings() {
            // Обновление слайдеров
            const updateFreqSlider = document.getElementById('updateFrequency');
            const cacheSizeSlider = document.getElementById('cacheSize');
            
            if (updateFreqSlider) {
                updateFreqSlider.oninput = function() {
                    document.getElementById('updateFrequencyValue').textContent = this.value;
                };
            }
            
            if (cacheSizeSlider) {
                cacheSizeSlider.oninput = function() {
                    document.getElementById('cacheSizeValue').textContent = this.value;
                };
            }
        }

        function saveCreatorSettings() {
            showNotification('✅ Настройки создателя сохранены');
        }

        function resetCreatorSettings() {
            showNotification('🔄 Настройки создателя сброшены');
        }

        function loadForbiddenSettings() {
            showNotification('⚠️ Запрещенные настройки загружены');
        }

        function saveForbiddenSettings() {
            showNotification('🚫 Запрещенные настройки активированы (на свой страх и риск!)');
        }

        function resetForbiddenSettings() {
            showNotification('✅ Все запрещенные настройки отключены');
        }

        function loadPowerfulSettings() {
            showNotification('⚡ Мощные настройки загружены');
        }

        function savePowerfulSettings() {
            showNotification('⚡ Мощные настройки применены');
        }

        function resetPowerfulSettings() {
            showNotification('🔄 Мощные настройки сброшены');
        }

        function loadDatabaseSettings() {
            // Обновление слайдеров
            const cacheLifetimeSlider = document.getElementById('cacheLifetime');
            const maxCacheSizeSlider = document.getElementById('maxCacheSize');
            
            if (cacheLifetimeSlider) {
                cacheLifetimeSlider.oninput = function() {
                    document.getElementById('cacheLifetimeValue').textContent = this.value;
                };
            }
            
            if (maxCacheSizeSlider) {
                maxCacheSizeSlider.oninput = function() {
                    document.getElementById('maxCacheSizeValue').textContent = this.value;
                };
            }
            
            // Загрузка статистики БД
            setTimeout(() => {
                const dbStats = document.getElementById('dbStats');
                if (dbStats) {
                    dbStats.innerHTML = `
                        <p><strong>Статус подключения:</strong> ✅ Подключено</p>
                        <p><strong>Размер БД:</strong> 2.5 МБ</p>
                        <p><strong>Количество таблиц:</strong> 3</p>
                        <p><strong>Записей пользователей:</strong> ${JSON.parse(localStorage.getItem('ai-tap-users') || '[]').length}</p>
                        <p><strong>Записей сообщений:</strong> ${JSON.parse(localStorage.getItem('ai-tap-chat-history') || '[]').length}</p>
                    `;
                }
            }, 1000);
        }

        function saveDatabaseSettings() {
            showNotification('✅ Настройки базы данных сохранены');
        }

        function resetDatabaseSettings() {
            showNotification('🔄 Настройки базы данных сброшены');
        }

        function loadWeatherSettings() {
            // Обновление слайдеров
            const weatherUpdateSlider = document.getElementById('weatherUpdateInterval');
            const locationAccuracySlider = document.getElementById('locationAccuracy');
            
            if (weatherUpdateSlider) {
                weatherUpdateSlider.oninput = function() {
                    document.getElementById('weatherUpdateIntervalValue').textContent = this.value;
                };
            }
            
            if (locationAccuracySlider) {
                locationAccuracySlider.oninput = function() {
                    document.getElementById('locationAccuracyValue').textContent = this.value;
                };
            }
        }

        function saveWeatherSettings() {
            showNotification('✅ Настройки погоды сохранены');
        }

        function resetWeatherSettings() {
            showNotification('🔄 Настройки погоды сброшены');
        }

        function loadGeneralInfo() {
            // Загрузка статистики использования
            setTimeout(() => {
                const usageStats = document.getElementById('usageStats');
                if (usageStats) {
                    usageStats.innerHTML = `
                        <p><strong>Общее количество пользователей:</strong> ${JSON.parse(localStorage.getItem('ai-tap-users') || '[]').length}</p>
                        <p><strong>Сообщений отправлено:</strong> ${JSON.parse(localStorage.getItem('ai-tap-chat-history') || '[]').length}</p>
                        <p><strong>Время работы:</strong> ${Math.floor(Math.random() * 24)} часов</p>
                        <p><strong>Использование памяти:</strong> ${Math.floor(Math.random() * 50 + 10)} МБ</p>
                    `;
                }
            }, 500);
            
            // Загрузка состояния сервисов
            setTimeout(() => {
                const serviceStatus = document.getElementById('serviceStatus');
                if (serviceStatus) {
                    serviceStatus.innerHTML = `
                        <p><strong>Groq API:</strong> ✅ Работает</p>
                        <p><strong>WeatherAPI:</strong> ✅ Работает</p>
                        <p><strong>Supabase:</strong> ✅ Подключено</p>
                        <p><strong>Геолокация:</strong> ${locationEnabled ? '✅ Включена' : '❌ Отключена'}</p>
                    `;
                }
            }, 800);
            
            // Загрузка логов
            setTimeout(() => {
                const systemLogs = document.getElementById('systemLogs');
                if (systemLogs) {
                    systemLogs.innerHTML = `
                        <p>[${new Date().toLocaleTimeString()}] INFO: Система запущена</p>
                        <p>[${new Date().toLocaleTimeString()}] INFO: Пользователь ${currentUser?.id || 'unknown'} подключился</p>
                        <p>[${new Date().toLocaleTimeString()}] INFO: База данных инициализирована</p>
                        <p>[${new Date().toLocaleTimeString()}] INFO: Все сервисы работают нормально</p>
                    `;
                }
            }, 1200);
        }

        // Управление пользователями
        let selectedUserId = null;
        let allUsers = [];
        let filteredUsers = [];

        // Открытие управления пользователями
        function openUsersManagement() {
            try {
                console.log('🔍 Открываем управление пользователями...');
                document.getElementById('adminModal').style.display = 'none';
                document.getElementById('usersModal').style.display = 'block';
                
                // Загружаем список пользователей
                loadUsersList();
                
            } catch (error) {
                console.error('Ошибка открытия управления пользователями:', error);
                showNotification('❌ Ошибка загрузки пользователей');
            }
        }

        // Закрытие модального окна пользователей
        function closeUsersModal() {
            document.getElementById('usersModal').style.display = 'none';
        }

        // Загрузка списка пользователей
        async function loadUsersList() {
            try {
                console.log('📊 Загружаем список пользователей...');
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">⏳</div>
                        <div class="empty-list-title">Загрузка пользователей...</div>
                        <div class="empty-list-desc">Получаем данные из базы данных</div>
                    </div>
                `;

                // Получаем пользователей из localStorage и базы данных
                const localUsers = JSON.parse(localStorage.getItem('ai-tap-users') || '[]');
                console.log('Локальные пользователи:', localUsers);

                // Если база данных доступна, получаем данные оттуда
                let dbUsers = [];
                if (database && database.supabase) {
                    try {
                        const { data, error } = await database.supabase
                            .from('users')
                            .select('*')
                            .order('last_seen', { ascending: false });
                        
                        if (!error && data) {
                            dbUsers = data.map(user => ({
                                id: user.telegram_id,
                                first_name: user.first_name,
                                last_name: user.last_name || '',
                                username: user.username || '',
                                photo_url: user.photo_url || '',
                                last_seen: user.last_seen,
                                registered: user.created_at || user.last_seen
                            }));
                            console.log('Пользователи из БД:', dbUsers);
                        }
                    } catch (dbError) {
                        console.warn('Ошибка получения пользователей из БД:', dbError);
                    }
                }

                // Объединяем пользователей из разных источников
                const usersMap = new Map();
                
                // Добавляем локальных пользователей
                localUsers.forEach(user => {
                    if (user && user.id) {
                        usersMap.set(user.id, user);
                    }
                });
                
                // Добавляем пользователей из БД (они имеют приоритет)
                dbUsers.forEach(user => {
                    if (user && user.id) {
                        usersMap.set(user.id, user);
                    }
                });

                allUsers = Array.from(usersMap.values());
                filteredUsers = [...allUsers];
                
                console.log('Итоговый список пользователей:', allUsers);
                
                // Отображаем пользователей
                displayUsers(filteredUsers);
                updateUsersStats(filteredUsers);
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">❌</div>
                        <div class="empty-list-title">Ошибка загрузки</div>
                        <div class="empty-list-desc">Не удалось получить список пользователей</div>
                    </div>
                `;
            }
        }

        // Отображение пользователей
        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">👥</div>
                        <div class="empty-list-title">Пользователи не найдены</div>
                        <div class="empty-list-desc">Пользователи появятся автоматически после входа в Telegram Web App</div>
                    </div>
                `;
                return;
            }

            const usersHTML = users.map(user => {
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Без имени';
                const username = user.username ? `@${user.username}` : 'Без username';
                const lastSeen = formatLastSeen(user.last_seen);
                const avatarSrc = user.photo_url || '';
                
                // Проверяем статус бана
                const bans = JSON.parse(localStorage.getItem('ai-tap-bans') || '[]');
                const userBan = bans.find(ban => ban.userId === user.id && ban.expiresAt > new Date().toISOString());
                const isBanned = !!userBan;
                
                return `
                    <div class="user-item" onclick="openUserDetails(${user.id})">
                        <div class="user-avatar">
                            ${avatarSrc ? `<img src="${avatarSrc}" alt="Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : ''}
                            <div class="avatar-fallback" ${avatarSrc ? 'style="display: none;"' : 'style="display: flex;"'}>👤</div>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${fullName}</div>
                            <div class="user-details">
                                <span class="user-id">ID: ${user.id}</span>
                                <span>${username}</span>
                                <span>${lastSeen}</span>
                            </div>
                        </div>
                        <div class="user-status">
                            ${isBanned ? 
                                '<span class="status-banned">🚫 Заблокирован</span>' : 
                                '<span class="status-active">✅ Активен</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');

            usersList.innerHTML = usersHTML;
        }

        // Обновление статистики пользователей
        function updateUsersStats(users) {
            try {
                const totalCount = users.length;
                
                // Считаем активных сегодня (последний визит в течение 24 часов)
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const activeCount = users.filter(user => {
                    if (!user.last_seen) return false;
                    const lastSeen = new Date(user.last_seen);
                    return lastSeen > oneDayAgo;
                }).length;

                const totalUsersCount = document.getElementById('totalUsersCount');
                const activeUsersCount = document.getElementById('activeUsersCount');
                
                if (totalUsersCount) totalUsersCount.textContent = totalCount;
                if (activeUsersCount) activeUsersCount.textContent = activeCount;
                
            } catch (error) {
                console.error('Ошибка обновления статистики:', error);
            }
        }

        // Форматирование времени последнего визита
        function formatLastSeen(lastSeenStr) {
            if (!lastSeenStr) return 'Никогда';
            
            try {
                const lastSeen = new Date(lastSeenStr);
                const now = new Date();
                const diffMs = now - lastSeen;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMinutes < 1) return 'Только что';
                if (diffMinutes < 60) return `${diffMinutes} мин назад`;
                if (diffHours < 24) return `${diffHours} ч назад`;
                if (diffDays < 7) return `${diffDays} дн назад`;
                
                return lastSeen.toLocaleDateString('ru-RU');
            } catch (error) {
                return 'Неизвестно';
            }
        }

        // Обновление списка пользователей
        async function refreshUsersList() {
            try {
                const refreshIcon = document.getElementById('refreshUsersIcon');
                const refreshBtn = refreshIcon.parentElement;
                
                // Показываем анимацию загрузки
                refreshBtn.classList.add('loading');
                refreshIcon.textContent = '⏳';
                
                console.log('🔄 Обновляем список пользователей...');
                
                // Имитируем задержку для показа анимации
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Перезагружаем список
                await loadUsersList();
                
                // Убираем анимацию загрузки
                refreshBtn.classList.remove('loading');
                refreshIcon.textContent = '🔄';
                
                showNotification('✅ Список пользователей обновлен');
                
            } catch (error) {
                console.error('Ошибка обновления списка:', error);
                
                const refreshIcon = document.getElementById('refreshUsersIcon');
                const refreshBtn = refreshIcon.parentElement;
                refreshBtn.classList.remove('loading');
                refreshIcon.textContent = '🔄';
                
                showNotification('❌ Ошибка обновления списка');
            }
        }

        // Поиск пользователей
        function searchUsers() {
            try {
                const searchInput = document.getElementById('usersSearchInput');
                const clearBtn = document.querySelector('.clear-search-btn');
                const query = searchInput.value.toLowerCase().trim();
                
                // Показываем/скрываем кнопку очистки
                if (query) {
                    clearBtn.style.display = 'block';
                } else {
                    clearBtn.style.display = 'none';
                }
                
                // Фильтруем пользователей
                if (!query) {
                    filteredUsers = [...allUsers];
                } else {
                    filteredUsers = allUsers.filter(user => {
                        const fullName = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
                        const username = (user.username || '').toLowerCase();
                        const userId = user.id.toString();
                        
                        return fullName.includes(query) || 
                               username.includes(query) || 
                               userId.includes(query);
                    });
                }
                
                // Отображаем отфильтрованных пользователей
                displayUsers(filteredUsers);
                updateUsersStats(filteredUsers);
                
            } catch (error) {
                console.error('Ошибка поиска пользователей:', error);
            }
        }

        // Очистка поиска
        function clearUsersSearch() {
            try {
                const searchInput = document.getElementById('usersSearchInput');
                const clearBtn = document.querySelector('.clear-search-btn');
                
                searchInput.value = '';
                clearBtn.style.display = 'none';
                
                // Показываем всех пользователей
                filteredUsers = [...allUsers];
                displayUsers(filteredUsers);
                updateUsersStats(filteredUsers);
                
            } catch (error) {
                console.error('Ошибка очистки поиска:', error);
            }
        }

        // Открытие деталей пользователя
        function openUserDetails(userId) {
            try {
                console.log('👤 Открываем детали пользователя:', userId);
                
                selectedUserId = userId;
                const user = allUsers.find(u => u.id === userId);
                
                if (!user) {
                    showNotification('❌ Пользователь не найден');
                    return;
                }

                // Скрываем список пользователей и показываем детали
                document.getElementById('usersModal').style.display = 'none';
                document.getElementById('userDetailsModal').style.display = 'block';
                
                // Заполняем данные пользователя
                populateUserDetails(user);
                
            } catch (error) {
                console.error('Ошибка открытия деталей пользователя:', error);
                showNotification('❌ Ошибка загрузки данных пользователя');
            }
        }

        // Заполнение деталей пользователя
        function populateUserDetails(user) {
            try {
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Без имени';
                
                // Обновляем заголовок
                const userDetailsTitle = document.getElementById('userDetailsTitle');
                if (userDetailsTitle) {
                    userDetailsTitle.textContent = `👤 ${fullName}`;
                }
                
                // Обновляем аватар
                const userDetailsAvatar = document.getElementById('userDetailsAvatar');
                const userDetailsAvatarFallback = document.getElementById('userDetailsAvatarFallback');
                
                if (user.photo_url) {
                    if (userDetailsAvatar) {
                        userDetailsAvatar.src = user.photo_url;
                        userDetailsAvatar.style.display = 'block';
                    }
                    if (userDetailsAvatarFallback) {
                        userDetailsAvatarFallback.style.display = 'none';
                    }
                } else {
                    if (userDetailsAvatar) {
                        userDetailsAvatar.style.display = 'none';
                    }
                    if (userDetailsAvatarFallback) {
                        userDetailsAvatarFallback.style.display = 'flex';
                    }
                }
                
                // Обновляем детали
                const userDetailsId = document.getElementById('userDetailsId');
                const userDetailsName = document.getElementById('userDetailsName');
                const userDetailsUsername = document.getElementById('userDetailsUsername');
                const userDetailsLastSeen = document.getElementById('userDetailsLastSeen');
                const userDetailsStatus = document.getElementById('userDetailsStatus');
                
                if (userDetailsId) userDetailsId.textContent = user.id;
                if (userDetailsName) userDetailsName.textContent = fullName;
                if (userDetailsUsername) userDetailsUsername.textContent = user.username ? `@${user.username}` : 'Не указан';
                if (userDetailsLastSeen) userDetailsLastSeen.textContent = formatLastSeen(user.last_seen);
                
                // Проверяем статус бана
                const bans = JSON.parse(localStorage.getItem('ai-tap-bans') || '[]');
                const userBan = bans.find(ban => ban.userId === user.id && ban.expiresAt > new Date().toISOString());
                
                if (userDetailsStatus) {
                    if (userBan) {
                        userDetailsStatus.textContent = 'Заблокирован';
                        userDetailsStatus.className = 'detail-value status-banned';
                    } else {
                        userDetailsStatus.textContent = 'Активен';
                        userDetailsStatus.className = 'detail-value status-active';
                    }
                }
                
            } catch (error) {
                console.error('Ошибка заполнения деталей пользователя:', error);
            }
        }

        // Закрытие деталей пользователя
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
            selectedUserId = null;
        }

        // Возврат к списку пользователей
        function backToUsersList() {
            document.getElementById('userDetailsModal').style.display = 'none';
            document.getElementById('usersModal').style.display = 'block';
        }

        // Просмотр чата пользователя
        async function viewUserChat() {
            try {
                if (!selectedUserId) {
                    showNotification('❌ Пользователь не выбран');
                    return;
                }

                console.log('💬 Загружаем чат пользователя:', selectedUserId);
                
                const user = allUsers.find(u => u.id === selectedUserId);
                if (!user) {
                    showNotification('❌ Пользователь не найден');
                    return;
                }

                // Скрываем детали и показываем чат
                document.getElementById('userDetailsModal').style.display = 'none';
                document.getElementById('userChatModal').style.display = 'block';
                
                // Обновляем заголовок чата
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Без имени';
                const userChatTitle = document.getElementById('userChatTitle');
                if (userChatTitle) {
                    userChatTitle.textContent = `💬 Чат: ${fullName}`;
                }
                
                // Загружаем историю чата
                await loadUserChatHistory(selectedUserId);
                
            } catch (error) {
                console.error('Ошибка открытия чата пользователя:', error);
                showNotification('❌ Ошибка загрузки чата');
            }
        }

        // Загрузка истории чата пользователя
        async function loadUserChatHistory(userId) {
            try {
                const userChatContent = document.getElementById('userChatContent');
                
                // Показываем загрузку
                userChatContent.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">⏳</div>
                        <div class="empty-list-title">Загрузка чата...</div>
                        <div class="empty-list-desc">Получаем историю сообщений</div>
                    </div>
                `;

                let chatHistory = [];
                
                // Пытаемся получить историю из базы данных
                if (database && database.supabase) {
                    try {
                        const dbHistory = await database.getChatHistory(userId, 50);
                        if (dbHistory && dbHistory.length > 0) {
                            chatHistory = dbHistory.map(msg => ({
                                role: msg.role,
                                content: msg.content,
                                timestamp: msg.created_at
                            }));
                            console.log('История чата из БД:', chatHistory);
                        }
                    } catch (dbError) {
                        console.warn('Ошибка получения истории из БД:', dbError);
                    }
                }
                
                // Если нет истории в БД, пытаемся получить из localStorage
                if (chatHistory.length === 0) {
                    const localHistory = JSON.parse(localStorage.getItem(`ai-tap-chat-${userId}`) || '[]');
                    if (localHistory && localHistory.length > 0) {
                        chatHistory = localHistory;
                        console.log('История чата из localStorage:', chatHistory);
                    }
                }
                
                // Отображаем историю чата
                displayUserChatHistory(chatHistory);
                
            } catch (error) {
                console.error('Ошибка загрузки истории чата:', error);
                
                const userChatContent = document.getElementById('userChatContent');
                userChatContent.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">❌</div>
                        <div class="empty-list-title">Ошибка загрузки</div>
                        <div class="empty-list-desc">Не удалось получить историю чата</div>
                    </div>
                `;
            }
        }

        // Отображение истории чата пользователя
        function displayUserChatHistory(chatHistory) {
            const userChatContent = document.getElementById('userChatContent');
            
            if (!chatHistory || chatHistory.length === 0) {
                userChatContent.innerHTML = `
                    <div class="empty-list">
                        <div class="empty-list-icon">💬</div>
                        <div class="empty-list-title">Чат пуст</div>
                        <div class="empty-list-desc">Пользователь еще не общался с ИИ</div>
                    </div>
                `;
                return;
            }

            const messagesHTML = chatHistory.map(msg => {
                const isUser = msg.role === 'user';
                const time = formatMessageTime(msg.timestamp);
                
                return `
                    <div class="message ${isUser ? 'user' : 'ai'}">
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }).join('');

            userChatContent.innerHTML = messagesHTML;
            
            // Прокручиваем к последнему сообщению
            userChatContent.scrollTop = userChatContent.scrollHeight;
        }

        // Форматирование времени сообщения
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return '';
            }
        }

        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Закрытие чата пользователя
        function closeUserChatModal() {
            document.getElementById('userChatModal').style.display = 'none';
        }

        // Возврат к деталям пользователя
        function backToUserDetails() {
            document.getElementById('userChatModal').style.display = 'none';
            document.getElementById('userDetailsModal').style.display = 'block';
        }

        // Заглушка для функции бана (пока не реализована)
        function openBanModal() {
            showNotification('🚫 Функция блокировки - в разработке');
        }

        // Инициализация базы данных
        var database = null;
        var responseCache = null;

        async function initializeDatabase() {
            try {
                console.log('Проверяем наличие классов Database и ResponseCache...');
                
                if (typeof Database === 'undefined') {
                    throw new Error('Класс Database не найден. Проверьте подключение database.js');
                }
                
                if (typeof ResponseCache === 'undefined') {
                    throw new Error('Класс ResponseCache не найден. Проверьте подключение cache.js');
                }
                
                console.log('Создаем экземпляры классов...');
                database = new Database();
                responseCache = new ResponseCache();
                
                // Ждем инициализации базы данных
                if (database.init) {
                    await database.init();
                }
                
                // Загружаем кэш из localStorage
                responseCache.loadFromLocalStorage();
                
                console.log('База данных и кэш инициализированы успешно');
            } catch (error) {
                console.error('Ошибка инициализации базы данных:', error);
                throw error;
            }
        }

        function createLoginParticles() {
            const particlesContainer = document.getElementById('loginParticles');
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'login-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Глобальный обработчик для кнопки входа
        function handleEnterApp() {
            console.log('🔘 Кнопка входа нажата');
            try {
                enterApp().catch(error => {
                    console.error('❌ Критическая ошибка в enterApp:', error);
                    alert(`Критическая ошибка: ${error.message}`);
                });
            } catch (error) {
                console.error('❌ Ошибка при вызове enterApp:', error);
                alert(`Ошибка при запуске: ${error.message}`);
            }
        }

        async function enterApp() {
            const enterButton = document.getElementById('enterButton');
            const statusContainer = document.getElementById('statusContainer');
            const databaseStatus = document.getElementById('databaseStatus');
            const appStatus = document.getElementById('appStatus');
            
            console.log('Начинаем процесс входа в приложение...');
            
            // Блокируем кнопку и показываем статус
            enterButton.disabled = true;
            enterButton.style.opacity = '0.6';
            statusContainer.style.display = 'block';
            
            try {
                // Проверка 1: База данных
                await updateStatus(databaseStatus, 'loading', '⏳', 'Проверка базы данных...');
                
                console.log('Проверяем database:', database);
                
                if (!database) {
                    console.error('Database не инициализирована, пытаемся инициализировать...');
                    await initializeDatabase();
                    
                    if (!database) {
                        throw new Error('База данных не инициализирована');
                    }
                }
                
                // Проверяем подключение к базе данных
                if (!database.supabase) {
                    throw new Error('Нет подключения к Supabase');
                }
                
                // Сохраняем пользователя в базу данных
                if (currentUser) {
                    await database.saveUser(
                        currentUser.id,
                        currentUser.username || '',
                        currentUser.first_name || ''
                    );
                    console.log('Пользователь сохранен в базу данных');
                } else {
                    console.warn('Данные пользователя не найдены, но продолжаем...');
                }
                
                await updateStatus(databaseStatus, 'success', '✅', 'База данных подключена');
                
                // Проверка 2: Веб-приложение
                await updateStatus(appStatus, 'loading', '⏳', 'Проверка веб-приложения...');
                
                // Проверяем основные элементы приложения
                const mainApp = document.getElementById('mainApp');
                if (!mainApp) {
                    throw new Error('Основное приложение не найдено');
                }
                
                // Проверяем наличие ключевых элементов
                const chatModal = document.getElementById('chatModal');
                const userModal = document.getElementById('userModal');
                
                if (!chatModal || !userModal) {
                    throw new Error('Критические элементы интерфейса не найдены');
                }
                
                await updateStatus(appStatus, 'success', '✅', 'Веб-приложение готово');
                
                // Небольшая задержка для показа успешного статуса
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Проверяем согласие с политикой конфиденциальности
                if (!checkPrivacyConsent()) {
                    await showPrivacyPolicy();
                } else {
                    // Запускаем основное приложение
                    await launchMainApp();
                }
                
            } catch (error) {
                console.error('Ошибка при входе в приложение:', error);
                
                // Показываем ошибку в соответствующем статусе
                if (error.message.includes('база данных') || error.message.includes('Supabase')) {
                    await updateStatus(databaseStatus, 'error', '❌', `Ошибка БД: ${error.message}`);
                } else {
                    await updateStatus(appStatus, 'error', '❌', `Ошибка приложения: ${error.message}`);
                }
                
                // Разблокируем кнопку для повторной попытки
                enterButton.disabled = false;
                enterButton.style.opacity = '1';
            }
        }

        async function updateStatus(statusElement, type, icon, text) {
            const iconElement = statusElement.querySelector('.status-icon');
            const textElement = statusElement.querySelector('.status-text');
            
            // Убираем все классы
            statusElement.className = 'status-item';
            
            // Добавляем нужный класс
            if (type !== 'loading') {
                statusElement.classList.add(type);
            } else {
                statusElement.classList.add('loading');
            }
            
            iconElement.textContent = icon;
            textElement.textContent = text;
            
            // Небольшая задержка для визуального эффекта
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function launchMainApp() {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('Запускаем основное приложение...');
            
            // Анимация исчезновения экрана входа
            loginScreen.style.transition = 'opacity 1s ease, transform 1s ease';
            loginScreen.style.opacity = '0';
            loginScreen.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                loginScreen.style.display = 'none';
                
                // Показываем основное приложение
                mainApp.style.position = 'relative';
                mainApp.style.zIndex = '1';
                mainApp.style.transition = 'opacity 1s ease, transform 1s ease';
                mainApp.style.transform = 'scale(1.1)';
                
                setTimeout(() => {
                    mainApp.style.opacity = '1';
                    mainApp.style.transform = 'scale(1)';
                    
                    // Запускаем анимацию кнопок после появления приложения
                    setTimeout(() => {
                        animateMainAppButtons();
                    }, 500);
                }, 50);
            }, 1000);
        }

        function initializeMainApp() {
            // Создаем частицы
            createParticles();
            
            // Инициализируем настройки
            initializeSettings();
        }

        function animateMainAppButtons() {
            // Анимация кнопок при входе в приложение
            const buttons = document.querySelectorAll('.ai-button');
            buttons.forEach((button, index) => {
                button.style.opacity = '0';
                button.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    button.style.transition = 'all 0.5s ease';
                    button.style.opacity = '1';
                    button.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // Функции для работы с политикой конфиденциальности
        async function showPrivacyPolicy() {
            return new Promise((resolve) => {
                const privacyModal = document.getElementById('privacyModal');
                const privacyAcceptCheckbox = document.getElementById('privacyAccept');
                const privacyAcceptBtn = document.getElementById('privacyAcceptBtn');
                const privacyDeclineBtn = document.getElementById('privacyDecline');
                
                // Показываем модальное окно
                privacyModal.style.display = 'flex';
                
                // Обработчик изменения чекбокса
                privacyAcceptCheckbox.addEventListener('change', function() {
                    privacyAcceptBtn.disabled = !this.checked;
                });
                
                // Обработчик кнопки "Accept & Continue"
                privacyAcceptBtn.addEventListener('click', async function() {
                    if (privacyAcceptCheckbox.checked) {
                        // Сохраняем согласие в localStorage
                        localStorage.setItem('ai-tap-privacy-accepted', 'true');
                        localStorage.setItem('ai-tap-privacy-date', new Date().toISOString());
                        
                        // Скрываем модальное окно
                        privacyModal.style.display = 'none';
                        
                        console.log('✅ Пользователь принял политику конфиденциальности');
                        
                        // Запускаем основное приложение
                        await launchMainApp();
                        resolve();
                    }
                });
                
                // Обработчик кнопки "Decline"
                privacyDeclineBtn.addEventListener('click', function() {
                    // Показываем уведомление об отказе
                    alert('You must accept the Privacy Policy to use AI-TAP. The application will now close.');
                    
                    // Закрываем приложение (возвращаемся к экрану входа)
                    privacyModal.style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('statusContainer').style.display = 'none';
                    document.getElementById('enterButton').disabled = false;
                    document.getElementById('enterButton').textContent = 'Enter';
                    
                    console.log('❌ Пользователь отклонил политику конфиденциальности');
                    resolve();
                });
            });
        }

        // Функция для проверки срока действия согласия (опционально)
        function checkPrivacyConsent() {
            const privacyAccepted = localStorage.getItem('ai-tap-privacy-accepted');
            const privacyDate = localStorage.getItem('ai-tap-privacy-date');
            
            if (!privacyAccepted || !privacyDate) {
                return false;
            }
            
            // Проверяем, не прошло ли более года с момента согласия
            const consentDate = new Date(privacyDate);
            const currentDate = new Date();
            const oneYear = 365 * 24 * 60 * 60 * 1000; // миллисекунды в году
            
            if (currentDate - consentDate > oneYear) {
                // Согласие истекло, удаляем его
                localStorage.removeItem('ai-tap-privacy-accepted');
                localStorage.removeItem('ai-tap-privacy-date');
                return false;
            }
            
            return true;
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Начинаем инициализацию приложения...');
            
            // Проверяем подключение внешних файлов
            console.log('🔍 Проверяем подключение файлов...');
            console.log('Database класс доступен:', typeof Database !== 'undefined');
            console.log('ResponseCache класс доступен:', typeof ResponseCache !== 'undefined');
            
            try {
                // Инициализируем базу данных
                console.log('📊 Инициализируем базу данных...');
                await initializeDatabase();
                console.log('✅ База данных инициализирована');
                
                // Создаем частицы для экрана входа
                console.log('✨ Создаем частицы...');
                createLoginParticles();
                console.log('✅ Частицы созданы');
                
                // Инициализируем основное приложение в фоне
                console.log('🎯 Инициализируем основное приложение...');
                initializeMainApp();
                console.log('✅ Основное приложение инициализировано');
                
                console.log('🎉 Инициализация завершена успешно!');
                
            } catch (error) {
                console.error('❌ Ошибка инициализации:', error);
                console.error('Детали ошибки:', error.stack);
            }
        });

        // Функция инициализации настроек
        function initializeSettings() {
            // Инициализируем разрешения если их нет
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            if (Object.keys(permissions).length === 0) {
                const defaultPermissions = {
                    camera: false,
                    microphone: false,
                    files: true
                };
                localStorage.setItem('ai-tap-permissions', JSON.stringify(defaultPermissions));
                console.log('Инициализированы настройки разрешений по умолчанию');
            }
            
            // Инициализируем звук если не установлен
            if (localStorage.getItem('ai-tap-sound') === null) {
                localStorage.setItem('ai-tap-sound', 'true');
                console.log('Инициализированы настройки звука по умолчанию');
            }
            
            // Инициализация завершена
            
            
            console.log('Настройки инициализированы:', {
                permissions: JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}'),
                sound: localStorage.getItem('ai-tap-sound'),
                locationEnabled: locationEnabled,
                userLocation: userLocation
            });
        }

        // Обработчики закрытия модальных окон
        window.onclick = function(event) {
            // Закрытие модального окна пользователя при клике вне его
            const userModal = document.getElementById('userModal');
            if (event.target === userModal) {
                closeUserModal();
            }
            
            // Закрытие чата при клике вне его
            const chatModal = document.getElementById('chatModal');
            if (event.target === chatModal) {
                closeChat();
            }
            
            // Закрытие настроек при клике вне их
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettings();
            }
            
            // Закрытие главных настроек при клике вне их
            const mainSettingsModal = document.getElementById('mainSettingsModal');
            if (event.target === mainSettingsModal) {
                closeMainSettings();
            }
            
            // Закрытие погоды при клике вне её
            const weatherModal = document.getElementById('weatherModal');
            if (event.target === weatherModal) {
                closeWeatherModal();
            }
            
            // Закрытие новостей при клике вне их
            const newsModal = document.getElementById('newsModal');
            if (event.target === newsModal) {
                closeNewsModal();
            }
            
            // Закрытие статьи при клике вне её
            const articleModal = document.getElementById('articleModal');
            if (event.target === articleModal) {
                closeArticleModal();
            }
            
            // Закрытие админ панели при клике вне её
            const adminModal = document.getElementById('adminModal');
            if (event.target === adminModal) {
                closeAdminPanel();
            }
            
            // Закрытие управления пользователями при клике вне его
            const usersModal = document.getElementById('usersModal');
            if (event.target === usersModal) {
                closeUsersModal();
            }
            
            // Закрытие деталей пользователя при клике вне их
            const userDetailsModal = document.getElementById('userDetailsModal');
            if (event.target === userDetailsModal) {
                closeUserDetailsModal();
            }
            
            // Закрытие чата пользователя при клике вне его
            const userChatModal = document.getElementById('userChatModal');
            if (event.target === userChatModal) {
                closeUserChatModal();
            }
        };

        // Лишние функции удалены

    </script>
    </div> <!-- Закрытие mainApp -->
</body>
</html>
