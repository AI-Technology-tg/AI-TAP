<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portal - Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: white;
        }

        /* Контейнер для частиц */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(0, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: float 8s infinite linear;
        }

        .particle.small {
            width: 2px;
            height: 2px;
            box-shadow: 0 0 6px rgba(0, 255, 255, 0.8);
        }

        .particle.medium {
            width: 4px;
            height: 4px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        .particle.large {
            width: 6px;
            height: 6px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Геометрические фигуры */
        .geometric-shape {
            position: absolute;
            animation: geometricFloat 15s infinite ease-in-out;
            opacity: 0.1;
        }

        .geometric-shape.triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 26px solid rgba(0, 255, 255, 0.3);
        }

        .geometric-shape.square {
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
        }

        .geometric-shape.circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }

        @keyframes geometricFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
            }
            50% { 
                transform: translateY(-20px) rotate(180deg);
            }
        }

        /* Анимированный фон */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            animation: backgroundMove 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundMove {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-20px) translateY(-10px); }
            50% { transform: translateX(20px) translateY(10px); }
            75% { transform: translateX(-10px) translateY(20px); }
        }

        /* Заголовок с аватаром */
        .header {
            display: flex;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            margin-left: 15px;
            color: white;
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-id {
            font-size: 14px;
            opacity: 0.8;
        }

        .main-settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-panel-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: #8b4513;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .admin-panel-btn:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffc947 100%);
            border-color: rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }

        .language-selector {
            margin-left: 15px;
            position: relative;
        }

        .language-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .language-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .language-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 10px;
            padding: 10px 0;
            min-width: 150px;
            display: none;
            z-index: 9999;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .language-dropdown.show {
            display: block;
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-option {
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .language-option.active {
            background: rgba(102, 126, 234, 0.3);
        }

        /* Секция выбора языка в профиле */
        .language-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .language-section h3 {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .language-grid .language-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .language-grid .language-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .language-grid .language-option.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.6);
        }

        .language-grid .language-option span:first-child {
            font-size: 24px;
        }

        .language-grid .language-option span:last-child {
            font-size: 14px;
            font-weight: 500;
        }

        /* Модальное окно с данными пользователя */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            display: block;
        }

        /* Основной контент */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            position: relative;
            z-index: 10;
        }

        .title {
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            text-align: center;
            margin-bottom: 50px;
        }

        /* Новый дизайн главного меню */
        .main-ai-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 400px;
            width: 100%;
            margin-bottom: 30px;
        }

        .main-ai-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-ai-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .main-ai-card:active {
            transform: translateY(-2px);
        }

        .ai-card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .ai-card-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        /* Дополнительные функции */
        .additional-functions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 400px;
            width: 100%;
        }

        .function-button {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .function-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }

        .function-icon {
            font-size: 18px;
        }

        .function-text {
            white-space: nowrap;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.fade-out {
            opacity: 0;
            transform: translateX(400px);
        }

        /* Чат интерфейс */
        .chat-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .chat-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 2% auto;
            border-radius: 20px;
            width: 95%;
            height: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: chatSlideIn 0.3s ease-out;
        }

        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .chat-title::before {
            content: '🤖';
            margin-right: 10px;
            font-size: 28px;
        }

        .chat-close {
            color: white;
            font-size: 28px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-content {
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .typing-dots::after {
            content: '...';
            animation: typingDots 1.5s infinite;
        }

        @keyframes typingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .chat-input-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .send-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Скроллбар для чата */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Технологичный дизайн чата */
        .chat-container {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.2),
                inset 0 0 30px rgba(0, 255, 255, 0.1);
        }

        .chat-header {
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.05) 100%);
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-control-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .chat-control-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .connection-status {
            font-size: 12px;
            margin: 0 5px;
        }

        /* Стили для настроек */
        .settings-content {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
        }

        .settings-section h3 {
            color: #00ffff;
            margin: 0 0 15px 0;
            font-size: 16px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            color: #e0e0e0;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00ffff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .slider-container span {
            color: #00ffff;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .setting-item small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        /* Toggle switch */
        .toggle-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
            gap: 10px;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #00ffff;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(26px);
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Кнопки настроек */
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn.primary {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            border: 2px solid rgba(0, 255, 255, 0.4);
        }

        .settings-btn.primary:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
        }

        .settings-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .settings-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }


        .chat-title {
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            font-weight: 700;
        }

        .message {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
        }

        .message.user {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.4);
        }

        .message.ai {
            background: rgba(0, 255, 255, 0.05);
            border-color: rgba(0, 255, 255, 0.3);
        }

        .message-content {
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .chat-input {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #e0e0e0;
        }

        .chat-input:focus {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .chat-input::placeholder {
            color: rgba(224, 224, 224, 0.6);
        }

        .send-button {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.4);
            color: #00ffff;
        }

        .send-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .send-button.sending {
            animation: sendPulse 0.3s ease;
            transform: scale(0.95);
        }

        @keyframes sendPulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); box-shadow: 0 0 25px rgba(0, 255, 255, 0.8); }
            100% { transform: scale(0.95); }
        }

        .chat-input.typing {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.8);
        }

        /* Кнопка голосовых сообщений */
        .voice-button {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-right: 10px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .voice-button.recording {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.5);
            color: #ff0000;
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
        }

        .typing-indicator {
            color: rgba(0, 255, 255, 0.7);
            transition: all 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }

        /* Анимации загрузки - скелетоны */
        .skeleton {
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 25%, rgba(0, 255, 255, 0.2) 50%, rgba(0, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-message {
            height: 20px;
            margin: 5px 0;
            width: 80%;
        }

        .skeleton-message.short {
            width: 60%;
        }

        .skeleton-message.long {
            width: 90%;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: rgba(0, 255, 255, 0.7);
            border-radius: 50%;
            animation: loading-bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading-bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Улучшенный индикатор печати */
        .enhanced-typing {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            margin: 10px 0;
        }

        .typing-avatar {
            width: 30px;
            height: 30px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .ai-panel {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 24px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
        }

        .location-display {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .retry-location-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 6px;
            padding: 6px 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .retry-location-btn:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        /* Стили для разрешений */
        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .permission-item:last-child {
            border-bottom: none;
        }

        .permission-info {
            flex: 1;
        }

        .permission-title {
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .permission-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            line-height: 1.3;
        }

        /* Стили для модального окна погоды */
        .weather-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .weather-main {
            text-align: center;
        }

        .weather-location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .location-icon {
            font-size: 18px;
        }

        .location-text {
            color: white;
            font-weight: 500;
            font-size: 16px;
        }

        .weather-current {
            margin-bottom: 30px;
        }

        .weather-temp {
            font-size: 72px;
            font-weight: 300;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
        }

        .weather-desc {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .weather-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .weather-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .weather-value {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .weather-update {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
        }

        .weather-error, .weather-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .weather-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .weather-message {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .weather-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .weather-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .weather-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Стили для модального окна новостей */
        .news-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .news-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .news-main-title h2 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 5px 0;
        }

        .news-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0;
        }

        .news-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .refresh-news-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .refresh-news-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .refresh-news-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-news-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .next-update-info {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: right;
        }

        .news-item-compact {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .news-item-compact:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .news-item-compact:last-child {
            margin-bottom: 0;
        }

        .news-compact-header {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }

        .news-compact-image {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .news-compact-content {
            flex: 1;
            min-width: 0;
        }

        .news-compact-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-compact-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .news-compact-source {
            background: rgba(0, 255, 255, 0.2);
            color: rgba(0, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .news-compact-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        .news-compact-category {
            background: rgba(255, 215, 0, 0.2);
            color: rgba(255, 215, 0, 0.9);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .news-search {
            margin-bottom: 20px;
        }

        .search-section h3 {
            color: white;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }

        .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .news-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .news-input:focus {
            border-color: rgba(0, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .news-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .popular-locations {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .location-tag {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .location-tag:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .news-results {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .news-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .news-count {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .news-item-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 10px;
        }

        .news-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .news-item-content {
            flex: 1;
            min-width: 0;
        }

        .news-item-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-item-source {
            color: rgba(0, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
        }

        .news-item-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.4;
            margin-top: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-item-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .news-item-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .news-item-category {
            background: rgba(0, 255, 255, 0.2);
            color: rgba(0, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .news-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .news-error {
            text-align: center;
            padding: 40px 20px;
        }

        .news-error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .news-error-message {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .news-error-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        /* Стили для админ панели */
        .admin-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-menu-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
        }

        .admin-menu-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .admin-menu-text {
            flex: 1;
        }

        .admin-menu-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .admin-menu-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.4);
        }

        /* Стили для управления пользователями */
        .users-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }




        /* Все CSS стили управления пользователями удалены */


        /* Все CSS стили управления пользователями удалены */

        /* Стили для модального окна статьи */
        .article-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .article-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .article-source {
            background: rgba(0, 255, 255, 0.2);
            color: rgba(0, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .article-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .article-category {
            background: rgba(255, 215, 0, 0.2);
            color: rgba(255, 215, 0, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .article-main-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 15px;
        }

        .article-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .article-description {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .article-body {
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 25px;
        }

        .article-actions {
            display: flex;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .article-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .article-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .article-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .article-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .article-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .article-error {
            text-align: center;
            padding: 40px 20px;
        }

        .article-error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .article-error-message {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .article-error-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Селектор режимов ИИ */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .mode-option {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .mode-option.active {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .mode-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .mode-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mode-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            line-height: 1.3;
        }

        /* Стили для кнопки прикрепления */
        .attach-button {
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid rgba(0, 255, 255, 0.4);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .attach-button:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .attach-button:active {
            transform: scale(0.95);
        }

        /* Панель прикрепления */
        .attach-menu {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: rgba(15, 15, 35, 0.95);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attach-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .attach-option:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .attach-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .attach-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* Стили для файловых сообщений */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            max-width: 300px;
        }

        .file-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            color: white;
            font-weight: 500;
            font-size: 14px;
            word-break: break-word;
            margin-bottom: 4px;
        }

        .file-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        /* Стили экрана входа */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
        }

        .login-container {
            text-align: center;
            z-index: 2;
            max-width: 500px;
            padding: 40px;
        }

        .login-logo {
            margin-bottom: 40px;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        .logo-text {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00d4ff, #0099cc, #0066ff, #00d4ff);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            letter-spacing: 8px;
        }

        .logo-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .login-description {
            margin: 40px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .login-description p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 10px 0;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .enter-button {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #0066ff 100%);
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            animation: buttonPulse 2s ease-in-out infinite;
        }

        .enter-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.5);
        }

        .enter-button:active {
            transform: translateY(-1px);
        }

        .enter-text {
            position: relative;
            z-index: 2;
        }

        .enter-glow {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: buttonGlow 3s infinite;
        }

        .login-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .login-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00d4ff;
            border-radius: 50%;
            opacity: 0.7;
            animation: particleFloat 6s infinite linear;
            box-shadow: 0 0 10px #00d4ff;
        }

        .status-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .status-icon {
            font-size: 1.2rem;
            margin-right: 15px;
            min-width: 25px;
        }

        .status-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .status-item.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-item.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-item.loading .status-icon {
            animation: spin 1s linear infinite;
        }

        /* Анимации */
        @keyframes logoGlow {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            }
            50% {
                box-shadow: 0 15px 40px rgba(0, 212, 255, 0.6);
            }
        }

        @keyframes buttonGlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            .login-container {
                padding: 20px;
            }
            
            .logo-text {
                font-size: 3rem;
                letter-spacing: 4px;
            }
            
            .logo-subtitle {
                font-size: 1rem;
                letter-spacing: 2px;
            }
            
            .login-description p {
                font-size: 1rem;
            }
            
            .enter-button {
                padding: 15px 30px;
                font-size: 1.1rem;
            }
        }

    </style>
    
    <!-- Подключение к базе данных -->
    <script src="database.js"></script>
    <script src="cache.js"></script>
</head>
<body>
    <!-- Экран входа -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-text">AI-TAP</div>
                <div class="logo-subtitle">Искусственный интеллект</div>
            </div>
            
            <div class="login-description">
                <p>Добро пожаловать в мир искусственного интеллекта!</p>
                <p>Общайтесь с ИИ, получайте новости и прогноз погоды</p>
            </div>
            
            <button id="enterButton" class="enter-button" onclick="handleEnterApp()">
                <span class="enter-text">🚀 Войти в приложение</span>
                <div class="enter-glow"></div>
            </button>
            
            <!-- Статус проверки -->
            <div id="statusContainer" class="status-container" style="display: none;">
                <div class="status-item" id="databaseStatus">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Проверка базы данных...</span>
                </div>
                <div class="status-item" id="appStatus">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Проверка веб-приложения...</span>
                </div>
            </div>
        </div>
        
        <div class="login-particles" id="loginParticles"></div>
    </div>

    <!-- Основное приложение (скрыто при загрузке) -->
    <div id="mainApp" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">
        <!-- Анимированный фон с частицами -->
        <div class="particles-container" id="particlesContainer"></div>
        
        <!-- Геометрические фигуры -->
        <div class="geometric-shape triangle" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
        <div class="geometric-shape square" style="top: 20%; right: 15%; animation-delay: 2s;"></div>
        <div class="geometric-shape circle" style="bottom: 30%; left: 20%; animation-delay: 4s;"></div>
        <div class="geometric-shape triangle" style="bottom: 10%; right: 10%; animation-delay: 6s;"></div>
        <div class="geometric-shape square" style="top: 60%; left: 80%; animation-delay: 8s;"></div>
        <div class="geometric-shape circle" style="top: 80%; right: 70%; animation-delay: 10s;"></div>

    <!-- Заголовок с аватаром -->
    <div class="header">
        <img id="userAvatar" class="user-avatar" src="" alt="Avatar" onclick="showUserInfo()">
        <div class="user-info">
            <div id="userName" class="user-name">Загрузка...</div>
            <div id="userId" class="user-id">ID: ...</div>
        </div>
        <div class="header-buttons">
            <button id="adminPanelBtn" class="admin-panel-btn" onclick="openAdminPanel()" title="Админ панель" style="display: none;">👑</button>
            <button class="main-settings-btn" onclick="openMainSettings()" title="Настройки приложения">⚙️</button>
        </div>
    </div>

    <!-- Модальное окно с данными пользователя -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserInfo()">&times;</span>
            <img id="modalAvatar" class="modal-avatar" src="" alt="Avatar">
            <h2 id="modalName">Имя пользователя</h2>
            <p id="modalId">ID: ...</p>
            <p id="modalUsername">@username</p>
            
            <div class="language-section">
                <h3>Выбор языка / Language Selection</h3>
                <div class="language-grid">
                    <div class="language-option active" onclick="changeLanguage('ru')">
                        <span>🇷🇺</span>
                        <span>Русский</span>
                    </div>
                    <div class="language-option" onclick="changeLanguage('en')">
                        <span>🇺🇸</span>
                        <span>English</span>
                    </div>
                    <div class="language-option" onclick="changeLanguage('de')">
                        <span>🇩🇪</span>
                        <span>Deutsch</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
        <h1 class="title">AI-TAP</h1>
        <p class="subtitle">Выберите ИИ для ваших задач</p>
        
        <!-- Основные функции ИИ -->
        <div class="main-ai-grid">
            <div class="main-ai-card" onclick="openMainAI()">
                <div class="ai-card-icon">🤖</div>
                <div class="ai-card-title">Основной ИИ</div>
            </div>
            <div class="main-ai-card" onclick="showNotification(t('imageGenNotification'))">
                <div class="ai-card-icon">🎨</div>
                <div class="ai-card-title">Генератор изображений</div>
            </div>
        </div>

        <!-- Дополнительные функции -->
        <div class="additional-functions">
            <div class="function-button" onclick="showWeather()">
                <span class="function-icon">🌤️</span>
                <span class="function-text">Погода</span>
            </div>
            <div class="function-button" onclick="showNews()">
                <span class="function-icon">📰</span>
                <span class="function-text">Новости</span>
            </div>
        </div>
    </div>

    <!-- Чат с Основным ИИ -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">Основной ИИ</div>
                <div class="chat-controls">
                    <button class="chat-control-btn" onclick="clearChatHistory()" title="Очистить историю">🗑️</button>
                    <button class="chat-control-btn" onclick="toggleAISettings()" title="Настройки ИИ">⚙️</button>
                    <span class="connection-status" id="connectionStatus" title="Статус подключения">🟢</span>
                    <span class="chat-close" onclick="closeChat()">&times;</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Привет! Я Основной ИИ. К сожалению, я пока в разработке, но скоро буду готов помочь!
                    </div>
                    <div class="message-time" id="welcomeTime"></div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="enhanced-typing">
                    <div class="typing-avatar">🤖</div>
                    <div>
                        <span id="typingText">ИИ печатает</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Напишите сообщение..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button" onclick="sendMessage()">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Модальное окно настроек -->
    <div id="settingsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">⚙️ Настройки ИИ</div>
                <span class="chat-close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="settings-section">
                    <h3>🤖 Параметры ИИ</h3>
                    <div class="setting-item">
                        <label>Режим ответов:</label>
                        <div class="mode-selector">
                            <div class="mode-option" data-mode="precise" onclick="selectMode('precise')">
                                <div class="mode-icon">🎯</div>
                                <div class="mode-name">Точный</div>
                                <div class="mode-desc">Краткие и точные ответы</div>
                            </div>
                            <div class="mode-option active" data-mode="smart" onclick="selectMode('smart')">
                                <div class="mode-icon">🧠</div>
                                <div class="mode-name">Умный</div>
                                <div class="mode-desc">Сбалансированные ответы</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔊 Звуковые эффекты</h3>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="toggle-slider"></span>
                            Включить звуки
                        </label>
                        <small>Звуки отправки и получения сообщений</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>📊 Статистика</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="statMessages">0</div>
                            <div class="stat-label">Сообщений</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="statDays">0</div>
                            <div class="stat-label">Дней общения</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="statFacts">0</div>
                            <div class="stat-label">Фактов запомнено</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveSettings()">💾 Сохранить</button>
                    <button class="settings-btn secondary" onclick="resetSettings()">🔄 Сбросить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Главные настройки приложения -->
    <div id="mainSettingsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">⚙️ Настройки приложения</div>
                <span class="chat-close" onclick="closeMainSettings()">&times;</span>
            </div>
            <div class="settings-content" id="mainSettingsContent">
                <div class="settings-section">
                    <h3>📍 Геолокация</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Местоположение</div>
                            <div class="permission-desc">Для показа погоды и локальной информации</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="mainLocationToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" id="mainLocationInfo" style="display: none;">
                        <div class="location-display">
                            <span id="mainCurrentLocation">Местоположение не определено</span>
                            <button class="retry-location-btn" onclick="retryLocation()" title="Обновить местоположение">🔄</button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>📱 Мультимедиа</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Камера</div>
                            <div class="permission-desc">Для отправки фото и видео</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="cameraToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Микрофон</div>
                            <div class="permission-desc">Для голосовых сообщений</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="microphoneToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Файлы</div>
                            <div class="permission-desc">Для отправки документов и медиа</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="filesToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔊 Звуковые эффекты</h3>
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-title">Звуки уведомлений</div>
                            <div class="permission-desc">Звуки отправки и получения сообщений</div>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="mainSoundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveMainSettings()">💾 Сохранить</button>
                    <button class="settings-btn secondary" onclick="resetMainSettings()">🔄 Сбросить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно погоды -->
    <div id="weatherModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">🌤️ Погода</div>
                <span class="chat-close" onclick="closeWeatherModal()">&times;</span>
            </div>
            <div id="weatherContent" class="weather-content">
                <!-- Контент загружается динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно новостей -->
    <div id="newsModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">📰 Новости</div>
                <span class="chat-close" onclick="closeNewsModal()">&times;</span>
            </div>
            <div id="newsContent" class="news-content">
                <div class="news-header-section">
                    <div class="news-main-title">
                        <h2>📰 Свежие новости</h2>
                        <p class="news-subtitle">3 самые актуальные новости</p>
                    </div>
                    <div class="news-controls">
                        <button id="refreshNewsBtn" class="refresh-news-btn" onclick="refreshNews()">
                            <span class="refresh-icon">🔄</span>
                            <span class="refresh-text">Обновить</span>
                        </button>
                        <div id="nextUpdateInfo" class="next-update-info"></div>
                    </div>
                </div>
                
                <div class="news-search">
                    <div class="search-section">
                        <h3>🌍 Выберите регион</h3>
                        <div class="popular-locations">
                            <div class="location-tag" onclick="selectNewsLocation('Россия')">🇷🇺 Россия</div>
                            <div class="location-tag" onclick="selectNewsLocation('США')">🇺🇸 США</div>
                            <div class="location-tag" onclick="selectNewsLocation('Германия')">🇩🇪 Германия</div>
                            <div class="location-tag" onclick="selectNewsLocation('Франция')">🇫🇷 Франция</div>
                            <div class="location-tag" onclick="selectNewsLocation('Мир')">🌎 Мир</div>
                        </div>
                    </div>
                </div>
                
                <div id="newsResults" class="news-results">
                    <!-- Результаты новостей загружаются динамически -->
                </div>
            </div>
        </div>
    </div>

    <!-- Админ панель -->
    <div id="adminModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">👑 Админ панель</div>
                <span class="chat-close" onclick="closeAdminPanel()">&times;</span>
            </div>
            <div id="adminContent" class="admin-content">
                <div class="admin-menu">
                    <div class="admin-menu-item" onclick="showNotification('👥 Пользователи - в разработке')">
                        <div class="admin-menu-icon">👥</div>
                        <div class="admin-menu-text">
                            <div class="admin-menu-title">Пользователи</div>
                            <div class="admin-menu-desc">Управление пользователями</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Модальное окно статьи -->
    <div id="articleModal" class="chat-modal" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title" id="articleTitle">📰 Статья</div>
                <span class="chat-close" onclick="closeArticleModal()">&times;</span>
            </div>
            <div id="articleContent" class="article-content">
                <!-- Содержимое статьи загружается динамически -->
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification"></div>

    <script>
        // Система переводов
        const translations = {
            ru: {
                loading: 'Загрузка...',
                userId: 'ID: ...',
                welcome: 'Добро пожаловать!',
                aiPortal: 'AI-TAP',
                selectAi: 'Выберите ИИ для ваших задач',
                mainAi: 'Основной ИИ',
                mainDescription: 'Универсальный помощник для любых задач',
                imageGen: 'Генератор изображений',
                imageDescription: 'Создание уникальных изображений по описанию',
                inDevelopment: 'в разработке',
                mainAiNotification: 'Основной ИИ - в разработке',
                imageGenNotification: 'Генератор изображений - в разработке',
                chatWelcome: 'Привет! Я Основной ИИ. К сожалению, я пока в разработке, но скоро буду готов помочь!',
                chatPlaceholder: 'Напишите сообщение...',
                chatTyping: 'ИИ печатает',
                chatResponse: 'Извините, я пока в разработке. Скоро буду готов помочь вам!',
                chatTitle: 'ИИ Ассистент',
                chatWelcome: 'Привет! Я ваш ИИ ассистент. Чем могу помочь?',
                typing: 'ИИ печатает',
                placeholder: 'Напишите сообщение...',
                error: 'Извините, произошла ошибка при обработке вашего сообщения. Попробуйте еще раз.',
                close: 'Закрыть'
            },
            en: {
                loading: 'Loading...',
                userId: 'ID: ...',
                welcome: 'Welcome!',
                aiPortal: 'AI-TAP',
                selectAi: 'Choose AI for your tasks',
                mainAi: 'Main AI',
                mainDescription: 'Universal assistant for any tasks',
                imageGen: 'Image Generator',
                imageDescription: 'Creating unique images from descriptions',
                inDevelopment: 'in development',
                mainAiNotification: 'Main AI - in development',
                imageGenNotification: 'Image Generator - in development',
                chatWelcome: 'Hello! I am Main AI. Unfortunately, I am still in development, but I will be ready to help soon!',
                chatPlaceholder: 'Write a message...',
                chatTyping: 'AI is typing',
                chatResponse: 'Sorry, I am still in development. I will be ready to help you soon!',
                chatTitle: 'AI Assistant',
                chatWelcome: 'Hello! I am your AI assistant. How can I help?',
                typing: 'AI is typing',
                placeholder: 'Write a message...',
                error: 'Sorry, an error occurred while processing your message. Please try again.',
                close: 'Close'
            },
            de: {
                loading: 'Laden...',
                userId: 'ID: ...',
                welcome: 'Willkommen!',
                aiPortal: 'KI Portal',
                selectAi: 'Wählen Sie KI für Ihre Aufgaben',
                mainAi: 'Haupt-KI',
                mainDescription: 'Universeller Assistent für alle Aufgaben',
                imageGen: 'Bildgenerator',
                imageDescription: 'Erstellung einzigartiger Bilder aus Beschreibungen',
                inDevelopment: 'in Entwicklung',
                mainAiNotification: 'Haupt-KI - in Entwicklung',
                imageGenNotification: 'Bildgenerator - in Entwicklung',
                chatWelcome: 'Hallo! Ich bin Haupt-KI. Leider bin ich noch in Entwicklung, aber ich werde bald bereit sein zu helfen!',
                chatPlaceholder: 'Nachricht schreiben...',
                chatTyping: 'KI tippt',
                chatResponse: 'Entschuldigung, ich bin noch in Entwicklung. Ich werde bald bereit sein, Ihnen zu helfen!',
                chatTitle: 'KI Assistent',
                chatWelcome: 'Hallo! Ich bin Ihr KI-Assistent. Wie kann ich helfen?',
                typing: 'KI tippt',
                placeholder: 'Nachricht schreiben...',
                error: 'Entschuldigung, ein Fehler ist beim Verarbeiten Ihrer Nachricht aufgetreten. Versuchen Sie es erneut.',
                close: 'Schließen'
            }
        };

        // Текущий язык
        let currentLanguage = localStorage.getItem('ai-tap-language') || 'ru';
        
        // Конфигурация Groq AI API
        const GROQ_API_KEY = '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';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        
        // Хранилище текущих новостей
        let currentNewsData = [];
        
        // Память для чата
        let chatHistory = JSON.parse(localStorage.getItem('ai-tap-chat-history') || '[]');
        
        // Звуковые уведомления
        const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
        
        // Оптимизированный звук получения сообщения
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Убеждаемся что контекст активен
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Более приятный звук уведомления
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator.frequency.setValueAtTime(1108, audioContext.currentTime + 0.1); // C#6
                oscillator.frequency.setValueAtTime(1319, audioContext.currentTime + 0.2); // E6
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
                
            } catch (error) {
                console.log('Звук недоступен:', error);
            }
        }


        // Оптимизированный звук отправки сообщения
        function playSendSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Убеждаемся что контекст активен
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Визуальный эффект для кнопки отправки
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.classList.add('sending');
                    setTimeout(() => {
                        sendButton.classList.remove('sending');
                    }, 300);
                }
                
                // Простой и надежный звук отправки
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
                oscillator.frequency.linearRampToValueAtTime(784, audioContext.currentTime + 0.1); // G5
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
            } catch (error) {
                console.log('Звук отправки недоступен:', error);
            }
        }

        // Виброотклик для мобильных устройств
        function triggerVibration() {
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]); // Короткий-пауза-короткий
            }
        }

        // Полноэкранный режим
        function enableFullscreen() {
            // Скрываем адресную строку на мобильных
            if (window.innerHeight < window.innerWidth) return; // Не для ландшафта
            
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
            
            // Добавляем мета-тег для полноэкранного режима
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
            }
        }

        // Оптимизация клавиатуры
        function optimizeKeyboard() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            
            // Автофокус при открытии чата на мобильных
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    chatInput.focus();
                    // Прокручиваем к полю ввода
                    chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
            
            // Обработка появления/скрытия клавиатуры
            let initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            
            function handleViewportChange() {
                if (!window.visualViewport) return;
                
                const currentHeight = window.visualViewport.height;
                const heightDifference = initialViewportHeight - currentHeight;
                
                // Если клавиатура открыта (высота уменьшилась значительно)
                if (heightDifference > 150) {
                    document.body.style.paddingBottom = heightDifference + 'px';
                    // Прокручиваем к полю ввода
                    setTimeout(() => {
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 100);
                } else {
                    document.body.style.paddingBottom = '0px';
                }
            }
            
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', handleViewportChange);
            }
        }

        // Функция получения перевода
        function t(key) {
            return translations[currentLanguage][key] || translations['ru'][key] || key;
        }

        // Функция обновления интерфейса
        function updateInterface() {
            // НЕ обновляем данные пользователя, только интерфейс
            document.querySelector('.title').textContent = t('aiPortal');
            document.querySelector('.subtitle').textContent = t('selectAi');
            
            // Обновляем кнопки AI
            const buttons = document.querySelectorAll('.ai-button');
            const titles = [t('mainAi'), t('imageGen')];
            const descriptions = [t('mainDescription'), t('imageDescription')];
            
            buttons.forEach((button, index) => {
                button.querySelector('.ai-title').textContent = titles[index];
                button.querySelector('.ai-description').textContent = descriptions[index];
            });
        }

        // Функции для работы с языками
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('ai-tap-language', lang);
            updateInterface();
            
            // Обновляем активную опцию в профиле
            document.querySelectorAll('.language-grid .language-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.language-option').classList.add('active');
            
            // Показываем уведомление об изменении языка
            showNotification(`Язык изменен на ${getLanguageName(lang)}`);
        }

        function getLanguageName(lang) {
            const names = {'ru': 'Русский', 'en': 'English', 'es': 'Español', 'fr': 'Français', 'de': 'Deutsch', 'zh': '中文'};
            return names[lang] || 'Русский';
        }

        // Инициализация Telegram Web App (перенесено в админ систему)
        // const tg = window.Telegram.WebApp;
        // tg.ready();
        
        // Инициализация интерфейса при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Обновляем интерфейс на сохраненном языке
            updateInterface();
            
            // Восстанавливаем активный язык в профиле
            document.querySelectorAll('.language-grid .language-option').forEach(option => {
                option.classList.remove('active');
                if (option.onclick.toString().includes(`'${currentLanguage}'`)) {
                    option.classList.add('active');
                }
            });
        });

        // Инициализация пользователя перенесена в админ систему

        // Функции для работы с модальным окном
        function showUserInfo() {
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserInfo() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            const chatModal = document.getElementById('chatModal');
            const settingsModal = document.getElementById('settingsModal');
            const mainSettingsModal = document.getElementById('mainSettingsModal');
            const weatherModal = document.getElementById('weatherModal');
            const newsModal = document.getElementById('newsModal');
            const articleModal = document.getElementById('articleModal');
            const adminModal = document.getElementById('adminModal');
            
            if (event.target === userModal) {
                userModal.style.display = 'none';
            }
            if (event.target === chatModal) {
                chatModal.style.display = 'none';
            }
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target === mainSettingsModal) {
                mainSettingsModal.style.display = 'none';
            }
            if (event.target === weatherModal) {
                weatherModal.style.display = 'none';
            }
            if (event.target === newsModal) {
                newsModal.style.display = 'none';
            }
            if (event.target === articleModal) {
                articleModal.style.display = 'none';
            }
            if (event.target === adminModal) {
                adminModal.style.display = 'none';
            }
        }

        // Функция показа уведомлений
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('fade-out');
            notification.classList.add('show');
            
            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('fade-out');
                
                // Полное удаление после анимации
                setTimeout(() => {
                    notification.classList.remove('fade-out');
                    notification.textContent = '';
                }, 300);
            }, 3000);
        }

        // Функции для чата с Основным ИИ
        function openMainAI() {
            document.getElementById('chatModal').style.display = 'block';
            
            // Восстанавливаем чат из истории
            restoreChatHistory();
            
            // Обновляем интерфейс чата на текущем языке
            updateChatInterface();
            
            // Обновляем кнопку геолокации
            updateLocationButton();
            
            // Мобильные оптимизации
            enableFullscreen();
            optimizeKeyboard();
            
            // Виброотклик при открытии
            triggerVibration();
            
            // Проверяем актуальность погоды и местоположения
            checkLocationUpdate();
            checkWeatherUpdate();
        }
        
        // Функция восстановления истории чата
        function restoreChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatHistory.length === 0) {
                // Если истории нет, показываем приветствие
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            ${t('chatWelcome')}
                        </div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
            } else {
                // Восстанавливаем всю историю чата
                chatMessages.innerHTML = '';
                
                chatHistory.forEach((msg, index) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
                    
                    // Используем сохраненное время или текущее
                    const messageTime = msg.timestamp || getCurrentTime();
                    
                    messageDiv.innerHTML = `
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${messageTime}</div>
                    `;
                    
                    chatMessages.appendChild(messageDiv);
                });
                
                // Прокручиваем к последнему сообщению
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function closeChat() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function updateChatInterface() {
            // Обновляем заголовок
            document.querySelector('.chat-title').textContent = t('mainAi');
            
            // Обновляем приветственное сообщение
            const welcomeMessage = document.querySelector('.chat-messages .message.ai .message-content');
            if (welcomeMessage) {
                welcomeMessage.textContent = t('chatWelcome');
            }
            
            // Обновляем плейсхолдер
            document.getElementById('chatInput').placeholder = t('chatPlaceholder');
            
            // Обновляем индикатор печати
            document.getElementById('typingText').textContent = t('chatTyping');
            
            // Устанавливаем время приветственного сообщения
            document.getElementById('welcomeTime').textContent = getCurrentTime();
        }

        // Функция очистки истории чата
        function clearChatHistory() {
            if (confirm('Вы уверены, что хотите очистить всю историю чата?')) {
                chatHistory = [];
                localStorage.removeItem('ai-tap-chat-history');
                
                // Очищаем интерфейс чата
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            ${t('chatWelcome')}
                        </div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
                
                showNotification('История чата очищена');
                playNotificationSound();
            }
        }

        // Настройки ИИ
        let aiSettings = JSON.parse(localStorage.getItem('ai-tap-settings') || '{"mode": "smart", "maxTokens": 300}');
        
        // Память персонажа ИИ
        let aiMemory = JSON.parse(localStorage.getItem('ai-tap-memory') || '{}');
        
        // Геолокация
        let userLocation = JSON.parse(localStorage.getItem('ai-tap-location') || 'null');
        let locationEnabled = localStorage.getItem('ai-tap-location-enabled') === 'true';
        
        // Погода и контекстные данные
        let currentWeather = null;
        let lastWeatherUpdate = null;
        
        // Новости и их кэширование
        let cachedNews = JSON.parse(localStorage.getItem('ai-tap-cached-news') || 'null');
        let lastNewsUpdate = localStorage.getItem('ai-tap-last-news-update') ? new Date(localStorage.getItem('ai-tap-last-news-update')) : null;
        
        // Неиспользуемые переменные удалены
        
        
        // Инициализация памяти ИИ
        if (!aiMemory.userPreferences) {
            aiMemory = {
                userPreferences: {},
                conversationStyle: 'friendly',
                rememberedFacts: [],
                interactionCount: 0,
                lastInteraction: null,
                favoriteTopics: [],
                userMood: 'neutral'
            };
        }
        
        function updateAIMemory(key, value) {
            aiMemory[key] = value;
            localStorage.setItem('ai-tap-memory', JSON.stringify(aiMemory));
        }
        
        function addRememberedFact(fact) {
            if (!aiMemory.rememberedFacts.includes(fact)) {
                aiMemory.rememberedFacts.push(fact);
                if (aiMemory.rememberedFacts.length > 20) {
                    aiMemory.rememberedFacts.shift(); // Ограничиваем до 20 фактов
                }
                updateAIMemory('rememberedFacts', aiMemory.rememberedFacts);
            }
        }
        
        function getPersonalizedSystemPrompt() {
            const language = currentLanguage === 'ru' ? 'русском' : currentLanguage === 'en' ? 'английском' : currentLanguage === 'es' ? 'испанском' : currentLanguage === 'fr' ? 'французском' : currentLanguage === 'de' ? 'немецком' : currentLanguage === 'zh' ? 'китайском' : 'русском';
            
            let prompt = `Ты полезный AI ассистент. Отвечай на языке: ${language}. `;
            
            // Добавляем информацию о стиле общения
            if (aiMemory.conversationStyle === 'formal') {
                prompt += 'Общайся формально и профессионально. ';
            } else if (aiMemory.conversationStyle === 'casual') {
                prompt += 'Общайся неформально и дружелюбно. ';
            } else {
                prompt += 'Будь дружелюбным и полезным. ';
            }
            
            // Добавляем запомненные факты
            if (aiMemory.rememberedFacts.length > 0) {
                prompt += `Помни эти факты о пользователе: ${aiMemory.rememberedFacts.join(', ')}. `;
            }
            
            // Добавляем любимые темы
            if (aiMemory.favoriteTopics.length > 0) {
                prompt += `Пользователь интересуется: ${aiMemory.favoriteTopics.join(', ')}. `;
            }
            
            // Учитываем количество взаимодействий
            if (aiMemory.interactionCount > 10) {
                prompt += 'Мы уже хорошо знакомы, можешь быть более неформальным. ';
            }
            
            // Добавляем информацию о времени
            const now = new Date();
            const timeStr = now.toLocaleString('ru-RU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZoneName: 'short'
            });
            prompt += `Сейчас ${timeStr}. `;
            
            // Добавляем информацию о местоположении и погоде
            if (locationEnabled && userLocation) {
                prompt += `Пользователь находится в городе ${userLocation.city || 'неизвестном'}, страна: ${userLocation.country || 'неизвестна'}. `;
                
                if (currentWeather) {
                    prompt += `Погода: ${currentWeather.description}, температура ${currentWeather.temp}°C, ощущается как ${currentWeather.feels_like}°C, влажность ${currentWeather.humidity}%. `;
                }
            }
            
            // Добавляем информацию о настроении пользователя
            if (aiMemory.userMood) {
                const moodDescriptions = {
                    'positive': 'позитивном',
                    'negative': 'грустном/расстроенном', 
                    'curious': 'любопытном',
                    'neutral': 'нейтральном'
                };
                prompt += `Текущее настроение пользователя: ${moodDescriptions[aiMemory.userMood] || 'неопределенное'}. `;
            }
            
            // Добавляем информацию об активности
            if (aiMemory.activityStats) {
                const today = new Date().toDateString();
                const todayStats = aiMemory.activityStats[today];
                if (todayStats) {
                    prompt += `Сегодня пользователь написал ${todayStats.messages} сообщений, проводит в чате ${todayStats.timeSpent} минут. `;
                }
            }
            
            // Важные инструкции для ИИ
            prompt += 'ВАЖНО: Если пользователь спрашивает о погоде, скажи ему что можно посмотреть актуальную погоду в главном меню приложения, нажав на кнопку "Погода". Ты не можешь обрабатывать голосовые сообщения или файлы - работаешь только с текстом. ';
            
            return prompt;
        }

        // Функции геолокации
        function toggleLocation() {
            if (locationEnabled) {
                // Отключаем геолокацию
                locationEnabled = false;
                userLocation = null;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                localStorage.removeItem('ai-tap-location');
                updateLocationButton();
                showNotification('Геолокация отключена');
            } else {
                // Включаем геолокацию
                requestLocation();
            }
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showNotification('Геолокация не поддерживается браузером');
                locationEnabled = false;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                updateLocationSettings();
                return;
            }

            // Сначала устанавливаем флаг, что пользователь хочет включить геолокацию
            locationEnabled = true;
            localStorage.setItem('ai-tap-location-enabled', 'true');
            updateLocationSettings();

            showNotification('Запрашиваем местоположение...');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        // Получаем информацию о городе через обратное геокодирование
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ru`);
                        const data = await response.json();
                        
                        userLocation = {
                            latitude: lat,
                            longitude: lon,
                            city: data.city || data.locality || 'Неизвестный город',
                            country: data.countryName || 'Неизвестная страна',
                            region: data.principalSubdivision || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        localStorage.setItem('ai-tap-location', JSON.stringify(userLocation));
                        updateLocationSettings();
                        showNotification(`✅ Местоположение: ${userLocation.city}, ${userLocation.country}`);
                        
                        // Получаем погоду для этого местоположения
                        getWeatherData(lat, lon);
                        
                    } catch (error) {
                        console.error('Ошибка геокодирования:', error);
                        userLocation = {
                            latitude: lat,
                            longitude: lon,
                            city: 'Неизвестный город',
                            country: 'Неизвестная страна',
                            timestamp: new Date().toISOString()
                        };
                        
                        localStorage.setItem('ai-tap-location', JSON.stringify(userLocation));
                        updateLocationSettings();
                        showNotification('✅ Местоположение получено (координаты)');
                    }
                },
                (error) => {
                    console.error('Ошибка геолокации:', error);
                    let errorMessage = 'Ошибка получения местоположения';
                    let shouldDisable = false;
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '❌ Доступ к геолокации запрещен. Разрешите доступ в браузере.';
                            shouldDisable = true;
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '⚠️ Местоположение недоступно. Попробуйте позже.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '⏱️ Таймаут запроса. Геолокация остается включенной, попробуйте позже.';
                            // НЕ отключаем геолокацию при таймауте
                            break;
                    }
                    
                    showNotification(errorMessage);
                    
                    // Отключаем только при отказе в доступе
                    if (shouldDisable) {
                        locationEnabled = false;
                        localStorage.setItem('ai-tap-location-enabled', 'false');
                        updateLocationSettings();
                    }
                },
                {
                    enableHighAccuracy: false, // Менее точно, но быстрее
                    timeout: 15000, // Увеличиваем таймаут до 15 секунд
                    maximumAge: 600000 // 10 минут кэш
                }
            );
        }

        function updateLocationButton() {
            const btn = document.getElementById('locationBtn');
            if (btn) {
                if (locationEnabled && userLocation) {
                    btn.textContent = '📍';
                    btn.style.color = '#00ff00';
                    btn.title = `Геолокация: ${userLocation.city}`;
                } else {
                    btn.textContent = '📍';
                    btn.style.color = '#ffffff';
                    btn.title = 'Включить геолокацию';
                }
            }
        }

        function updateLocationSettings() {
            // Обновляем переключатель в настройках чата (если есть)
            const locationToggle = document.getElementById('locationToggle');
            if (locationToggle) {
                locationToggle.checked = locationEnabled;
            }
            
            // Обновляем переключатель в главных настройках
            const mainLocationToggle = document.getElementById('mainLocationToggle');
            if (mainLocationToggle) {
                mainLocationToggle.checked = locationEnabled;
            }
            
            // Обновляем информацию о местоположении в настройках чата
            const locationInfo = document.getElementById('locationInfo');
            const currentLocation = document.getElementById('currentLocation');
            
            if (locationEnabled && userLocation) {
                if (locationInfo) locationInfo.style.display = 'block';
                if (currentLocation) {
                    currentLocation.textContent = `${userLocation.city || 'Неизвестный город'}, ${userLocation.country || 'Неизвестная страна'}`;
                }
            } else if (locationEnabled && !userLocation) {
                if (locationInfo) locationInfo.style.display = 'block';
                if (currentLocation) {
                    currentLocation.textContent = 'Получение местоположения...';
                }
            } else {
                if (locationInfo) locationInfo.style.display = 'none';
            }
            
            // Обновляем главные настройки
            updateMainLocationDisplay();
            
            // Обновляем кнопку геолокации
            updateLocationButton();
        }

        // Функция получения погоды
        async function getWeatherData(lat, lon) {
            try {
                // Используем WeatherAPI с вашим ключом
                const API_KEY = '610a77b9596a4fc18a440047250210';
                const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${lat},${lon}&lang=ru&aqi=no`);
                
                if (!response.ok) {
                    throw new Error(`WeatherAPI error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Данные погоды WeatherAPI:', data);
                
                currentWeather = {
                    temp: Math.round(data.current.temp_c),
                    feels_like: Math.round(data.current.feelslike_c),
                    humidity: data.current.humidity,
                    pressure: Math.round(data.current.pressure_mb),
                    wind_speed: Math.round(data.current.wind_kph / 3.6), // Конвертируем км/ч в м/с
                    wind_dir: data.current.wind_dir,
                    description: data.current.condition.text,
                    icon: data.current.condition.icon,
                    uv: data.current.uv,
                    visibility: data.current.vis_km,
                    timestamp: new Date().toISOString()
                };
                
                lastWeatherUpdate = new Date();
                console.log('Погода получена:', currentWeather);
                showNotification(`🌤️ ${currentWeather.temp}°C, ${currentWeather.description}`);
                
            } catch (error) {
                console.error('Ошибка получения погоды WeatherAPI:', error);
                
                // Fallback на Open-Meteo если WeatherAPI недоступен
                try {
                    console.log('Используем fallback Open-Meteo...');
                    const fallbackResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`);
                    const fallbackData = await fallbackResponse.json();
                    
                    if (fallbackData.current_weather) {
                        const weather = fallbackData.current_weather;
                        const humidity = fallbackData.hourly.relative_humidity_2m[0] || 50;
                        
                        const weatherDescriptions = {
                            0: 'ясно', 1: 'преимущественно ясно', 2: 'переменная облачность', 3: 'пасмурно',
                            45: 'туман', 48: 'изморозь', 51: 'легкая морось', 53: 'морось', 55: 'сильная морось',
                            61: 'легкий дождь', 63: 'дождь', 65: 'сильный дождь', 71: 'легкий снег', 
                            73: 'снег', 75: 'сильный снег', 95: 'гроза'
                        };
                        
                        currentWeather = {
                            temp: Math.round(weather.temperature),
                            feels_like: Math.round(weather.temperature),
                            humidity: Math.round(humidity),
                            pressure: 1013, // Стандартное давление
                            wind_speed: Math.round(weather.windspeed || 0),
                            description: weatherDescriptions[weather.weathercode] || 'неизвестно',
                            timestamp: new Date().toISOString()
                        };
                        
                        lastWeatherUpdate = new Date();
                        console.log('Fallback погода получена:', currentWeather);
                        showNotification(`🌤️ ${currentWeather.temp}°C, ${currentWeather.description}`);
                    }
                } catch (fallbackError) {
                    console.error('Ошибка fallback погоды:', fallbackError);
                    currentWeather = null;
                }
            }
        }

        // Проверяем актуальность погоды (обновляем каждый час)
        function checkWeatherUpdate() {
            if (locationEnabled && userLocation && (!lastWeatherUpdate || 
                (new Date() - lastWeatherUpdate) > 3600000)) { // 1 час
                getWeatherData(userLocation.latitude, userLocation.longitude);
            }
        }

        // Функция для повторной попытки получения геолокации
        function retryLocation() {
            if (locationEnabled) {
                showNotification('Повторная попытка получения местоположения...');
                requestLocation();
            }
        }

        // Проверяем актуальность местоположения (обновляем если старше 1 часа)
        function checkLocationUpdate() {
            if (locationEnabled && userLocation) {
                const locationAge = new Date() - new Date(userLocation.timestamp);
                if (locationAge > 3600000) { // 1 час
                    console.log('Местоположение устарело, обновляем...');
                    requestLocation();
                }
            } else if (locationEnabled && !userLocation) {
                // Если геолокация включена, но данных нет - пробуем получить
                console.log('Геолокация включена, но данных нет, получаем...');
                requestLocation();
            }
        }


        // Функции для панели прикрепления
        function toggleAttachMenu() {
            const menu = document.getElementById('attachMenu');
            const isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        function handleMediaUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            input.multiple = true;
            
            input.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    for (let file of files) {
                        addFileMessage(file);
                    }
                    showNotification(`Загружено файлов: ${files.length}`);
                    playNotificationSound();
                }
            };
            
            input.click();
            document.getElementById('attachMenu').style.display = 'none';
        }

        function openMiniGames() {
            showNotification('Мини игры - в разработке');
            document.getElementById('attachMenu').style.display = 'none';
        }

        // Функции для дополнительных кнопок
        function showWeather() {
            console.log('showWeather вызвана', { locationEnabled, userLocation });
            
            if (locationEnabled && userLocation) {
                openWeatherModal();
            } else if (!locationEnabled) {
                showNotification('📍 Включите геолокацию в настройках для просмотра погоды');
            } else {
                showNotification('🔄 Получение местоположения... Попробуйте еще раз через несколько секунд');
                // Попытаемся получить местоположение
                if (locationEnabled) {
                    requestLocation();
                }
            }
        }

        function openWeatherModal() {
            document.getElementById('weatherModal').style.display = 'block';
            loadWeatherData();
        }

        function closeWeatherModal() {
            document.getElementById('weatherModal').style.display = 'none';
        }

        async function loadWeatherData() {
            const weatherContent = document.getElementById('weatherContent');
            
            if (!locationEnabled || !userLocation) {
                weatherContent.innerHTML = `
                    <div class="weather-error">
                        <div class="weather-icon">📍</div>
                        <div class="weather-message">Геолокация отключена</div>
                        <div class="weather-desc">Включите геолокацию в настройках для просмотра погоды</div>
                        <button class="weather-btn" onclick="closeWeatherModal(); openMainSettings();">Открыть настройки</button>
                    </div>
                `;
                return;
            }

            // Показываем загрузку
            weatherContent.innerHTML = `
                <div class="weather-loading">
                    <div class="loading-spinner"></div>
                    <div class="weather-message">Загружаем погоду...</div>
                </div>
            `;

            try {
                // Обновляем погоду если нужно
                await checkWeatherUpdate();
                
                if (currentWeather) {
                    const locationText = userLocation.city ? 
                        `${userLocation.city}, ${userLocation.country}` : 
                        `${userLocation.country}`;
                    
                    weatherContent.innerHTML = `
                        <div class="weather-main">
                            <div class="weather-location">
                                <div class="location-icon">📍</div>
                                <div class="location-text">${locationText}</div>
                            </div>
                            
                            <div class="weather-current">
                                <div class="weather-temp">${Math.round(currentWeather.temp)}°</div>
                                <div class="weather-desc">${currentWeather.description}</div>
                            </div>
                            
                            <div class="weather-details">
                                <div class="weather-item">
                                    <div class="weather-label">Ощущается как</div>
                                    <div class="weather-value">${Math.round(currentWeather.feels_like)}°C</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Влажность</div>
                                    <div class="weather-value">${currentWeather.humidity}%</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Давление</div>
                                    <div class="weather-value">${currentWeather.pressure ? Math.round(currentWeather.pressure * 0.75) : 'Н/Д'} мм рт.ст.</div>
                                </div>
                                <div class="weather-item">
                                    <div class="weather-label">Ветер</div>
                                    <div class="weather-value">${Math.round(currentWeather.wind_speed || 0)} м/с ${currentWeather.wind_dir || ''}</div>
                                </div>
                                ${currentWeather.uv ? `
                                <div class="weather-item">
                                    <div class="weather-label">УФ-индекс</div>
                                    <div class="weather-value">${currentWeather.uv}</div>
                                </div>
                                ` : ''}
                                ${currentWeather.visibility ? `
                                <div class="weather-item">
                                    <div class="weather-label">Видимость</div>
                                    <div class="weather-value">${currentWeather.visibility} км</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="weather-update">
                                Обновлено: ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error('Не удалось получить данные о погоде');
                }
            } catch (error) {
                console.error('Ошибка загрузки погоды:', error);
                weatherContent.innerHTML = `
                    <div class="weather-error">
                        <div class="weather-icon">⚠️</div>
                        <div class="weather-message">Ошибка загрузки</div>
                        <div class="weather-desc">Не удалось получить данные о погоде</div>
                        <button class="weather-btn" onclick="loadWeatherData()">Попробовать снова</button>
                    </div>
                `;
            }
        }

        function showNews() {
            openNewsModal();
        }

        function openNewsModal() {
            document.getElementById('newsModal').style.display = 'block';
            
            // Проверяем есть ли кэшированные новости
            if (cachedNews && cachedNews.location && cachedNews.articles) {
                displayCompactNews(cachedNews.articles, cachedNews.location);
                updateRefreshButton();
            } else {
                // Загружаем новости по умолчанию (Россия)
                selectNewsLocation('Россия');
            }
        }

        function closeNewsModal() {
            document.getElementById('newsModal').style.display = 'none';
        }

        function selectNewsLocation(location) {
            // Проверяем кэш для этого региона
            if (cachedNews && cachedNews.location === location && isNewsCacheValid()) {
                displayCompactNews(cachedNews.articles, location);
                updateRefreshButton();
                return;
            }
            
            // Загружаем новые новости
            loadNewsData(location);
        }

        function refreshNews() {
            const refreshBtn = document.getElementById('refreshNewsBtn');
            
            if (!canRefreshNews()) {
                const timeLeft = getTimeUntilNextRefresh();
                showNotification(`⏰ Обновление доступно через ${timeLeft}`);
                return;
            }
            
            // Определяем текущий регион
            const currentLocation = cachedNews ? cachedNews.location : 'Россия';
            
            // Принудительно загружаем новые новости
            refreshBtn.disabled = true;
            refreshBtn.classList.add('loading');
            
            loadNewsData(currentLocation, true);
        }

        function canRefreshNews() {
            if (!lastNewsUpdate) return true;
            
            const now = new Date();
            const timeDiff = now - lastNewsUpdate;
            const threeHours = 3 * 60 * 60 * 1000; // 3 часа в миллисекундах
            
            return timeDiff >= threeHours;
        }

        function isNewsCacheValid() {
            return canRefreshNews() === false; // Если нельзя обновить, значит кэш валиден
        }

        function getTimeUntilNextRefresh() {
            if (!lastNewsUpdate) return '0 мин';
            
            const now = new Date();
            const nextRefresh = new Date(lastNewsUpdate.getTime() + (3 * 60 * 60 * 1000));
            const timeDiff = nextRefresh - now;
            
            if (timeDiff <= 0) return '0 мин';
            
            const hours = Math.floor(timeDiff / (60 * 60 * 1000));
            const minutes = Math.floor((timeDiff % (60 * 60 * 1000)) / (60 * 1000));
            
            if (hours > 0) {
                return `${hours}ч ${minutes}мин`;
            } else {
                return `${minutes}мин`;
            }
        }

        function updateRefreshButton() {
            const refreshBtn = document.getElementById('refreshNewsBtn');
            const nextUpdateInfo = document.getElementById('nextUpdateInfo');
            
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('loading');
            
            if (canRefreshNews()) {
                refreshBtn.disabled = false;
                nextUpdateInfo.textContent = 'Можно обновить';
            } else {
                refreshBtn.disabled = true;
                const timeLeft = getTimeUntilNextRefresh();
                nextUpdateInfo.textContent = `Следующее обновление через ${timeLeft}`;
            }
        }

        async function loadNewsData(location, forceRefresh = false) {
            const newsResults = document.getElementById('newsResults');
            
            // Показываем загрузку
            newsResults.innerHTML = `
                <div class="news-loading">
                    <div class="loading-spinner"></div>
                    <div class="weather-message">Загружаем новости для "${location}"...</div>
                </div>
            `;

            try {
                // Используем NewsAPI с вашим ключом
                const API_KEY = 'eae37e99b83c43a6be87f3ae09deb219';
                
                // Определяем параметры поиска в зависимости от региона
                let searchQuery = location;
                let country = '';
                
                // Маппинг популярных регионов на коды стран
                const countryMapping = {
                    'россия': 'ru',
                    'russia': 'ru',
                    'сша': 'us',
                    'usa': 'us',
                    'америка': 'us',
                    'германия': 'de',
                    'germany': 'de',
                    'франция': 'fr',
                    'france': 'fr',
                    'великобритания': 'gb',
                    'англия': 'gb',
                    'uk': 'gb',
                    'китай': 'cn',
                    'china': 'cn',
                    'япония': 'jp',
                    'japan': 'jp',
                    'украина': 'ua',
                    'ukraine': 'ua',
                    'беларусь': 'by',
                    'belarus': 'by',
                    'казахстан': 'kz',
                    'kazakhstan': 'kz',
                    'италия': 'it',
                    'italy': 'it',
                    'испания': 'es',
                    'spain': 'es',
                    'канада': 'ca',
                    'canada': 'ca',
                    'австралия': 'au',
                    'australia': 'au',
                    'бразилия': 'br',
                    'brazil': 'br',
                    'индия': 'in',
                    'india': 'in',
                    'мир': '',
                    'world': ''
                };
                
                const locationLower = location.toLowerCase();
                if (countryMapping[locationLower]) {
                    country = countryMapping[locationLower];
                    searchQuery = ''; // Для страны не нужен дополнительный поисковый запрос
                }
                
                // Формируем URL для API
                let apiUrl;
                
                if (country && country !== '') {
                    // Если это страна, используем топ новости этой страны
                    apiUrl = `https://newsapi.org/v2/top-headlines?apiKey=${API_KEY}&country=${country}&pageSize=20`;
                } else if (locationLower === 'мир' || locationLower === 'world') {
                    // Для "Мир" берем топ новости без привязки к стране
                    apiUrl = `https://newsapi.org/v2/top-headlines?apiKey=${API_KEY}&pageSize=20&sources=bbc-news,cnn,reuters,associated-press`;
                } else {
                    // Иначе ищем по ключевым словам
                    apiUrl = `https://newsapi.org/v2/everything?apiKey=${API_KEY}&q=${encodeURIComponent(searchQuery)}&sortBy=publishedAt&pageSize=20&language=ru`;
                }
                
                console.log('Запрос к NewsAPI:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('NewsAPI HTTP Error:', response.status, errorText);
                    throw new Error(`NewsAPI HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Данные новостей NewsAPI:', data);
                
                if (data.status === 'error') {
                    console.error('NewsAPI Error:', data.message, data.code);
                    throw new Error(data.message || 'Ошибка API');
                }
                
                if (!data.articles || data.articles.length === 0) {
                    console.warn('NewsAPI вернул пустой массив статей');
                    throw new Error('Новости не найдены');
                }
                
                // Фильтруем и обрабатываем новости
                const processedNews = processNewsData(data.articles, location);
                console.log('Обработанные новости:', processedNews.length);
                
                if (processedNews.length === 0) {
                    throw new Error('Все новости были отфильтрованы');
                }
                
                // Берем только 3 самые свежие новости
                const top3News = processedNews.slice(0, 3);
                
                // Сохраняем в кэш
                cachedNews = {
                    location: location,
                    articles: top3News,
                    timestamp: new Date().toISOString()
                };
                lastNewsUpdate = new Date();
                
                localStorage.setItem('ai-tap-cached-news', JSON.stringify(cachedNews));
                localStorage.setItem('ai-tap-last-news-update', lastNewsUpdate.toISOString());
                
                displayCompactNews(top3News, location);
                updateRefreshButton();
                showNotification(`📰 Загружено ${top3News.length} свежих новостей`);
                
            } catch (error) {
                console.error('Ошибка загрузки новостей NewsAPI:', error);
                
                // Fallback на моковые данные если API недоступен
                try {
                    console.log('Используем fallback моковые данные...');
                    await new Promise(resolve => setTimeout(resolve, 800));
                    const mockNews = generateMockNews(location).slice(0, 3); // Только 3 новости
                    
                    // Сохраняем демо-данные в кэш
                    cachedNews = {
                        location: location,
                        articles: mockNews,
                        timestamp: new Date().toISOString()
                    };
                    lastNewsUpdate = new Date();
                    
                    localStorage.setItem('ai-tap-cached-news', JSON.stringify(cachedNews));
                    localStorage.setItem('ai-tap-last-news-update', lastNewsUpdate.toISOString());
                    
                    displayCompactNews(mockNews, location);
                    updateRefreshButton();
                    showNotification('⚠️ Используются демо-данные (проблема с API)');
                } catch (fallbackError) {
                    console.error('Ошибка fallback новостей:', fallbackError);
                    newsResults.innerHTML = `
                        <div class="news-error">
                            <div class="news-error-icon">📰</div>
                            <div class="news-error-message">Ошибка загрузки новостей</div>
                            <div class="news-error-desc">Не удалось получить новости для "${location}". Проверьте подключение к интернету или попробуйте позже.</div>
                            <button class="weather-btn" onclick="selectNewsLocation('${location}')">Попробовать снова</button>
                        </div>
                    `;
                    updateRefreshButton();
                }
            }
        }

        function processNewsData(articles, location) {
            if (!articles || articles.length === 0) {
                return [];
            }
            
            return articles
                .filter(article => 
                    article.title && 
                    article.title !== '[Removed]' && 
                    article.description && 
                    article.description !== '[Removed]'
                )
                .map(article => ({
                    title: article.title,
                    description: article.description || 'Описание недоступно',
                    source: article.source?.name || 'Неизвестный источник',
                    category: getCategoryFromSource(article.source?.name) || 'Новости',
                    icon: getCategoryIcon(getCategoryFromSource(article.source?.name)),
                    publishedAt: article.publishedAt,
                    url: article.url,
                    urlToImage: article.urlToImage
                }))
                .slice(0, 15); // Ограничиваем до 15 новостей
        }

        function getCategoryFromSource(sourceName) {
            if (!sourceName) return 'Новости';
            
            const sourceLower = sourceName.toLowerCase();
            
            if (sourceLower.includes('спорт') || sourceLower.includes('sport')) return 'Спорт';
            if (sourceLower.includes('экономик') || sourceLower.includes('бизнес') || sourceLower.includes('финанс')) return 'Экономика';
            if (sourceLower.includes('технолог') || sourceLower.includes('tech') || sourceLower.includes('it')) return 'Технологии';
            if (sourceLower.includes('политик') || sourceLower.includes('politic')) return 'Политика';
            if (sourceLower.includes('культур') || sourceLower.includes('искусств') || sourceLower.includes('culture')) return 'Культура';
            if (sourceLower.includes('наук') || sourceLower.includes('science')) return 'Наука';
            if (sourceLower.includes('здоровь') || sourceLower.includes('медицин') || sourceLower.includes('health')) return 'Здоровье';
            
            return 'Новости';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Спорт': '⚽',
                'Экономика': '💼',
                'Технологии': '💻',
                'Политика': '🏛️',
                'Культура': '🎭',
                'Наука': '🔬',
                'Здоровье': '🏥',
                'Новости': '📰'
            };
            return icons[category] || '📰';
        }

        function generateMockNews(location) {
            // Моковые новости для демонстрации интерфейса
            const newsTemplates = [
                {
                    title: `Экономические новости из ${location}`,
                    description: `Последние экономические события и их влияние на регион ${location}. Анализ текущей ситуации и прогнозы экспертов.`,
                    source: 'Экономика Today',
                    category: 'Экономика',
                    icon: '💼'
                },
                {
                    title: `Политические события в ${location}`,
                    description: `Обзор политической ситуации в регионе ${location}. Важные решения и их последствия для жителей.`,
                    source: 'Политика News',
                    category: 'Политика',
                    icon: '🏛️'
                },
                {
                    title: `Технологии и инновации ${location}`,
                    description: `Новые технологические разработки и стартапы в ${location}. Цифровая трансформация региона.`,
                    source: 'Tech Daily',
                    category: 'Технологии',
                    icon: '💻'
                },
                {
                    title: `Спортивные достижения ${location}`,
                    description: `Спортивные события и достижения спортсменов из ${location}. Результаты соревнований и турниров.`,
                    source: 'Sport News',
                    category: 'Спорт',
                    icon: '⚽'
                },
                {
                    title: `Культурная жизнь ${location}`,
                    description: `Культурные события, выставки и фестивали в ${location}. Новости искусства и развлечений.`,
                    source: 'Culture Today',
                    category: 'Культура',
                    icon: '🎭'
                }
            ];

            return newsTemplates.map((template, index) => ({
                ...template,
                id: index,
                publishedAt: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                url: `#news-${index}`
            }));
        }

        function displayCompactNews(newsData, location) {
            const newsResults = document.getElementById('newsResults');
            
            if (!newsData || newsData.length === 0) {
                newsResults.innerHTML = `
                    <div class="news-error">
                        <div class="news-error-icon">📭</div>
                        <div class="news-error-message">Новости не найдены</div>
                        <div class="news-error-desc">Не удалось найти новости для "${location}". Попробуйте другой регион.</div>
                    </div>
                `;
                return;
            }

            // Сохраняем текущие новости для открытия статей
            currentNewsData = newsData;

            const newsHTML = `
                <div class="news-header">
                    <div class="news-title">📰 Новости: ${location}</div>
                    <div class="news-count">${newsData.length} из 3 новостей</div>
                </div>
                <div class="news-list-compact">
                    ${newsData.map((article, index) => `
                        <div class="news-item-compact" onclick="openNewsArticle(${index})">
                            <div class="news-compact-header">
                                <div class="news-compact-image">
                                    ${article.urlToImage ? 
                                        `<img src="${article.urlToImage}" alt="News" onerror="this.style.display='none'; this.parentElement.innerHTML='${article.icon}';" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` 
                                        : article.icon
                                    }
                                </div>
                                <div class="news-compact-content">
                                    <div class="news-compact-title">${article.title}</div>
                                    <div class="news-compact-meta">
                                        <div class="news-compact-source">${article.source}</div>
                                        <div class="news-compact-time">${formatNewsTime(article.publishedAt)}</div>
                                        <div class="news-compact-category">${article.category}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            newsResults.innerHTML = newsHTML;
        }

        // Оставляем старую функцию для совместимости
        function displayNews(newsData, location) {
            displayCompactNews(newsData, location);
        }

        function formatNewsTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffHours < 1) {
                return 'Только что';
            } else if (diffHours < 24) {
                return `${diffHours} ч. назад`;
            } else if (diffDays < 7) {
                return `${diffDays} дн. назад`;
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }

        function openNewsArticle(articleIndex) {
            if (!currentNewsData || !currentNewsData[articleIndex]) {
                showNotification('❌ Статья не найдена');
                return;
            }

            const article = currentNewsData[articleIndex];
            document.getElementById('articleModal').style.display = 'block';
            document.getElementById('articleTitle').textContent = `📰 ${article.source}`;
            
            loadArticleContent(article);
        }

        function closeArticleModal() {
            document.getElementById('articleModal').style.display = 'none';
        }

        function loadArticleContent(article) {
            const articleContent = document.getElementById('articleContent');
            
            // Показываем загрузку
            articleContent.innerHTML = `
                <div class="article-loading">
                    <div class="loading-spinner"></div>
                    <div class="weather-message">Загружаем статью...</div>
                </div>
            `;

            // Имитируем загрузку контента (в реальности здесь был бы запрос к API для получения полного текста)
            setTimeout(() => {
                displayArticleContent(article);
            }, 800);
        }

        function displayArticleContent(article) {
            const articleContent = document.getElementById('articleContent');
            
            // Генерируем расширенный контент статьи
            const fullContent = generateFullArticleContent(article);
            
            const articleHTML = `
                <div class="article-header">
                    <div class="article-meta">
                        <div class="article-source">${article.source}</div>
                        <div class="article-date">${formatNewsTime(article.publishedAt)}</div>
                        <div class="article-category">${article.category}</div>
                    </div>
                    <h1 class="article-main-title">${article.title}</h1>
                </div>

                ${article.urlToImage ? `<img src="${article.urlToImage}" alt="Изображение статьи" class="article-image" onerror="this.style.display='none';">` : ''}

                <div class="article-description">
                    ${article.description}
                </div>

                <div class="article-body">
                    ${fullContent}
                </div>

                <div class="article-actions">
                    ${article.url && !article.url.startsWith('#') ? 
                        `<a href="${article.url}" target="_blank" class="article-btn primary">
                            🔗 Читать оригинал
                        </a>` : 
                        `<button class="article-btn primary" onclick="showNotification('Оригинал статьи недоступен')">
                            🔗 Читать оригинал
                        </button>`
                    }
                    <button class="article-btn secondary" onclick="shareArticle('${article.title}', '${article.url}')">
                        📤 Поделиться
                    </button>
                </div>
            `;

            articleContent.innerHTML = articleHTML;
        }

        function generateFullArticleContent(article) {
            // Генерируем расширенный контент на основе описания и категории
            const templates = {
                'Экономика': [
                    'Экономические эксперты отмечают значительные изменения в данном секторе.',
                    'Аналитики прогнозируют дальнейшее развитие ситуации в ближайшие месяцы.',
                    'Данные события могут повлиять на общую экономическую ситуацию в регионе.',
                    'Министерство экономики планирует принять дополнительные меры поддержки.',
                    'Инвесторы внимательно следят за развитием событий и корректируют свои стратегии.'
                ],
                'Политика': [
                    'Политические аналитики высоко оценивают значимость данного события.',
                    'Представители различных партий выразили свое мнение по данному вопросу.',
                    'Общественность активно обсуждает возможные последствия принятых решений.',
                    'Международные наблюдатели следят за развитием политической ситуации.',
                    'Эксперты прогнозируют возможные изменения в политическом курсе.'
                ],
                'Технологии': [
                    'Технологические инновации продолжают менять привычный уклад жизни.',
                    'Разработчики работают над улучшением функциональности и безопасности.',
                    'IT-сообщество активно обсуждает перспективы новых технологий.',
                    'Компании инвестируют значительные средства в исследования и разработки.',
                    'Пользователи отмечают удобство и эффективность новых решений.'
                ],
                'Спорт': [
                    'Спортивные болельщики с нетерпением ожидают предстоящих соревнований.',
                    'Тренеры и спортсмены интенсивно готовятся к важным стартам.',
                    'Спортивные эксперты анализируют шансы различных команд и спортсменов.',
                    'Организаторы обеспечивают высокий уровень проведения спортивных мероприятий.',
                    'Результаты соревнований могут повлиять на рейтинги и будущие выступления.'
                ],
                'Культура': [
                    'Культурные деятели отмечают важность сохранения традиций и наследия.',
                    'Мероприятие привлекло внимание широкой общественности и критиков.',
                    'Организаторы планируют расширить программу в следующем году.',
                    'Посетители высоко оценили качество и разнообразие представленных работ.',
                    'Культурная инициатива получила поддержку местных властей и спонсоров.'
                ]
            };

            const categoryTemplates = templates[article.category] || templates['Экономика'];
            const selectedTemplates = categoryTemplates.slice(0, 3 + Math.floor(Math.random() * 3));
            
            return selectedTemplates.map(template => `<p>${template}</p>`).join('\n\n');
        }

        function shareArticle(title, url) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).catch(err => console.log('Ошибка при попытке поделиться:', err));
            } else {
                // Fallback для браузеров без поддержки Web Share API
                const shareText = `${title} - ${url}`;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        showNotification('📋 Ссылка скопирована в буфер обмена');
                    });
                } else {
                    showNotification('📤 Поделиться: ' + title);
                }
            }
        }

        // Добавляем поддержку Enter в поле поиска новостей
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчик для поля поиска новостей
            setTimeout(() => {
                const newsInput = document.getElementById('newsLocationInput');
                if (newsInput) {
                    newsInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            searchNews();
                        }
                    });
                }
            }, 100);
        });

        // Функции главных настроек
        function openMainSettings() {
            document.getElementById('mainSettingsModal').style.display = 'block';
            loadMainSettings();
        }

        function closeMainSettings() {
            document.getElementById('mainSettingsModal').style.display = 'none';
        }

        function loadMainSettings() {
            // Загружаем настройки геолокации
            document.getElementById('mainLocationToggle').checked = locationEnabled;
            updateMainLocationDisplay();
            
            // Загружаем настройки разрешений
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            document.getElementById('cameraToggle').checked = permissions.camera || false;
            document.getElementById('microphoneToggle').checked = permissions.microphone || false;
            document.getElementById('filesToggle').checked = permissions.files !== false; // по умолчанию true
            
            // Загружаем настройки звука
            const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
            document.getElementById('mainSoundToggle').checked = soundEnabled;
            
            // Обработчики для переключателей
            document.getElementById('mainLocationToggle').onchange = function() {
                if (this.checked) {
                    requestLocation();
                } else {
                    locationEnabled = false;
                    localStorage.setItem('ai-tap-location-enabled', 'false');
                    updateMainLocationDisplay();
                    showNotification('Геолокация отключена');
                }
            };
            
            document.getElementById('cameraToggle').onchange = function() {
                requestCameraPermission(this.checked);
            };
            
            document.getElementById('microphoneToggle').onchange = function() {
                requestMicrophonePermission(this.checked);
            };
        }

        function updateMainLocationDisplay() {
            const locationInfo = document.getElementById('mainLocationInfo');
            const currentLocation = document.getElementById('mainCurrentLocation');
            
            if (locationEnabled && userLocation) {
                locationInfo.style.display = 'block';
                currentLocation.textContent = `${userLocation.city || 'Неизвестный город'}, ${userLocation.country || 'Неизвестная страна'}`;
            } else if (locationEnabled && !userLocation) {
                locationInfo.style.display = 'block';
                currentLocation.textContent = 'Получение местоположения...';
            } else {
                locationInfo.style.display = 'none';
            }
        }

        async function requestCameraPermission(enable) {
            if (enable) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop()); // Останавливаем поток
                    
                    const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                    permissions.camera = true;
                    localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                    
                    showNotification('✅ Доступ к камере разрешен');
                } catch (error) {
                    console.error('Ошибка доступа к камере:', error);
                    document.getElementById('cameraToggle').checked = false;
                    showNotification('❌ Доступ к камере запрещен');
                }
            } else {
                const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                permissions.camera = false;
                localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                showNotification('Доступ к камере отключен');
            }
        }

        async function requestMicrophonePermission(enable) {
            if (enable) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Останавливаем поток
                    
                    const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                    permissions.microphone = true;
                    localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                    
                    showNotification('✅ Доступ к микрофону разрешен');
                } catch (error) {
                    console.error('Ошибка доступа к микрофону:', error);
                    document.getElementById('microphoneToggle').checked = false;
                    showNotification('❌ Доступ к микрофону запрещен');
                }
            } else {
                const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
                permissions.microphone = false;
                localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
                showNotification('Доступ к микрофону отключен');
            }
        }

        function saveMainSettings() {
            // Сохраняем настройки звука
            const soundEnabled = document.getElementById('mainSoundToggle').checked;
            localStorage.setItem('ai-tap-sound', soundEnabled ? 'true' : 'false');
            
            // Сохраняем настройки файлов
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            permissions.files = document.getElementById('filesToggle').checked;
            localStorage.setItem('ai-tap-permissions', JSON.stringify(permissions));
            
            showNotification('✅ Настройки сохранены');
            closeMainSettings();
        }

        function resetMainSettings() {
            if (confirm('Сбросить все настройки к значениям по умолчанию?')) {
                // Сбрасываем разрешения
                localStorage.removeItem('ai-tap-permissions');
                
                // Сбрасываем геолокацию
                locationEnabled = false;
                localStorage.setItem('ai-tap-location-enabled', 'false');
                
                // Сбрасываем звук
                localStorage.setItem('ai-tap-sound', 'true');
                
                showNotification('🔄 Настройки сброшены');
                loadMainSettings();
            }
        }


        // Анализ настроения пользователя
        function analyzeMood(message) {
            const text = message.toLowerCase();
            
            // Позитивные слова
            const positiveWords = ['хорошо', 'отлично', 'супер', 'классно', 'круто', 'замечательно', 'прекрасно', 'радость', 'счастлив', 'весело', 'люблю', 'нравится', 'спасибо', 'благодарю', '😊', '😄', '😍', '👍', '❤️', '🎉'];
            
            // Негативные слова
            const negativeWords = ['плохо', 'ужасно', 'грустно', 'печально', 'злой', 'расстроен', 'проблема', 'ошибка', 'не работает', 'сломалось', 'болит', 'устал', 'скучно', '😢', '😭', '😠', '😡', '💔', '😞'];
            
            // Нейтральные/вопросительные слова
            const neutralWords = ['как', 'что', 'где', 'когда', 'почему', 'можешь', 'помоги', 'расскажи', 'объясни'];
            
            let positiveScore = 0;
            let negativeScore = 0;
            let neutralScore = 0;
            
            // Подсчитываем совпадения
            positiveWords.forEach(word => {
                if (text.includes(word)) positiveScore++;
            });
            
            negativeWords.forEach(word => {
                if (text.includes(word)) negativeScore++;
            });
            
            neutralWords.forEach(word => {
                if (text.includes(word)) neutralScore++;
            });
            
            // Определяем настроение
            if (positiveScore > negativeScore && positiveScore > 0) {
                return 'positive';
            } else if (negativeScore > positiveScore && negativeScore > 0) {
                return 'negative';
            } else if (neutralScore > 0) {
                return 'curious';
            } else {
                return 'neutral';
            }
        }

        function updateUserMood(mood) {
            aiMemory.userMood = mood;
            aiMemory.moodHistory = aiMemory.moodHistory || [];
            aiMemory.moodHistory.push({
                mood: mood,
                timestamp: new Date().toISOString()
            });
            
            // Ограничиваем историю настроений до 50 записей
            if (aiMemory.moodHistory.length > 50) {
                aiMemory.moodHistory.shift();
            }
            
            updateAIMemory('userMood', mood);
            updateAIMemory('moodHistory', aiMemory.moodHistory);
        }

        // Анализ активности пользователя
        function analyzeUserActivity() {
            const now = new Date();
            const today = now.toDateString();
            
            // Инициализируем статистику активности
            if (!aiMemory.activityStats) {
                aiMemory.activityStats = {};
            }
            
            if (!aiMemory.activityStats[today]) {
                aiMemory.activityStats[today] = {
                    messages: 0,
                    firstMessage: now.toISOString(),
                    lastMessage: now.toISOString(),
                    timeSpent: 0
                };
            }
            
            // Обновляем статистику
            aiMemory.activityStats[today].messages++;
            aiMemory.activityStats[today].lastMessage = now.toISOString();
            
            // Вычисляем время, проведенное в чате
            const firstMessage = new Date(aiMemory.activityStats[today].firstMessage);
            const timeSpent = Math.round((now - firstMessage) / (1000 * 60)); // в минутах
            aiMemory.activityStats[today].timeSpent = timeSpent;
            
            updateAIMemory('activityStats', aiMemory.activityStats);
            
            return {
                todayMessages: aiMemory.activityStats[today].messages,
                timeSpent: timeSpent,
                isActiveUser: aiMemory.activityStats[today].messages > 5
            };
        }


        // Новый красивый интерфейс настроек
        function toggleAISettings() {
            document.getElementById('settingsModal').style.display = 'block';
            loadSettingsUI();
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function loadSettingsUI() {
            // Загружаем текущие настройки в интерфейс
            const currentMode = aiSettings.mode || 'smart';
            
            // Устанавливаем активный режим
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.mode === currentMode) {
                    option.classList.add('active');
                }
            });
            
            const soundEnabled = localStorage.getItem('ai-tap-sound') !== 'false';
            document.getElementById('soundToggle').checked = soundEnabled;
            
            // Обновляем статистику
            updateStatistics();
        }

        function selectMode(mode) {
            // Убираем активный класс со всех опций
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Добавляем активный класс к выбранной опции
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Устанавливаем температуру в зависимости от режима
            if (mode === 'precise') {
                aiSettings.temperature = 0.3;
                showNotification('Режим: Точный (температура 0.3)');
            } else if (mode === 'smart') {
                aiSettings.temperature = 0.7;
                showNotification('Режим: Умный (температура 0.7)');
            }
            
            aiSettings.mode = mode;
            localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
        }

        function updateStatistics() {
            // Обновляем статистику
            document.getElementById('statMessages').textContent = aiMemory.interactionCount || 0;
            document.getElementById('statFacts').textContent = (aiMemory.rememberedFacts || []).length;
            
            // Вычисляем дни общения
            if (aiMemory.lastInteraction) {
                const firstInteraction = new Date(aiMemory.lastInteraction);
                const now = new Date();
                const daysDiff = Math.ceil((now - firstInteraction) / (1000 * 60 * 60 * 24));
                document.getElementById('statDays').textContent = Math.max(1, daysDiff);
            } else {
                document.getElementById('statDays').textContent = 0;
            }
        }

        function saveSettings() {
            // Сохраняем настройки ИИ
            aiSettings.temperature = parseFloat(document.getElementById('temperatureSlider').value);
            aiSettings.maxTokens = parseInt(document.getElementById('tokensSlider').value);
            localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
            
            // Сохраняем настройки звука
            const soundEnabled = document.getElementById('soundToggle').checked;
            localStorage.setItem('ai-tap-sound', soundEnabled.toString());
            
            closeSettings();
            updateConnectionStatus('🟢', 'Настройки сохранены');
            showNotification('✅ Настройки сохранены');
            playNotificationSound();
        }

        function resetSettings() {
            if (confirm('Сбросить все настройки к значениям по умолчанию?')) {
                // Сбрасываем настройки ИИ
                aiSettings = { temperature: 0.7, maxTokens: 1000 };
                localStorage.setItem('ai-tap-settings', JSON.stringify(aiSettings));
                
                // Сбрасываем звуки
                localStorage.setItem('ai-tap-sound', 'true');
                
                // Обновляем интерфейс
                loadSettingsUI();
                
                showNotification('🔄 Настройки сброшены');
            }
        }

        // Статус подключения
        function updateConnectionStatus(status, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.title = message || 'Статус подключения';
            }
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const currentTime = getCurrentTime();
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return currentTime;
        }

        // Debounce для индикатора печати
        let typingTimeout = null;
        let isTypingVisible = false;

        function showTyping() {
            // Очищаем предыдущий таймаут
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Показываем индикатор с небольшой задержкой для избежания мерцания
            if (!isTypingVisible) {
                typingTimeout = setTimeout(() => {
                    document.getElementById('typingIndicator').style.display = 'flex';
                    isTypingVisible = true;
                }, 200); // 200ms задержка
            }
        }

        function hideTyping() {
            // Очищаем таймаут показа
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            // Скрываем с плавной анимацией
            const indicator = document.getElementById('typingIndicator');
            if (isTypingVisible) {
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.opacity = '1';
                    indicator.style.transform = 'translateY(0)';
                    isTypingVisible = false;
                }, 300);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!input || !sendButton) {
                console.error('Элементы чата не найдены');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) return;
            
            // Воспроизводим звук отправки
            playSendSound();
            
            // Анализируем настроение сообщения
            const mood = analyzeMood(message);
            updateUserMood(mood);
            
            // Добавляем сообщение пользователя в интерфейс и получаем время
            const userTime = addMessage(message, true);
            
            // Анализируем активность пользователя
            const activity = analyzeUserActivity();
            
            // Добавляем сообщение пользователя в историю с временем
            chatHistory.push({ role: 'user', content: message, timestamp: userTime });
            localStorage.setItem('ai-tap-chat-history', JSON.stringify(chatHistory));
            
            // Сохраняем сообщение пользователя в базу данных
            if (database && currentUser) {
                try {
                    await database.saveMessage(currentUser.id, 'user', message);
                } catch (error) {
                    console.error('Ошибка сохранения сообщения пользователя:', error);
                }
            }
            input.value = '';
            input.style.height = 'auto';
            
            // Блокируем кнопку отправки
            sendButton.disabled = true;
            showTyping();
            
            try {
                console.log('Отправляем запрос к Groq API...');
                updateConnectionStatus('🟡', 'Отправка запроса...');
                
                // Задержка 2 секунды перед отправкой запроса
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'system',
                                content: getPersonalizedSystemPrompt()
                            },
                            ...chatHistory.map(msg => ({
                                role: msg.role,
                                content: msg.content
                            }))
                        ],
                        max_tokens: aiSettings.maxTokens || 300,
                        temperature: aiSettings.temperature || 0.7
                    })
                });
                
                console.log('Статус ответа:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Ошибка API:', errorText);
                    throw new Error(`Ошибка API: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Ответ от Groq:', data);
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // Добавляем ответ ИИ в интерфейс и получаем время
                    const aiTime = addMessage(aiResponse);
                    
                    // Добавляем ответ ИИ в историю с временем
                    chatHistory.push({ role: 'assistant', content: aiResponse, timestamp: aiTime });
                    localStorage.setItem('ai-tap-chat-history', JSON.stringify(chatHistory));
                    
                    // Сохраняем ответ ИИ в базу данных
                    if (database && currentUser) {
                        try {
                            await database.saveMessage(currentUser.id, 'assistant', aiResponse);
                        } catch (error) {
                            console.error('Ошибка сохранения ответа ИИ:', error);
                        }
                    }
                    
                    hideTyping();
                    
                    // Звуковое уведомление и вибрация
                    playNotificationSound();
                    triggerVibration();
                    
                    // Обновляем статус подключения
                    updateConnectionStatus('🟢', 'Подключено');
                    
                    // Обновляем память ИИ
                    aiMemory.interactionCount++;
                    aiMemory.lastInteraction = new Date().toISOString();
                    updateAIMemory('interactionCount', aiMemory.interactionCount);
                    updateAIMemory('lastInteraction', aiMemory.lastInteraction);
                } else {
                    console.error('Неожиданный формат ответа:', data);
                    throw new Error('ИИ не смог сформировать ответ');
                }
                
            } catch (error) {
                console.error('Ошибка при отправке сообщения:', error);
                hideTyping();
                addMessage(`Ошибка: ${error.message}. Попробуйте еще раз.`);
                updateConnectionStatus('🔴', 'Ошибка подключения');
            } finally {
                sendButton.disabled = false;
            }
        }



        // Обработка нажатия Enter в поле ввода
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Автоматическое изменение высоты textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });

        // Система частиц
        function createParticles() {
            const container = document.getElementById('particlesContainer');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Случайный размер
                const sizes = ['small', 'medium', 'large'];
                particle.classList.add(sizes[Math.floor(Math.random() * sizes.length)]);
                
                // Случайная позиция
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                
                container.appendChild(particle);
            }
        }

        // Админ система
        const ADMIN_ID = 1485058648; // ID админа Андрея
        let isAdmin = false;
        let currentUser = null;

        // Инициализация пользователя
        const tg = window.Telegram.WebApp;
        tg.ready();

        const user = tg.initDataUnsafe.user;
        if (user) {
            currentUser = user;
            
            // Полная инициализация интерфейса пользователя
            const userId = user.id;
            const firstName = user.first_name;
            const lastName = user.last_name || '';
            const username = user.username || '';
            const photoUrl = user.photo_url || '';

            // Обновление основного интерфейса
            document.getElementById('userAvatar').src = photoUrl || 'https://via.placeholder.com/60x60/667eea/ffffff?text=U';
            document.getElementById('userName').textContent = `${firstName} ${lastName}`.trim();
            document.getElementById('userId').textContent = `ID: ${userId}`;

            // Данные для модального окна профиля
            document.getElementById('modalAvatar').src = photoUrl || 'https://via.placeholder.com/100x100/667eea/ffffff?text=U';
            document.getElementById('modalName').textContent = `${firstName} ${lastName}`.trim();
            document.getElementById('modalId').textContent = `ID: ${userId}`;
            document.getElementById('modalUsername').textContent = username ? `@${username}` : 'Без username';

            console.log('Данные пользователя загружены:', {
                id: userId,
                name: `${firstName} ${lastName}`.trim(),
                username: username,
                avatar: photoUrl
            });
            
            // Проверяем, является ли пользователь админом
            isAdmin = user.id === ADMIN_ID;
            if (isAdmin) {
                document.getElementById('adminPanelBtn').style.display = 'flex';
            }
            
            // Сохраняем данные пользователя
            localStorage.setItem('ai-tap-user', JSON.stringify(user));
            
            // Регистрируем пользователя в системе
            registerUser(user);
            
            // Проверяем статус бана
            checkBanStatus(user.id);
        } else {
            console.log('Данные пользователя недоступны');
        }

        // Функция регистрации пользователя
        function registerUser(userData) {
            let users = JSON.parse(localStorage.getItem('ai-tap-users') || '[]');
            
            // Проверяем, есть ли уже такой пользователь
            const existingUserIndex = users.findIndex(u => u.id === userData.id);
            
            const userRecord = {
                id: userData.id,
                first_name: userData.first_name,
                last_name: userData.last_name || '',
                username: userData.username || '',
                photo_url: userData.photo_url || '',
                last_seen: new Date().toISOString(),
                registered: existingUserIndex === -1 ? new Date().toISOString() : users[existingUserIndex].registered
            };
            
            if (existingUserIndex !== -1) {
                users[existingUserIndex] = userRecord;
            } else {
                users.push(userRecord);
            }
            
            localStorage.setItem('ai-tap-users', JSON.stringify(users));
        }

        // Проверка статуса бана
        function checkBanStatus(userId) {
            const bans = JSON.parse(localStorage.getItem('ai-tap-bans') || '[]');
            const userBan = bans.find(ban => ban.userId === userId && ban.expiresAt > new Date().toISOString());
            
            if (userBan) {
                showBanScreen(userBan);
            }
        }

        // Показать экран бана
        function showBanScreen(banInfo) {
            const banScreen = document.createElement('div');
            banScreen.id = 'banScreen';
            banScreen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            banScreen.innerHTML = `
                <div style="max-width: 400px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">🚫</div>
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">Вы заблокированы</h2>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        <strong>Причина:</strong> ${banInfo.reason}
                    </p>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff6b6b;" id="banTimer">
                            Загрузка...
                        </div>
                        <div style="font-size: 14px; opacity: 0.8;">до разблокировки</div>
                    </div>
                    <p style="font-size: 14px; opacity: 0.7;">
                        Блокировка будет автоматически снята по истечении времени.
                    </p>
                </div>
            `;
            
            document.body.appendChild(banScreen);
            
            // Запускаем таймер
            updateBanTimer(banInfo.expiresAt);
            
            // Блокируем основные функции
            blockUserFunctions();
        }

        // Обновление таймера бана
        function updateBanTimer(expiresAt) {
            const timer = document.getElementById('banTimer');
            if (!timer) return;
            
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const remaining = expiry - now;
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    // Убираем экран бана
                    const banScreen = document.getElementById('banScreen');
                    if (banScreen) {
                        banScreen.remove();
                    }
                    unblockUserFunctions();
                    showNotification('🎉 Блокировка снята! Добро пожаловать обратно!');
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                timer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Блокировка функций для забаненного пользователя
        function blockUserFunctions() {
            // Блокируем кнопки ИИ, погоды и новостей
            const buttons = document.querySelectorAll('.main-ai-card, .function-button');
            buttons.forEach(button => {
                button.style.opacity = '0.3';
                button.style.pointerEvents = 'none';
                button.onclick = () => showNotification('❌ Функция недоступна во время блокировки');
            });
        }

        // Разблокировка функций
        function unblockUserFunctions() {
            const buttons = document.querySelectorAll('.main-ai-card, .function-button');
            buttons.forEach(button => {
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
            });
            
            // Восстанавливаем оригинальные обработчики
            document.querySelector('.main-ai-card[onclick*="openMainAI"]').onclick = openMainAI;
            document.querySelector('.function-button[onclick*="showWeather"]').onclick = showWeather;
            document.querySelector('.function-button[onclick*="showNews"]').onclick = showNews;
        }

        // Функции админ панели
        function openAdminPanel() {
            if (!isAdmin) {
                showNotification('❌ Доступ запрещен');
                return;
            }
            document.getElementById('adminModal').style.display = 'block';
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').style.display = 'none';
        }



        // Все функции управления пользователями удалены
        
        function openAISettings() {
            showNotification('🤖 Настройки ИИ - в разработке');
        }

        function openAppSettings() {
            showNotification('⚙️ Настройки веб-приложения - в разработке');
        }

        // Все функции управления пользователями удалены

        // Инициализация базы данных
        let database = null;
        let responseCache = null;

        async function initializeDatabase() {
            try {
                database = new Database();
                responseCache = new ResponseCache();
                
                // Загружаем кэш из localStorage
                responseCache.loadFromLocalStorage();
                
                console.log('База данных и кэш инициализированы');
            } catch (error) {
                console.error('Ошибка инициализации базы данных:', error);
            }
        }

        function createLoginParticles() {
            const particlesContainer = document.getElementById('loginParticles');
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'login-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Глобальный обработчик для кнопки входа
        function handleEnterApp() {
            console.log('🔘 Кнопка входа нажата');
            try {
                enterApp().catch(error => {
                    console.error('❌ Критическая ошибка в enterApp:', error);
                    alert(`Критическая ошибка: ${error.message}`);
                });
            } catch (error) {
                console.error('❌ Ошибка при вызове enterApp:', error);
                alert(`Ошибка при запуске: ${error.message}`);
            }
        }

        async function enterApp() {
            const enterButton = document.getElementById('enterButton');
            const statusContainer = document.getElementById('statusContainer');
            const databaseStatus = document.getElementById('databaseStatus');
            const appStatus = document.getElementById('appStatus');
            
            console.log('Начинаем процесс входа в приложение...');
            
            // Блокируем кнопку и показываем статус
            enterButton.disabled = true;
            enterButton.style.opacity = '0.6';
            statusContainer.style.display = 'block';
            
            try {
                // Проверка 1: База данных
                await updateStatus(databaseStatus, 'loading', '⏳', 'Проверка базы данных...');
                
                if (!database) {
                    throw new Error('База данных не инициализирована');
                }
                
                // Проверяем подключение к базе данных
                if (!database.supabase) {
                    throw new Error('Нет подключения к Supabase');
                }
                
                // Сохраняем пользователя в базу данных
                if (currentUser) {
                    await database.saveUser(
                        currentUser.id,
                        currentUser.username || '',
                        currentUser.first_name || ''
                    );
                    console.log('Пользователь сохранен в базу данных');
                } else {
                    console.warn('Данные пользователя не найдены, но продолжаем...');
                }
                
                await updateStatus(databaseStatus, 'success', '✅', 'База данных подключена');
                
                // Проверка 2: Веб-приложение
                await updateStatus(appStatus, 'loading', '⏳', 'Проверка веб-приложения...');
                
                // Проверяем основные элементы приложения
                const mainApp = document.getElementById('mainApp');
                if (!mainApp) {
                    throw new Error('Основное приложение не найдено');
                }
                
                // Проверяем наличие ключевых элементов
                const chatModal = document.getElementById('chatModal');
                const userModal = document.getElementById('userModal');
                
                if (!chatModal || !userModal) {
                    throw new Error('Критические элементы интерфейса не найдены');
                }
                
                await updateStatus(appStatus, 'success', '✅', 'Веб-приложение готово');
                
                // Небольшая задержка для показа успешного статуса
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Запускаем основное приложение
                await launchMainApp();
                
            } catch (error) {
                console.error('Ошибка при входе в приложение:', error);
                
                // Показываем ошибку в соответствующем статусе
                if (error.message.includes('база данных') || error.message.includes('Supabase')) {
                    await updateStatus(databaseStatus, 'error', '❌', `Ошибка БД: ${error.message}`);
                } else {
                    await updateStatus(appStatus, 'error', '❌', `Ошибка приложения: ${error.message}`);
                }
                
                // Разблокируем кнопку для повторной попытки
                enterButton.disabled = false;
                enterButton.style.opacity = '1';
            }
        }

        async function updateStatus(statusElement, type, icon, text) {
            const iconElement = statusElement.querySelector('.status-icon');
            const textElement = statusElement.querySelector('.status-text');
            
            // Убираем все классы
            statusElement.className = 'status-item';
            
            // Добавляем нужный класс
            if (type !== 'loading') {
                statusElement.classList.add(type);
            } else {
                statusElement.classList.add('loading');
            }
            
            iconElement.textContent = icon;
            textElement.textContent = text;
            
            // Небольшая задержка для визуального эффекта
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function launchMainApp() {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('Запускаем основное приложение...');
            
            // Анимация исчезновения экрана входа
            loginScreen.style.transition = 'opacity 1s ease, transform 1s ease';
            loginScreen.style.opacity = '0';
            loginScreen.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                loginScreen.style.display = 'none';
                
                // Показываем основное приложение
                mainApp.style.position = 'relative';
                mainApp.style.zIndex = '1';
                mainApp.style.transition = 'opacity 1s ease, transform 1s ease';
                mainApp.style.transform = 'scale(1.1)';
                
                setTimeout(() => {
                    mainApp.style.opacity = '1';
                    mainApp.style.transform = 'scale(1)';
                    
                    // Запускаем анимацию кнопок после появления приложения
                    setTimeout(() => {
                        animateMainAppButtons();
                    }, 500);
                }, 50);
            }, 1000);
        }

        function initializeMainApp() {
            // Создаем частицы
            createParticles();
            
            // Инициализируем настройки
            initializeSettings();
        }

        function animateMainAppButtons() {
            // Анимация кнопок при входе в приложение
            const buttons = document.querySelectorAll('.ai-button');
            buttons.forEach((button, index) => {
                button.style.opacity = '0';
                button.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    button.style.transition = 'all 0.5s ease';
                    button.style.opacity = '1';
                    button.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Начинаем инициализацию приложения...');
            
            try {
                // Инициализируем базу данных
                console.log('📊 Инициализируем базу данных...');
                await initializeDatabase();
                console.log('✅ База данных инициализирована');
                
                // Создаем частицы для экрана входа
                console.log('✨ Создаем частицы...');
                createLoginParticles();
                console.log('✅ Частицы созданы');
                
                // Инициализируем основное приложение в фоне
                console.log('🎯 Инициализируем основное приложение...');
                initializeMainApp();
                console.log('✅ Основное приложение инициализировано');
                
                console.log('🎉 Инициализация завершена успешно!');
                
            } catch (error) {
                console.error('❌ Ошибка инициализации:', error);
            }
        });

        // Функция инициализации настроек
        function initializeSettings() {
            // Инициализируем разрешения если их нет
            const permissions = JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}');
            if (Object.keys(permissions).length === 0) {
                const defaultPermissions = {
                    camera: false,
                    microphone: false,
                    files: true
                };
                localStorage.setItem('ai-tap-permissions', JSON.stringify(defaultPermissions));
                console.log('Инициализированы настройки разрешений по умолчанию');
            }
            
            // Инициализируем звук если не установлен
            if (localStorage.getItem('ai-tap-sound') === null) {
                localStorage.setItem('ai-tap-sound', 'true');
                console.log('Инициализированы настройки звука по умолчанию');
            }
            
            // Инициализация завершена
            
            
            console.log('Настройки инициализированы:', {
                permissions: JSON.parse(localStorage.getItem('ai-tap-permissions') || '{}'),
                sound: localStorage.getItem('ai-tap-sound'),
                locationEnabled: locationEnabled,
                userLocation: userLocation
            });
        }

        // Лишние функции удалены

    </script>
    </div> <!-- Закрытие mainApp -->
</body>
</html>
