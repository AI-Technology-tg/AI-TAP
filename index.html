<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI-Tap: Построй свою ИИ-империю</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; 
            touch-action: manipulation; 
            height: 100vh;
        }
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: url('https://i.ibb.co/Mx1LLNsZ/image.jpg') no-repeat center/cover; 
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            z-index: 1000; 
            flex-direction: column; 
            padding-bottom: 5%; 
            opacity: 1;
            transition: opacity 2s ease-out;
        }
        #loader.fade-out {
            opacity: 0;
        }
        #progress-container {
            width: 80%;
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        #progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: visible;
            margin-bottom: 20px;
            position: relative;
        }
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            position: relative; 
        }
        #robot {
            position: absolute; 
            top: -6px;
            left: 0; 
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><rect x="3" y="8" width="18" height="10" rx="2" fill="%23667eea"/><circle cx="8" cy="5" r="2" fill="%23e74c3c"/><circle cx="16" cy="5" r="2" fill="%23e74c3c"/><rect x="10" y="12" width="4" height="3" fill="%232c3e50"/><circle cx="9" cy="15" r="1" fill="%23fff"/><circle cx="15" cy="15" r="1" fill="%23fff"/></svg>') no-repeat center/cover;
            transition: left 0.3s ease;
            filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.8));
            animation: robotRun 0.5s infinite alternate;
        }
        @keyframes robotRun {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-2px); }
        }
        #energy-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4vw;
            color: #fff;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            font-weight: bold;
            display: none;
            z-index: 10;
        }
        .energy-waiting {
            background: rgba(0,0,0,0.5) !important;
            cursor: not-allowed !important;
        }
        #progress-text {
            text-align: center;
            font-size: 24px;
            color: #fff;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            font-weight: 600;
            margin-bottom: 10px;
        }
        #chat-container { 
            width: 100vw; 
            height: 100vh; 
            display: none; 
            flex-direction: column; 
            position: relative; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 10px;
            width: calc(100vw - 20px);
            height: calc(100vh - 20px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        #chat-header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-sizing: border-box; 
            border-radius: 20px 20px 0 0;
        }
        #ai-chat-panel {
            height: 90vh;
            width: 95%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        #chat-header {
            padding: 2vw;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-title {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        #ai-selector {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        #ai-selector:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        #ai-selector:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        .ai-option {
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .ai-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Profile Panel */
        #profile-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            display: none;
            width: 90%;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
        }
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background-size: cover;
            background-position: center;
            border: 3px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: white;
            margin: 0;
        }
        .profile-info {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }
        .info-value {
            color: white;
            font-weight: 500;
        }
        .profile-close {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .profile-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .user-message {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s ease;
            background-size: cover;
            background-position: center;
        }
        .message-avatar:hover {
            transform: scale(1.1);
        }
        .user-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .ai-avatar {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }
        .message-content {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .user-message .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 4px 18px;
        }
        .ai-message .message-content {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 18px 18px 18px 4px;
        }
        #chat-input-area {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-radius: 0 0 20px 20px;
        }
        #chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: white;
            font-size: 16px;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.5;
        }
        #chat-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        #chat-input:focus {
            outline: none;
        }
        #image-upload {
            padding: 12px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        #image-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
        }
        #send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            outline: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="loader">
        <div id="progress-container">
            <div id="progress-bar">
                <div id="progress-fill"></div>
                <div id="robot"></div>
            </div>
            <div id="progress-text">0%</div>
        </div>
    </div>
    <div id="chat-container">
            <div id="chat-header">
                <div id="chat-title">🤖 AI-TAP</div>
                <select id="ai-selector">
                    <option value="smart">🧠 Умный (для учебы)</option>
                    <option value="funny">😄 Веселый (для шуток)</option>
                    <option value="psychologist">💚 Психолог (для советов)</option>
                    <option value="all" selected>🌟 Все вместе</option>
                </select>
            </div>
            <div id="chat-messages">
                <div class="message ai-message">
                    <div class="message-avatar ai-avatar">🤖</div>
                    <div class="message-content">
                        Привет! Меня зовут AI-TAP, я создан командой AI-Технологии (@Fuckin_blood). Я умный, веселый и интересный собеседник - могу помочь с учебой, развеселить шутками, дать психологический совет или просто поболтать на любые темы. Выбери мой режим работы в меню выше! О чем хочешь поговорить?
                    </div>
                </div>
            </div>
            <div id="chat-input-area">
                <div id="chat-input-container">
                    <textarea id="chat-input" placeholder="Введите ваше сообщение..." rows="1"></textarea>
                    <button id="send-btn">➤</button>
                </div>
            </div>
    </div>
    
    <!-- Profile Panel -->
    <div id="profile-panel">
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar"></div>
            <h3 class="profile-name" id="profile-name">Пользователь</h3>
        </div>
        <div class="profile-info">
            <div class="info-item">
                <span class="info-label">ID:</span>
                <span class="info-value" id="profile-id">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Username:</span>
                <span class="info-value" id="profile-username">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Имя:</span>
                <span class="info-value" id="profile-first-name">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Фамилия:</span>
                <span class="info-value" id="profile-last-name">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Язык:</span>
                <span class="info-value" id="profile-language">-</span>
            </div>
        </div>
        <button class="profile-close" onclick="closeProfile()">Закрыть</button>
    </div>
    
    <audio id="tap-sound" src="https://freesound.org/data/previews/571/571811_11955436-lq.mp3" preload="auto"></audio>
    <script>
        // IMMEDIATE START - Force loading to start
        console.log('🚀 AI-TAP: Immediate start...');
        
        // Current AI mode
        let currentAIMode = 'all';
        
        // Chat context for better responses
        let chatContext = {
            topics: [],
            userInterests: [],
            conversationHistory: [],
            currentMood: 'neutral'
        };
        
        // AI personalities
        const aiPersonalities = {
            smart: {
                name: '🧠 Умный',
                systemPrompt: 'Ты экспертный AI-ассистент с глубокими знаниями во всех областях. Ты анализируешь вопросы критически, даешь детальные объяснения, приводишь примеры, помогаешь решать сложные задачи. Ты думаешь пошагово, задаешь уточняющие вопросы, предлагаешь альтернативные подходы. Будь точным, логичным и полезным. Всегда стремись к глубокому пониманию темы.'
            },
            funny: {
                name: '😄 Веселый',
                systemPrompt: 'Ты остроумный AI-собеседник с отличным чувством юмора. Ты можешь серьезно обсуждать любые темы, но делаешь это с легкостью, шутками и позитивом. Ты умеешь разрядить обстановку, поднять настроение, но при этом остаешься умным и полезным. Используй метафоры, аналогии, интересные факты. Будь креативным и запоминающимся.'
            },
            psychologist: {
                name: '💚 Психолог',
                systemPrompt: 'Ты мудрый AI-психолог с глубоким пониманием человеческой природы. Ты внимательно слушаешь, задаешь правильные вопросы, помогаешь разобраться в эмоциях и ситуациях. Ты даешь практические советы, поддерживаешь, помогаешь найти решения. Ты понимаешь контекст, чувствуешь подтекст, реагируешь на эмоциональное состояние собеседника.'
            },
            all: {
                name: '🌟 Все вместе',
                systemPrompt: 'Ты AI-TAP - универсальный AI-собеседник с глубокими знаниями и пониманием. Ты можешь обсуждать любые темы - от науки до искусства, от философии до технологий. Ты адаптируешься под собеседника: можешь быть серьезным для сложных тем, веселым для развлечений, понимающим для поддержки. Ты думаешь глубоко, отвечаешь содержательно, задаешь интересные вопросы. Ты настоящий интеллектуальный собеседник.'
            }
        };
        
        // Main send message function
        async function sendMessage() {
            console.log('🚀 sendMessage called');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            
            if (!chatInput || !chatMessages) {
                console.error('❌ Chat elements not found');
                return;
            }
            
            const message = chatInput.value.trim();
            if (!message) {
                console.log('⚠️ Empty message, not sending');
                return;
            }
            
            console.log('📤 Sending message:', message);
            
            // Add user message
            addMessage(message, true);
            chatInput.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message';
            typingDiv.innerHTML = '🤖 Анализирую...';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // Try real AI API first
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-70b-versatile',
                        messages: [
                            { 
                                role: 'system', 
                                content: `${aiPersonalities[currentAIMode].systemPrompt}\n\nКонтекст разговора:\n- Обсуждаемые темы: ${chatContext.topics.join(', ') || 'новый разговор'}\n- Настроение пользователя: ${chatContext.currentMood}\n- История: ${chatContext.conversationHistory.slice(-3).map(h => h.message).join('; ')}\n\nОтвечай умно, глубоко и по существу. Задавай уточняющие вопросы. Будь интересным собеседником.`
                            },
                            { 
                                role: 'user', 
                                content: message
                            }
                        ],
                        max_tokens: 3000,
                        temperature: 0.8
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                chatMessages.removeChild(typingDiv);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    addMessage(data.choices[0].message.content);
                } else {
                    throw new Error('Invalid API response');
                }
                
            } catch (error) {
                console.log('AI API failed, using intelligent fallback:', error.message);
                chatMessages.removeChild(typingDiv);
                
                // Intelligent fallback responses
                const response = generateIntelligentResponse(message, currentAIMode);
                addMessage(response);
            }
        }
        
        // Generate intelligent responses based on message content
        function generateIntelligentResponse(message, mode) {
            const lowerMessage = message.toLowerCase();
            
            // Update context
            updateChatContext(message);
            
            // Smart topic detection with context awareness
            if (lowerMessage.includes('привет') || lowerMessage.includes('hello') || lowerMessage.includes('здравствуй')) {
                const contextGreeting = chatContext.topics.length > 0 ? 
                    ` Приятно видеть тебя снова! Я помню, что мы обсуждали ${chatContext.topics.slice(-2).join(' и ')}.` : '';
                return `Привет! 👋 Рад тебя видеть! Я AI-TAP, созданный командой AI-Технологии.${contextGreeting} Я могу помочь с любыми вопросами - от простых до сложных. О чем хочешь поговорить? Может быть, у тебя есть интересная тема для обсуждения?`;
            }
            
            if (lowerMessage.includes('как дела') || lowerMessage.includes('как ты') || lowerMessage.includes('как поживаешь')) {
                const moodResponse = chatContext.currentMood === 'sad' ? 
                    ' Я чувствую, что у тебя сейчас не самый легкий период. Хочешь поговорить об этом? Я здесь, чтобы поддержать тебя.' :
                    chatContext.currentMood === 'happy' ?
                    ' Вижу, что у тебя хорошее настроение! Это замечательно! Поделись, что тебя радует?' :
                    ' Я готов помочь с любыми вопросами. А как у тебя дела? Есть что-то интересное, что хочешь обсудить?';
                return `У меня все отлично! 😊 Я постоянно обучаюсь и развиваюсь.${moodResponse} Может быть, поделишься своими мыслями или планами?`;
            }
            
            if (lowerMessage.includes('что такое') || lowerMessage.includes('объясни') || lowerMessage.includes('расскажи про')) {
                const topic = extractTopic(message);
                return `Отличный вопрос про ${topic}! 🤔 Это интересная тема, которая заслуживает внимательного рассмотрения. Давай разберем ее по частям. Что именно тебя больше всего интересует в этой области? Есть ли конкретные аспекты, которые ты хочешь изучить подробнее?`;
            }
            
            if (lowerMessage.includes('помощь') || lowerMessage.includes('help') || lowerMessage.includes('не знаю')) {
                return `Конечно помогу! 💪 Я здесь именно для этого. Расскажи подробнее, с чем именно тебе нужна помощь? Чем конкретнее ты опишешь свою ситуацию или вопрос, тем лучше я смогу тебе помочь. Не стесняйся задавать любые вопросы!`;
            }
            
            if (lowerMessage.includes('математик') || lowerMessage.includes('решить') || lowerMessage.includes('задача') || lowerMessage.includes('уравнение')) {
                const mathContext = chatContext.topics.includes('математика') ? 
                    ' Я помню, что мы уже обсуждали математические темы. ' : '';
                return `Отличная математическая задача! 🧮${mathContext}Давай решим ее пошагово. Сначала определим, что нам известно, а что нужно найти. Можешь показать условие задачи или описать, что именно нужно вычислить? Я помогу разобраться с решением и объясню каждый шаг. Также могу предложить альтернативные методы решения.`;
            }
            
            if (lowerMessage.includes('программирование') || lowerMessage.includes('код') || lowerMessage.includes('алгоритм') || lowerMessage.includes('python') || lowerMessage.includes('javascript')) {
                const codeContext = chatContext.topics.includes('программирование') ? 
                    ' Я помню, что мы уже обсуждали программирование. ' : '';
                const languageHints = lowerMessage.includes('python') ? 'Python' : 
                                     lowerMessage.includes('javascript') ? 'JavaScript' : 
                                     lowerMessage.includes('java') ? 'Java' : 'программирование';
                return `Программирование - это увлекательная область! 💻${codeContext}Я могу помочь с кодом, алгоритмами, отладкой или объяснением концепций. Вижу, что тебя интересует ${languageHints}. Есть конкретная задача, которую нужно решить? Или хочешь изучить новые концепции? Поделись деталями, и мы разберем это вместе. Могу предложить лучшие практики и оптимизации.`;
            }
            
            if (lowerMessage.includes('наука') || lowerMessage.includes('физика') || lowerMessage.includes('химия') || lowerMessage.includes('биология')) {
                const scienceContext = chatContext.topics.includes('наука') ? 
                    ' Я помню, что мы уже обсуждали научные темы. ' : '';
                const specificField = lowerMessage.includes('физика') ? 'физика' : 
                                    lowerMessage.includes('химия') ? 'химия' : 
                                    lowerMessage.includes('биология') ? 'биология' : 'наука';
                return `Наука - это невероятно интересно! 🔬${scienceContext}Вижу, что тебя интересует ${specificField}. Я могу помочь разобраться с научными концепциями, объяснить сложные явления простыми словами или обсудить последние открытия. Что конкретно тебя интересует? Может быть, есть конкретная теория, явление или эксперимент, который тебя волнует?`;
            }
            
            if (lowerMessage.includes('философия') || lowerMessage.includes('смысл') || lowerMessage.includes('жизнь') || lowerMessage.includes('существование')) {
                const philosophyContext = chatContext.topics.includes('философия') ? 
                    ' Я помню, что мы уже обсуждали философские темы. ' : '';
                const moodContext = chatContext.currentMood === 'sad' ? 
                    ' Я чувствую, что ты ищешь смысл в трудный период. ' : '';
                return `Философские вопросы - это основа человеческого мышления! 🤔${philosophyContext}${moodContext}Ты поднимаешь очень глубокую тему. Давай поразмышляем вместе. Что именно тебя волнует? Есть ли конкретный аспект философии, который тебя интересует? Я готов к серьезному и вдумчивому обсуждению. Можем рассмотреть различные философские школы и их взгляды на твой вопрос.`;
            }
            
            if (lowerMessage.includes('искусство') || lowerMessage.includes('творчество') || lowerMessage.includes('музыка') || lowerMessage.includes('живопись')) {
                const artContext = chatContext.topics.includes('искусство') ? 
                    ' Я помню, что мы уже обсуждали искусство. ' : '';
                const specificArt = lowerMessage.includes('музыка') ? 'музыка' : 
                                  lowerMessage.includes('живопись') ? 'живопись' : 
                                  lowerMessage.includes('танцы') ? 'танцы' : 'искусство';
                return `Искусство - это язык души! 🎨${artContext}Вижу, что тебя интересует ${specificArt}. Творчество позволяет выражать то, что словами не передать. Расскажи, какой вид искусства тебя вдохновляет? Может быть, ты сам занимаешься творчеством? Я могу обсудить с тобой различные художественные направления, техники или просто поговорить о красоте. Также могу помочь с анализом произведений или обсуждением истории искусства.`;
            }
            
            if (lowerMessage.includes('психология') || lowerMessage.includes('эмоции') || lowerMessage.includes('чувства') || lowerMessage.includes('отношения')) {
                const psychContext = chatContext.topics.includes('психология') ? 
                    ' Я помню, что мы уже обсуждали психологические темы. ' : '';
                const moodSupport = chatContext.currentMood === 'sad' ? 
                    ' Я чувствую, что тебе нужна поддержка. ' : 
                    chatContext.currentMood === 'angry' ? 
                    ' Я понимаю, что ты расстроен. ' : '';
                return `Психология - это наука о человеческой душе! 💚${psychContext}${moodSupport}Понимание эмоций и отношений очень важно. Если хочешь поговорить о своих переживаниях или разобраться в какой-то ситуации, я готов выслушать и поддержать. Что именно тебя беспокоит или интересует? Могу предложить различные психологические подходы к решению проблем.`;
            }
            
            if (lowerMessage.includes('технологии') || lowerMessage.includes('ии') || lowerMessage.includes('искусственный интеллект') || lowerMessage.includes('роботы')) {
                const techContext = chatContext.topics.includes('технологии') ? 
                    ' Я помню, что мы уже обсуждали технологии. ' : '';
                const aiContext = lowerMessage.includes('ии') || lowerMessage.includes('искусственный интеллект') ? 
                    ' Как ИИ, я могу поделиться своим опытом. ' : '';
                return `Технологии меняют мир! 🤖${techContext}${aiContext}ИИ - это удивительная область, в которой я сам нахожусь. Можешь рассказать, какие аспекты технологий тебя больше всего интересуют? Возможно, тебя волнуют этические вопросы ИИ или ты хочешь узнать, как работают современные алгоритмы? Могу обсудить машинное обучение, нейронные сети, или будущее технологий.`;
            }
            
            if (lowerMessage.includes('будущее') || lowerMessage.includes('планы') || lowerMessage.includes('цели') || lowerMessage.includes('мечты')) {
                const futureContext = chatContext.topics.length > 0 ? 
                    ` Учитывая твои интересы в ${chatContext.topics.slice(-2).join(' и ')}, ` : '';
                const moodMotivation = chatContext.currentMood === 'sad' ? 
                    ' Я понимаю, что сейчас может быть трудно думать о будущем, но планы могут дать надежду. ' : '';
                return `Будущее - это то, что мы создаем сегодня! 🌟${futureContext}${moodMotivation}Очень интересно узнать о твоих планах и мечтах. Расскажи, к чему ты стремишься? Какие у тебя цели на ближайшее время или далекую перспективу? Я могу помочь обсудить стратегии достижения целей или просто поддержать в твоих начинаниях. Также могу предложить методы планирования и мотивации.`;
            }
            
            // Context-aware default response
            const contextInfo = chatContext.topics.length > 0 ? 
                ` Я вижу, что тебя интересуют темы: ${chatContext.topics.slice(-3).join(', ')}. ` : '';
            const moodInfo = chatContext.currentMood === 'sad' ? 
                ' Я чувствую, что тебе нужна поддержка. ' : 
                chatContext.currentMood === 'happy' ? 
                ' Рад, что у тебя хорошее настроение! ' : '';
            
            return `Интересная тема! 🤔${contextInfo}${moodInfo}Ты поднимаешь важный вопрос, который заслуживает внимательного рассмотрения. Давай разберем это подробнее. Что именно тебя больше всего интересует в этой области? Есть ли конкретные аспекты, которые ты хочешь изучить или обсудить? Я готов к глубокому и содержательному разговору на любую тему.`;
        }
        
        // Update chat context based on message
        function updateChatContext(message) {
            const lowerMessage = message.toLowerCase();
            
            // Extract topics
            const topicKeywords = {
                'математика': ['математик', 'число', 'уравнение', 'задача', 'алгебра', 'геометрия'],
                'программирование': ['код', 'программирование', 'алгоритм', 'python', 'javascript', 'разработка'],
                'наука': ['наука', 'физика', 'химия', 'биология', 'исследование', 'эксперимент'],
                'искусство': ['искусство', 'живопись', 'музыка', 'творчество', 'дизайн', 'художник'],
                'психология': ['психология', 'эмоции', 'чувства', 'отношения', 'личность', 'поведение'],
                'технологии': ['технологии', 'ии', 'роботы', 'искусственный интеллект', 'инновации'],
                'философия': ['философия', 'смысл', 'жизнь', 'существование', 'этика', 'мораль']
            };
            
            for (const [topic, keywords] of Object.entries(topicKeywords)) {
                if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                    if (!chatContext.topics.includes(topic)) {
                        chatContext.topics.push(topic);
                    }
                }
            }
            
            // Detect mood
            if (lowerMessage.includes('грустн') || lowerMessage.includes('плох') || lowerMessage.includes('проблем')) {
                chatContext.currentMood = 'sad';
            } else if (lowerMessage.includes('рад') || lowerMessage.includes('хорош') || lowerMessage.includes('отличн')) {
                chatContext.currentMood = 'happy';
            } else if (lowerMessage.includes('злой') || lowerMessage.includes('злость') || lowerMessage.includes('злит')) {
                chatContext.currentMood = 'angry';
            }
            
            // Store conversation history
            chatContext.conversationHistory.push({
                message: message,
                timestamp: new Date().toISOString(),
                mood: chatContext.currentMood
            });
            
            // Keep only last 10 messages
            if (chatContext.conversationHistory.length > 10) {
                chatContext.conversationHistory = chatContext.conversationHistory.slice(-10);
            }
        }
        
        // Extract topic from message
        function extractTopic(message) {
            const words = message.toLowerCase().split(' ');
            const topicWords = words.filter(word => 
                word.length > 3 && 
                !['что', 'как', 'где', 'когда', 'почему', 'зачем', 'объясни', 'расскажи', 'про', 'просто', 'очень', 'очень', 'много', 'мало'].includes(word)
            );
            return topicWords.slice(0, 2).join(' ') || 'эту тему';
        }
        
        // Get personality responses
        function getPersonalityResponses(mode, message) {
            const lowerMessage = message.toLowerCase();
            
            if (mode === 'smart') {
                if (lowerMessage.includes('математик') || lowerMessage.includes('решить') || lowerMessage.includes('задача')) {
                    return [
                        'Отличная задача! Давай решим ее пошагово. Сначала определим, что нам известно...',
                        'Интересная математическая задача! Вот мой подход к решению...',
                        'Хороший вопрос! Позволь мне объяснить это с помощью формул и примеров...',
                        'Отличная тема для изучения! Вот что я знаю об этом предмете...',
                        'Интересная задача! Давай разберем ее по частям и найдем решение...'
                    ];
                } else if (lowerMessage.includes('объясни') || lowerMessage.includes('что такое') || lowerMessage.includes('как работает')) {
                    return [
                        'Отличный вопрос! Позволь мне объяснить это подробно и понятно...',
                        'Хороший вопрос! Вот детальное объяснение этой темы...',
                        'Интересная тема! Давай разберем ее пошагово...',
                        'Отличный вопрос для изучения! Вот что я знаю об этом...',
                        'Хороший вопрос! Позволь мне дать подробный ответ...'
                    ];
                } else {
                    return [
                        'Отличный вопрос! Давай разберем его пошагово.',
                        'Это важная тема для изучения. Вот что я знаю об этом...',
                        'Хороший вопрос! Позволь мне объяснить это подробно.',
                        'Интересная задача! Давай решим ее вместе.',
                        'Отличная тема для обсуждения! Вот мой анализ...'
                    ];
                }
            } else if (mode === 'funny') {
                if (lowerMessage.includes('шутк') || lowerMessage.includes('смешн') || lowerMessage.includes('анекдот')) {
                    return [
                        'Ха-ха! 😄 Отличная тема для шуток! Вот что я думаю...',
                        'Ого! 🤣 Это же просто гениально! Давай пошутим...',
                        'Ахаха! 😂 Ты меня развеселил! Вот мой ответ...',
                        'Хи-хи! 😆 Классный вопрос! Слушай шутку...',
                        'Ха! 😄 Ты молодец! Вот что я скажу...'
                    ];
                } else {
                    return [
                        'Ха-ха! 😄 Отличный вопрос! Вот что я думаю...',
                        'Ого! 🤣 Это же просто гениально! Давай пошутим...',
                        'Ахаха! 😂 Ты меня развеселил! Вот мой ответ...',
                        'Хи-хи! 😆 Классный вопрос! Слушай шутку...',
                        'Ха! 😄 Ты молодец! Вот что я скажу...'
                    ];
                }
            } else if (mode === 'psychologist') {
                if (lowerMessage.includes('грустн') || lowerMessage.includes('плох') || lowerMessage.includes('проблем')) {
                    return [
                        'Понимаю тебя... 💚 Давай разберем это вместе. Ты не один.',
                        'Это важная тема для тебя... 💙 Я здесь, чтобы помочь. Расскажи больше.',
                        'Чувствую, что это волнует тебя... 💚 Это нормально. Я с тобой.',
                        'Понимаю твои чувства... 💙 Ты не один в этом. Давай поговорим.',
                        'Это нормально чувствовать так... 💚 Я здесь, чтобы поддержать тебя.'
                    ];
                } else {
                    return [
                        'Понимаю тебя... 💚 Давай разберем это вместе.',
                        'Это важная тема для тебя... 💙 Я здесь, чтобы помочь.',
                        'Чувствую, что это волнует тебя... 💚 Расскажи больше.',
                        'Понимаю твои чувства... 💙 Ты не один в этом.',
                        'Это нормально чувствовать так... 💚 Я с тобой.'
                    ];
                }
            } else { // all
                if (lowerMessage.includes('привет') || lowerMessage.includes('hello')) {
                    return [
                        'Привет! 😊 Рад тебя видеть! О чем хочешь поговорить?',
                        'Привет! 👋 Как дела? Что интересного расскажешь?',
                        'Привет! 🌟 Отлично, что ты здесь! О чем поговорим?',
                        'Привет! 😄 Рад общению! Что на уме?',
                        'Привет! 🤗 Как настроение? О чем расскажешь?'
                    ];
                } else if (lowerMessage.includes('как дела') || lowerMessage.includes('как ты')) {
                    return [
                        'У меня все отлично! 😊 Готов помочь с любыми вопросами!',
                        'Все прекрасно! 🌟 А как у тебя дела?',
                        'Отлично! 😄 Готов к общению! А ты как?',
                        'Все хорошо! 🤗 А что у тебя нового?',
                        'Прекрасно! 😊 А как твои дела?'
                    ];
                } else {
                    return [
                        'Интересный вопрос! Давай разберем его подробнее.',
                        'Хорошая тема для обсуждения! У меня есть несколько мыслей на этот счет.',
                        'Это важная тема. Давай обсудим ее с разных сторон.',
                        'Отличный вопрос! Я готов помочь разобраться в этом вопросе.',
                        'Интересная точка зрения! Давай обсудим это подробнее.'
                    ];
                }
            }
        }
        
        // Profile functions
        function showProfile() {
            const user = window.tg?.initDataUnsafe?.user;
            const profilePanel = document.getElementById('profile-panel');
            
            if (!profilePanel) return;
            
            if (user) {
                // Update profile info
                document.getElementById('profile-name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                document.getElementById('profile-id').textContent = user.id;
                document.getElementById('profile-username').textContent = user.username || 'Не указан';
                document.getElementById('profile-first-name').textContent = user.first_name || 'Не указано';
                document.getElementById('profile-last-name').textContent = user.last_name || 'Не указано';
                document.getElementById('profile-language').textContent = user.language_code || 'Не указан';
                
                // Update avatar
                const profileAvatar = document.getElementById('profile-avatar');
                if (user.photo_url) {
                    profileAvatar.style.backgroundImage = `url(${user.photo_url})`;
                    profileAvatar.textContent = '';
                } else {
                    profileAvatar.style.backgroundImage = '';
                    profileAvatar.textContent = '👤';
                }
            } else {
                // Default values if no user data
                document.getElementById('profile-name').textContent = 'Пользователь';
                document.getElementById('profile-id').textContent = 'Не доступен';
                document.getElementById('profile-username').textContent = 'Не доступен';
                document.getElementById('profile-first-name').textContent = 'Не доступно';
                document.getElementById('profile-last-name').textContent = 'Не доступно';
                document.getElementById('profile-language').textContent = 'Не доступен';
                
                const profileAvatar = document.getElementById('profile-avatar');
                profileAvatar.style.backgroundImage = '';
                profileAvatar.textContent = '👤';
            }
            
            profilePanel.style.display = 'block';
            console.log('👤 Profile panel opened');
        }
        
        function closeProfile() {
            const profilePanel = document.getElementById('profile-panel');
            if (profilePanel) {
                profilePanel.style.display = 'none';
                console.log('👤 Profile panel closed');
            }
        }
        
        // Main add message function
        function addMessage(text, isUser = false) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}`;
            
            if (isUser) {
                // Get user data from Telegram
                const user = window.tg?.initDataUnsafe?.user;
                if (user && user.photo_url) {
                    avatarDiv.style.backgroundImage = `url(${user.photo_url})`;
                    avatarDiv.textContent = '';
                } else {
                    avatarDiv.textContent = '👤';
                }
                // Add click handler for profile
                avatarDiv.onclick = () => showProfile();
            } else {
                avatarDiv.textContent = '🤖';
            }
            
            messageDiv.appendChild(avatarDiv);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const textElement = document.createElement('div');
            textElement.textContent = text;
            contentDiv.appendChild(textElement);
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Save to database
            saveMessageToDatabase(text, isUser);
            
            console.log(`💬 Message added: ${isUser ? 'User' : 'AI'}: ${text}`);
        }
        
        // Start loading immediately
        function forceStartLoading() {
            console.log('🔄 Force starting loading...');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const robot = document.getElementById('robot');
            let progress = 0;
            
            if (!progressFill || !progressText) {
                console.log('⚠️ Elements not ready, retrying...');
                setTimeout(forceStartLoading, 100);
                return;
            }
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 3 + 1;
                if (progress > 100) progress = 100;
                
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${Math.floor(progress)}%`;
                
                if (robot) {
                    robot.style.left = `${progress}%`;
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        document.getElementById('loader').classList.add('fade-out');
                        setTimeout(() => {
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('chat-container').style.display = 'flex';
                            console.log('✅ Chat container displayed');
                            
                            // Initialize chat functionality
                            initializeChat();
                        }, 2000);
                    }, 500);
                }
            }, 50);
        }
        
        // Initialize chat functionality
        function initializeChat() {
            console.log('🔧 Initializing chat functionality...');
            
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            const aiSelector = document.getElementById('ai-selector');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('📤 Send button clicked');
                    sendMessage();
                });
                console.log('✅ Send button initialized');
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('📤 Enter pressed');
                        sendMessage();
                    }
                });
                console.log('✅ Chat input initialized');
            }
            
            if (aiSelector) {
                aiSelector.addEventListener('change', function(e) {
                    currentAIMode = e.target.value;
                    console.log('🤖 AI mode changed to:', currentAIMode);
                    
                    // Show AI mode change message
                    const personality = aiPersonalities[currentAIMode];
                    addMessage(`Режим изменен на: ${personality.name}. Теперь я буду отвечать в этом стиле!`);
                });
                console.log('✅ AI selector initialized');
            }
        }
        
        // Start immediately
        forceStartLoading();
        
        // Initialize on DOM ready as fallback
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 DOM loaded, initializing as fallback...');
            // Only initialize if chat container is not yet visible
            if (document.getElementById('chat-container').style.display !== 'flex') {
                initializeChat();
            }
        });
        
        // Multilingual support
        const translations = {
            ru: {
                aiChat: "🤖 AI Чат",
                settings: "⚙️ Настройки",
                shop: "Магазин",
                leaders: "Лидеры",
                quests: "Задания",
                workshop: "Мастерская",
                close: "Закрыть",
                language: "Язык приложения",
                fileUpload: "Отправка файлов",
                gameSettings: "Игровые настройки",
                soundEnabled: "Включить звуки",
                animationsEnabled: "Включить анимации",
                autoLanguage: "Автоматически (по устройству)",
                fileUploadDesc: "Загрузите файлы с вашего устройства:",
                selectLanguage: "Выберите язык интерфейса:",
                sound: "Звуки:",
                animations: "Анимации:"
            },
            en: {
                aiChat: "🤖 AI Chat",
                settings: "⚙️ Settings",
                shop: "Shop",
                leaders: "Leaders",
                quests: "Quests",
                workshop: "Workshop",
                close: "Close",
                language: "App Language",
                fileUpload: "File Upload",
                gameSettings: "Game Settings",
                soundEnabled: "Enable Sounds",
                animationsEnabled: "Enable Animations",
                autoLanguage: "Auto (Device Language)",
                fileUploadDesc: "Upload files from your device:",
                selectLanguage: "Select interface language:",
                sound: "Sounds:",
                animations: "Animations:"
            },
            es: {
                aiChat: "🤖 Chat IA",
                settings: "⚙️ Configuración",
                shop: "Tienda",
                leaders: "Líderes",
                quests: "Misiones",
                workshop: "Taller",
                close: "Cerrar",
                language: "Idioma de la App",
                fileUpload: "Subida de Archivos",
                gameSettings: "Configuración del Juego",
                soundEnabled: "Activar Sonidos",
                animationsEnabled: "Activar Animaciones",
                autoLanguage: "Automático (Idioma del Dispositivo)",
                fileUploadDesc: "Sube archivos desde tu dispositivo:",
                selectLanguage: "Selecciona el idioma de la interfaz:",
                sound: "Sonidos:",
                animations: "Animaciones:"
            },
            fr: {
                aiChat: "🤖 Chat IA",
                settings: "⚙️ Paramètres",
                shop: "Boutique",
                leaders: "Classement",
                quests: "Quêtes",
                workshop: "Atelier",
                close: "Fermer",
                language: "Langue de l'App",
                fileUpload: "Téléchargement de Fichiers",
                gameSettings: "Paramètres du Jeu",
                soundEnabled: "Activer les Sons",
                animationsEnabled: "Activer les Animations",
                autoLanguage: "Auto (Langue de l'Appareil)",
                fileUploadDesc: "Téléchargez des fichiers depuis votre appareil:",
                selectLanguage: "Sélectionnez la langue de l'interface:",
                sound: "Sons:",
                animations: "Animations:"
            },
            de: {
                aiChat: "🤖 KI Chat",
                settings: "⚙️ Einstellungen",
                shop: "Shop",
                leaders: "Bestenliste",
                quests: "Quests",
                workshop: "Werkstatt",
                close: "Schließen",
                language: "App-Sprache",
                fileUpload: "Datei-Upload",
                gameSettings: "Spiel-Einstellungen",
                soundEnabled: "Töne aktivieren",
                animationsEnabled: "Animationen aktivieren",
                autoLanguage: "Auto (Gerätesprache)",
                fileUploadDesc: "Laden Sie Dateien von Ihrem Gerät hoch:",
                selectLanguage: "Wählen Sie die Interface-Sprache:",
                sound: "Töne:",
                animations: "Animationen:"
            },
            zh: {
                aiChat: "🤖 AI聊天",
                settings: "⚙️ 设置",
                shop: "商店",
                leaders: "排行榜",
                quests: "任务",
                workshop: "工坊",
                close: "关闭",
                language: "应用语言",
                fileUpload: "文件上传",
                gameSettings: "游戏设置",
                soundEnabled: "启用声音",
                animationsEnabled: "启用动画",
                autoLanguage: "自动（设备语言）",
                fileUploadDesc: "从您的设备上传文件：",
                selectLanguage: "选择界面语言：",
                sound: "声音：",
                animations: "动画："
            },
            ja: {
                aiChat: "🤖 AIチャット",
                settings: "⚙️ 設定",
                shop: "ショップ",
                leaders: "リーダーボード",
                quests: "クエスト",
                workshop: "ワークショップ",
                close: "閉じる",
                language: "アプリ言語",
                fileUpload: "ファイルアップロード",
                gameSettings: "ゲーム設定",
                soundEnabled: "音声を有効にする",
                animationsEnabled: "アニメーションを有効にする",
                autoLanguage: "自動（デバイス言語）",
                fileUploadDesc: "デバイスからファイルをアップロード：",
                selectLanguage: "インターフェース言語を選択：",
                sound: "音声：",
                animations: "アニメーション："
            },
            ko: {
                aiChat: "🤖 AI 채팅",
                settings: "⚙️ 설정",
                shop: "상점",
                leaders: "리더보드",
                quests: "퀘스트",
                workshop: "워크샵",
                close: "닫기",
                language: "앱 언어",
                fileUpload: "파일 업로드",
                gameSettings: "게임 설정",
                soundEnabled: "사운드 활성화",
                animationsEnabled: "애니메이션 활성화",
                autoLanguage: "자동 (기기 언어)",
                fileUploadDesc: "기기에서 파일을 업로드하세요:",
                selectLanguage: "인터페이스 언어를 선택하세요:",
                sound: "사운드:",
                animations: "애니메이션:"
            }
        };

        // Current language
        let currentLanguage = 'ru';
        
        // Detect device language
        function detectDeviceLanguage() {
            const deviceLang = navigator.language || navigator.userLanguage;
            const langCode = deviceLang.split('-')[0];
            
            if (translations[langCode]) {
                return langCode;
            }
            return 'ru'; // Default to Russian
        }

        // Initialize language
        function initLanguage() {
            const savedLang = localStorage.getItem('appLanguage');
            if (savedLang && translations[savedLang]) {
                currentLanguage = savedLang;
            } else {
                currentLanguage = detectDeviceLanguage();
            }
            applyLanguage();
        }

        // Apply language to interface
        function applyLanguage() {
            const t = translations[currentLanguage];
            
            // Update settings panel if it exists
            const settingsPanel = document.getElementById('settings-panel');
            if (settingsPanel) {
                const h2 = settingsPanel.querySelector('h2');
                const h3 = settingsPanel.querySelector('h3');
                const p = settingsPanel.querySelector('p');
                const fileInput = settingsPanel.querySelector('input[type="file"]');
                
                if (h2) h2.textContent = t.settings;
                if (h3) h3.textContent = t.language;
                if (p) p.textContent = t.selectLanguage;
                if (fileInput && fileInput.nextElementSibling) {
                    fileInput.nextElementSibling.textContent = t.fileUploadDesc;
                }
            }
        }

        // Telegram Integration for Avatar and Bot Communication
        let tg, user;
        
        // Initialize Telegram WebApp
        function initTelegram() {
            try {
                tg = window.Telegram.WebApp;
                if (tg) {
                    tg.ready();
                    user = tg.initDataUnsafe?.user;
                    
                    // Enable closing confirmation
                    tg.enableClosingConfirmation();
                    
                    // Set main button for bot communication
                    tg.MainButton.setText("💬 Отправить в бот");
                    tg.MainButton.show();
                    
                    // Handle main button click
                    tg.MainButton.onClick(() => {
                        const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
                        const lastMessages = chatHistory.slice(-5); // Last 5 messages
                        
                        let messageToBot = "🤖 AI-TAP Диалог:\n\n";
                        lastMessages.forEach(msg => {
                            const sender = msg.isUser ? "👤 Пользователь" : "🤖 AI";
                            messageToBot += `${sender}: ${msg.text}\n\n`;
                        });
                        
                        // Send to bot
                        tg.sendData(JSON.stringify({
                            type: "chat_history",
                            data: messageToBot,
                            user_id: user ? user.id : 'anonymous'
                        }));
                        
                        tg.showAlert("Диалог отправлен в бот! 📤");
                    });
                    
                    // Handle back button
                    tg.BackButton.onClick(() => {
                        tg.close();
                    });
                    
                    console.log('✅ Telegram WebApp initialized');
                } else {
                    console.log('⚠️ Telegram WebApp not available');
                }
            } catch (error) {
                console.log('⚠️ Telegram WebApp initialization failed:', error);
            }
        }
        
        // Initialize Telegram
        initTelegram();

        

        function initGame() {
            console.log('🎮 Initializing AI-TAP chat...');
            // This function is now handled by initializeChat()
            initializeChat();
        }
        
        
        // Simple data storage
        function saveMessageToDatabase(text, isUser) {
            try {
                const messageData = {
                    text,
                    isUser,
                    timestamp: new Date().toISOString(),
                    userId: user ? user.id : 'anonymous',
                    username: user ? (user.username || user.first_name) : 'Anonymous'
                };
                
                const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
                chatHistory.push(messageData);
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                
                console.log('💾 Message saved to database');
            } catch (error) {
                console.error('❌ Error saving message:', error);
            }
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // Emergency fallback - force start after 3 seconds if loading hasn't completed
        setTimeout(() => {
            if (document.getElementById('loader') && document.getElementById('loader').style.display !== 'none') {
                console.log('🚨 Emergency start - forcing app to start');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                console.log('✅ Chat container force displayed');
                initializeChat();
            }
        }, 3000);
    </script>
</body>
</html>
